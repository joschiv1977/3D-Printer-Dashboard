<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1f2e">
    <title>Admin-Passwort einrichten - 3D Drucker Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/static/font-awesome.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%);
            color: #e8eaed;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            padding-left: calc(20px + var(--safe-area-inset-left));
            padding-right: calc(20px + var(--safe-area-inset-right));
        }

        .container {
            max-width: 500px;
            width: 100%;
            background: #1a1f2e;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .content {
            padding: 30px 20px;
        }

        .info-box {
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 25px;
        }

        .info-box h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #2196f3;
        }

        .info-box p {
            font-size: 14px;
            color: #9ca3af;
            line-height: 1.6;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #9ca3af;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: #0f1419;
            border: 1px solid #2d3748;
            border-radius: 8px;
            color: #e8eaed;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2196f3;
            background: #1a1f2e;
        }

        .form-input::placeholder {
            color: #6b7280;
        }

        /* Password Strength Indicator */
        .password-strength {
            margin-top: 8px;
            height: 4px;
            background: #2d3748;
            border-radius: 2px;
            overflow: hidden;
            display: none;
        }

        .password-strength.show {
            display: block;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            background: #f44336;
            transition: all 0.3s;
        }

        .password-strength-bar.weak {
            width: 33%;
            background: #f44336;
        }

        .password-strength-bar.medium {
            width: 66%;
            background: #ff9800;
        }

        .password-strength-bar.strong {
            width: 100%;
            background: #4caf50;
        }

        .password-hints {
            margin-top: 10px;
            font-size: 12px;
            color: #6b7280;
        }

        .password-hints ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .password-hints li {
            margin: 4px 0;
        }

        .password-hints li.valid {
            color: #4caf50;
        }

        .password-hints li.invalid {
            color: #f44336;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Alert Messages */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
            border: 1px solid #4caf50;
        }

        .alert-error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 1px solid #f44336;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 20px;
            }

            .content {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Admin-Passwort einrichten</h1>
            <p>Richten Sie ein sicheres Passwort f√ºr den Admin-Zugang ein</p>
        </div>

        <div class="content">
            <!-- Alert Messages -->
            <div id="alert" class="alert"></div>

            <!-- Info Box -->
            <div class="info-box">
                <h3>‚úì Lizenz erfolgreich aktiviert</h3>
                <p>Ihre Lizenz wurde erfolgreich aktiviert. Bitte richten Sie jetzt ein sicheres Admin-Passwort ein, um fortzufahren.</p>
            </div>

            <!-- Password Setup Form -->
            <form id="passwordForm" onsubmit="setPassword(event)">
                <div class="form-group">
                    <label class="form-label">Neues Admin-Passwort</label>
                    <input
                        type="password"
                        id="password"
                        name="password"
                        class="form-input"
                        placeholder="Mindestens 12 Zeichen"
                        required
                        minlength="12"
                        oninput="checkPasswordStrength()"
                    >
                    <div class="password-strength" id="passwordStrength">
                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                    </div>
                    <div class="password-hints">
                        <strong>Passwort-Anforderungen:</strong>
                        <ul id="passwordRequirements">
                            <li id="req-length" class="invalid">‚úó Mindestens 12 Zeichen</li>
                            <li id="req-uppercase" class="invalid">‚úó Mindestens ein Gro√übuchstabe</li>
                            <li id="req-lowercase" class="invalid">‚úó Mindestens ein Kleinbuchstabe</li>
                            <li id="req-number" class="invalid">‚úó Mindestens eine Zahl</li>
                            <li id="req-special" class="invalid">‚úó Mindestens ein Sonderzeichen (!@#$%^&*...)</li>
                        </ul>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Passwort best√§tigen</label>
                    <input
                        type="password"
                        id="confirmPassword"
                        name="confirm_password"
                        class="form-input"
                        placeholder="Passwort erneut eingeben"
                        required
                        minlength="12"
                    >
                </div>

                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    Passwort einrichten und weiter
                </button>
            </form>
        </div>
    </div>

    <script>
        // Password strength checker
        function checkPasswordStrength() {
            const password = document.getElementById('password').value;
            const strengthBar = document.getElementById('passwordStrengthBar');
            const strengthContainer = document.getElementById('passwordStrength');
            const submitBtn = document.getElementById('submitBtn');

            // Show strength indicator
            if (password.length > 0) {
                strengthContainer.classList.add('show');
            } else {
                strengthContainer.classList.remove('show');
            }

            // Check requirements
            const requirements = {
                length: password.length >= 12,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /[0-9]/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            // Update requirement indicators
            document.getElementById('req-length').className = requirements.length ? 'valid' : 'invalid';
            document.getElementById('req-length').textContent = requirements.length ? '‚úì Mindestens 12 Zeichen' : '‚úó Mindestens 12 Zeichen';

            document.getElementById('req-uppercase').className = requirements.uppercase ? 'valid' : 'invalid';
            document.getElementById('req-uppercase').textContent = requirements.uppercase ? '‚úì Mindestens ein Gro√übuchstabe' : '‚úó Mindestens ein Gro√übuchstabe';

            document.getElementById('req-lowercase').className = requirements.lowercase ? 'valid' : 'invalid';
            document.getElementById('req-lowercase').textContent = requirements.lowercase ? '‚úì Mindestens ein Kleinbuchstabe' : '‚úó Mindestens ein Kleinbuchstabe';

            document.getElementById('req-number').className = requirements.number ? 'valid' : 'invalid';
            document.getElementById('req-number').textContent = requirements.number ? '‚úì Mindestens eine Zahl' : '‚úó Mindestens eine Zahl';

            document.getElementById('req-special').className = requirements.special ? 'valid' : 'invalid';
            document.getElementById('req-special').textContent = requirements.special ? '‚úì Mindestens ein Sonderzeichen' : '‚úó Mindestens ein Sonderzeichen';

            // Calculate strength
            const validCount = Object.values(requirements).filter(v => v).length;
            const allValid = validCount === 5;

            // Update strength bar
            if (validCount <= 2) {
                strengthBar.className = 'password-strength-bar weak';
            } else if (validCount <= 4) {
                strengthBar.className = 'password-strength-bar medium';
            } else {
                strengthBar.className = 'password-strength-bar strong';
            }

            // Enable submit button only if all requirements are met
            submitBtn.disabled = !allValid;
        }

        // Set Password
        async function setPassword(event) {
            event.preventDefault();

            const btn = document.getElementById('submitBtn');
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Check if passwords match
            if (password !== confirmPassword) {
                showAlert('Passw√∂rter stimmen nicht √ºberein!', 'error');
                return;
            }

            // Disable button and show loading
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Wird eingerichtet...';

            try {
                const response = await fetch('/api/setup/first-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ password: password })
                });

                const data = await response.json();

                if (data.success) {
                    // Save CSRF token
                    localStorage.setItem('csrf_token', data.csrf_token);

                    showAlert('Passwort erfolgreich eingerichtet! Sie werden weitergeleitet...', 'success');

                    // Redirect to setup page after 1.5 seconds
                    setTimeout(() => {
                        window.location.href = '/setup';
                    }, 1500);
                } else {
                    showAlert(data.error || 'Fehler beim Einrichten des Passworts', 'error');
                    btn.disabled = false;
                    btn.innerHTML = 'Passwort einrichten und weiter';
                }
            } catch (error) {
                console.error('Password setup error:', error);
                showAlert('Netzwerkfehler: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = 'Passwort einrichten und weiter';
            }
        }

        // Show Alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;

            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
