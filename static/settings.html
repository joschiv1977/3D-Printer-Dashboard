<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title id="page-title">Settings - 3D Printer Dashboard</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="3D Drucker">

    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512x512.png">

    <!-- Theme Colors -->
    <meta name="theme-color" content="#667eea" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1a1f2e" media="(prefers-color-scheme: dark)">

    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        /* CSS Variablen f√ºr Themes */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-section: #f9f9f9;
            --bg-sidebar: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-sidebar: #333333;
            --border-color: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
            --info-bg: #e8f4ff;
            --input-bg: #ffffff;
            --input-border: #ddd;
            --accent-blue: #667eea;
            --accent-green: #4caf50;
            --accent-red: #dc3545;
            --accent-orange: #ff9800;
            --sidebar-active: #667eea;
        }

        body.dark-mode {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f2e;
            --bg-card: #1a1f2e;
            --bg-section: #252b3b;
            --bg-sidebar: #151922;
            --text-primary: #e8eaed;
            --text-secondary: #b8bcc8;
            --text-sidebar: #e8eaed;
            --border-color: #2c3340;
            --shadow: rgba(0,0,0,0.3);
            --info-bg: #1a2633;
            --input-bg: #1a1f2e;
            --input-border: #3a4151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* Admin Layout */
        .admin-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            color: var(--text-sidebar);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: 2px 0 10px var(--shadow);
            z-index: 1000;
            transition: transform 0.3s ease;
            /* Hide scrollbar for cleaner UI */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .sidebar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .sidebar-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: white;
        }

        .sidebar-menu {
            padding: 10px 0;
            flex: 1;
        }

        .sidebar-item {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            border-left: 3px solid transparent;
            font-size: 14px;
        }

        .sidebar-item:hover {
            background: rgba(0,0,0,0.05);
        }

        body.dark-mode .sidebar-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .sidebar-item.active {
            background: rgba(102, 126, 234, 0.15);
            border-left-color: var(--sidebar-active);
            font-weight: 600;
        }

        .sidebar-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        /* Sidebar Category Header */
        .sidebar-category {
            padding: 16px 20px 8px 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            margin-top: 8px;
        }

        body.dark-mode .sidebar-category {
            color: rgba(255, 255, 255, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sidebar-category:first-child {
            margin-top: 0;
            border-top: none;
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 2000;
            background: var(--accent-blue);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 20px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .content-header h1 {
            font-size: 24px;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            /* Hide scrollbar for cleaner UI */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        /* Content-Body breiter machen wenn Token-Section aktiv */
        .content-body:has(#section-tokens.active) {
            max-width: 900px;
        }

        .content-body:has(#section-overview.active) {
            max-width: 1200px;
        }
        .content-body::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Settings Sections */
        .settings-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .settings-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card Styling */
        .card {
            background: var(--bg-section);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            margin-bottom: 20px;
        }

        /* Overview Items */
        .overview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .overview-item:last-child {
            border-bottom: none;
        }

        .overview-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .overview-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .overview-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .overview-status.enabled {
            background: #d4edda;
            color: #155724;
        }

        body.dark-mode .overview-status.enabled {
            background: #1e4620;
            color: #4caf50;
        }

        .overview-status.disabled {
            background: #f8d7da;
            color: #721c24;
        }

        body.dark-mode .overview-status.disabled {
            background: #3d1e1f;
            color: #dc3545;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Switch Row */
        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .switch-row:last-child {
            border-bottom: none;
        }

        .switch-row label {
            color: var(--text-primary);
            font-size: 14px;
            margin: 0;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
            display: inline-block;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-green);
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Custom Dropdown for Printer Model */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-selected {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dropdown-selected:hover {
            border-color: var(--accent-blue);
            background: var(--bg-section);
        }

        .custom-dropdown.open .dropdown-selected {
            border-color: var(--accent-blue);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .printer-option {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .printer-icon {
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            border-radius: 6px;
            flex-shrink: 0;
        }

        .printer-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .printer-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .printer-specs {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .dropdown-arrow {
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
            margin-left: 8px;
        }

        .custom-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--input-bg);
            border: 1px solid var(--accent-blue);
            border-top: none;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .custom-dropdown.open .dropdown-options {
            max-height: 400px;
            opacity: 1;
            overflow-y: auto;
            /* Hide scrollbar for cleaner UI */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .dropdown-options::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        .dropdown-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: var(--bg-section);
        }

        .dropdown-option.selected {
            background: rgba(59, 130, 246, 0.1);
        }

        .dropdown-option .checkmark {
            margin-left: auto;
            color: var(--accent-blue);
            font-weight: bold;
            font-size: 18px;
        }

        /* Scrollable container without scrollbar */
        .scrollable-no-scrollbar {
            overflow-y: auto;
            /* Hide scrollbar for cleaner UI */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }

        .scrollable-no-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }

        /* Printer Swipe Card Gallery */
        .printer-gallery-container {
            width: 100%;
            margin: 20px 0;
        }

        .printer-gallery-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: block;
        }

        .printer-gallery-wrapper {
            position: relative;
            overflow: hidden;
            padding: 10px 0;
        }

        .printer-gallery {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 0 8px;
            cursor: grab;
            user-select: none;
        }

        .printer-gallery:active {
            cursor: grabbing;
        }

        .printer-gallery::-webkit-scrollbar {
            display: none;
        }

        .printer-card {
            min-width: 180px;
            max-width: 180px;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            flex-shrink: 0;
        }

        .printer-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-color: var(--accent-blue);
        }

        .printer-card.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.08);
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
        }

        .printer-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: var(--accent-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }

        .printer-card-image {
            width: 100%;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 12px;
        }

        .printer-card-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: var(--img-filter, none);
        }

        body.dark-mode .printer-card-image img {
            --img-filter: brightness(0.9);
        }

        .printer-card-title {
            font-weight: 700;
            font-size: 15px;
            color: var(--text-primary);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .printer-card-specs {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .printer-card-features {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .printer-feature-badge {
            font-size: 10px;
            padding: 3px 8px;
            background: var(--bg-section);
            color: var(--text-secondary);
            border-radius: 10px;
            font-weight: 600;
        }

        .printer-card.selected .printer-feature-badge {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        /* Gallery navigation dots */
        .printer-gallery-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
        }

        .gallery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--input-border);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-dot.active {
            background: var(--accent-blue);
            width: 24px;
            border-radius: 4px;
        }

        /* Swipe hint */
        .swipe-hint {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .swipe-hint::before,
        .swipe-hint::after {
            content: '‚Üê‚Üí';
            font-size: 14px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            background: var(--accent-blue);
            color: white;
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-success {
            background: var(--accent-green);
        }

        .btn-danger {
            background: var(--accent-red);
        }

        .btn-warning {
            background: var(--accent-orange);
        }

        /* Info Box */
        .info-box {
            background: var(--info-bg);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            color: var(--text-secondary);
            border-left: 4px solid var(--accent-blue);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            min-width: 300px;
            max-width: 500px;
            display: none;
            animation: slideInRight 0.3s ease-out;
            font-weight: 500;
        }

        .toast.show {
            display: block;
        }

        .toast-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .toast-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        body.dark-mode .toast-success {
            background: #1a3622;
            color: #4caf50;
            border-left: 4px solid #4caf50;
        }

        body.dark-mode .toast-error {
            background: #3a1a1a;
            color: #f44336;
            border-left: 4px solid #f44336;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease-in;
        }

        /* Loading Spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Floating Save Button */
        .fab-save {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--accent-green);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8) translateY(100px);
            pointer-events: none;
        }

        .fab-save.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: all;
        }

        .fab-save.has-changes {
            animation: pulse 2s infinite;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6);
        }

        .fab-save:hover:not(:disabled) {
            transform: scale(1.1) translateY(0);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        .fab-save:active:not(:disabled) {
            transform: scale(0.95) translateY(0);
        }

        .fab-save:disabled {
            background: #ccc;
            cursor: not-allowed;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(76, 175, 80, 0.6);
            }
            50% {
                box-shadow: 0 4px 30px rgba(76, 175, 80, 0.9);
            }
        }

        .fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent-red);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid var(--bg-primary);
        }

        /* PWA Standalone Mode - Force Safe Areas */
        @media (display-mode: standalone) {
            html {
                overflow: auto;
            }

            body {
                padding-top: env(safe-area-inset-top, 0px);
                padding-left: env(safe-area-inset-left, 0px);
                padding-right: env(safe-area-inset-right, 0px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            .sidebar-header {
                padding-top: max(20px, env(safe-area-inset-top, 0px));
                padding-left: max(20px, env(safe-area-inset-left, 0px));
                padding-right: max(20px, env(safe-area-inset-right, 0px));
            }

            .content-header {
                padding-top: max(20px, env(safe-area-inset-top, 0px));
                padding-left: max(30px, env(safe-area-inset-left, 0px));
                padding-right: max(30px, env(safe-area-inset-right, 0px));
            }

            .menu-toggle {
                top: max(15px, calc(15px + env(safe-area-inset-top, 0px)));
                left: max(15px, calc(15px + env(safe-area-inset-left, 0px)));
            }
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                height: auto;
                max-height: 100vh;
                transform: translateX(-100%);
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .sidebar-menu {
                padding-bottom: calc(20px + var(--safe-area-inset-bottom));
            }

            .menu-toggle {
                display: block;
            }

            .sidebar-header {
                padding: 24px 15px 6px 15px; /* Oben 24px, unten 6px */
            }

            .sidebar-header h2 {
                padding-left: 55px;
                font-size: 18px;
                flex: 1;
                min-width: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .sidebar-header h2 .menu-toggle {
                display: none; /* Versteckt den inneren Button */
                flex-shrink: 0;
            }

            .main-content {
                width: 100%;
            }

            .content-body {
                padding: 20px 15px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .toast {
                left: 10px;
                right: 10px;
                top: 10px;
                min-width: unset;
                max-width: unset;
            }

            .fab-save {
                bottom: 20px;
                right: 16px;
                width: 56px;
                height: 56px;
                font-size: 24px;
            }

            @keyframes slideInRight {
                from {
                    transform: translateY(-100px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }

            @keyframes slideOutRight {
                from {
                    transform: translateY(0);
                    opacity: 1;
                }
                to {
                    transform: translateY(-100px);
                    opacity: 0;
                }
            }
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
        }

        .back-btn {
            background: rgba(0,0,0,0.1);
            color: var(--text-primary);
            border: 1px solid rgba(0,0,0,0.15);
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            display: inline-block;
        }

        .back-btn:hover {
            background: rgba(0,0,0,0.15);
        }

        body.dark-mode .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        body.dark-mode .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Section Title */
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-blue);
            color: var(--text-primary);
        }

        /* Token Management Styles */
        .token-count {
            font-size: 14px;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: normal;
        }

        .token-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 768px) {
            .token-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .token-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s ease;
        }

        .token-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .token-icon {
            font-size: 32px;
            margin-right: 12px;
        }

        .token-info {
            flex: 1;
        }

        .token-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .token-value {
            font-size: 13px;
            color: var(--text-primary);
            word-break: break-all;
            font-family: monospace;
            margin-bottom: 8px;
        }

        .token-details {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .token-detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .token-detail-label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .token-detail-value {
            color: var(--text-primary);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .loading {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        .platform-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .platform-ios {
            background: rgba(0, 122, 255, 0.2);
            color: #007aff;
        }

        .platform-android {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        body.dark-mode .platform-ios {
            background: rgba(0, 122, 255, 0.3);
            color: #64b5f6;
        }

        body.dark-mode .platform-android {
            background: rgba(76, 175, 80, 0.3);
            color: #81c784;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-idle {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
        }

        .status-inactive {
            background: rgba(158, 158, 158, 0.2);
            color: #9e9e9e;
        }

        .status-orphaned {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        body.dark-mode .status-active {
            background: rgba(76, 175, 80, 0.3);
            color: #81c784;
        }

        body.dark-mode .status-idle {
            background: rgba(255, 152, 0, 0.3);
            color: #ffb74d;
        }

        body.dark-mode .status-inactive {
            background: rgba(158, 158, 158, 0.3);
            color: #bdbdbd;
        }

        body.dark-mode .status-orphaned {
            background: rgba(244, 67, 54, 0.3);
            color: #e57373;
        }

        .token-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-blue);
        }

        .token-section-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Apply dark mode immediately to prevent white flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>
    <!-- Mobile Menu Toggle -->
    <button class="menu-toggle" onclick="toggleMobileMenu()" onmouseenter="openSidebarOnHover()">‚ò∞</button>

    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                  <h2 id="sidebar-title" style="display: flex; align-items: center; gap: 15px;">
                      <button class="menu-toggle" onclick="toggleMobileMenu()" style="margin: 0; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white;">‚ò∞</button>
                      Settings
                  </h2>
            </div>
            <div class="sidebar-menu">
                <div class="sidebar-item" onclick="window.location.href='/'">
                    <span class="sidebar-icon">üè†</span>
                    <span>Dashboard</span>
                </div>
                <!-- Basis -->
                <div class="sidebar-category">üìã Basis</div>
                <div class="sidebar-item active" onclick="switchSection('overview')">
                    <span class="sidebar-icon">üìä</span>
                    <span>Overview</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('license')">
                    <span class="sidebar-icon">üîê</span>
                    <span>License</span>
                </div>

                <!-- Drucker & Hardware -->
                <div class="sidebar-category">üñ®Ô∏è Drucker & Hardware</div>
                <div class="sidebar-item" onclick="switchSection('mqtt')">
                    <span class="sidebar-icon">üì°</span>
                    <span>MQTT/Printer</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('camera')">
                    <span class="sidebar-icon">üì∑</span>
                    <span>Camera</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('print-defaults')">
                    <span class="sidebar-icon">üñ®Ô∏è</span>
                    <span>Print Defaults</span>
                </div>

                <!-- Filament Management -->
                <div class="sidebar-category">üßµ Filament Management</div>
                <div class="sidebar-item" onclick="switchSection('filament')">
                    <span class="sidebar-icon">üßµ</span>
                    <span>Filament Management</span>
                </div>

                <!-- Automatisierung & Smart Home -->
                <div class="sidebar-category">ü§ñ Automatisierung</div>
                <div class="sidebar-item" onclick="switchSection('automation')">
                    <span class="sidebar-icon">ü§ñ</span>
                    <span>Automation</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('homeassistant')">
                    <span class="sidebar-icon">üè†</span>
                    <span>Home Assistant</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('meross')">
                    <span class="sidebar-icon">üîå</span>
                    <span>Meross</span>
                </div>

                <!-- Sicherheit & Zugang -->
                <div class="sidebar-category">üîí Sicherheit</div>
                <div class="sidebar-item" onclick="switchSection('security')">
                    <span class="sidebar-icon">üîí</span>
                    <span>Security & SSH</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('tokens')">
                    <span class="sidebar-icon">üîë</span>
                    <span>Token Management</span>
                </div>

                <!-- System & UI -->
                <div class="sidebar-category">‚öôÔ∏è System & UI</div>
                <div class="sidebar-item" onclick="switchSection('costs')">
                    <span class="sidebar-icon">üí∞</span>
                    <span>Costs</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('ui')">
                    <span class="sidebar-icon">üé®</span>
                    <span>UI Preferences</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('debug')">
                    <span class="sidebar-icon">üêõ</span>
                    <span>Debug Tools</span>
                </div>
                <div class="sidebar-item" onclick="switchSection('health')">
                    <span class="sidebar-icon">ü©∫</span>
                    <span>System Health</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="content-header">
                <h1 id="content-title">üìä Overview</h1>
            </div>

            <div class="content-body">
                <!-- Overview Section -->
                <div class="settings-section active" id="section-overview">
                    <div class="section-title">System Overview</div>

                    <!-- Printer Info Card -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>üñ®Ô∏è</span> Printer Information
                        </h3>
                        <div style="display: grid; gap: 12px;">
                            <div class="overview-item">
                                <span class="overview-label">Printer Name:</span>
                                <span class="overview-value" id="overview-printer-name">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Model:</span>
                                <span class="overview-value" id="overview-printer-model">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">IP Address:</span>
                                <span class="overview-value" id="overview-printer-ip">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Serial:</span>
                                <span class="overview-value" id="overview-printer-serial">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Integration Status Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <!-- Home Assistant Card -->
                        <div class="card">
                            <h3 style="margin: 0 0 12px 0; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                                <span>üè†</span> Home Assistant
                            </h3>
                            <div class="overview-item">
                                <span class="overview-label">Status:</span>
                                <span class="overview-status" id="overview-ha-status">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">URL:</span>
                                <span class="overview-value" id="overview-ha-url" style="font-size: 12px; word-break: break-all;">-</span>
                            </div>
                        </div>

                        <!-- Meross Card -->
                        <div class="card">
                            <h3 style="margin: 0 0 12px 0; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                                <span>üîå</span> Meross
                            </h3>
                            <div class="overview-item">
                                <span class="overview-label">Status:</span>
                                <span class="overview-status" id="overview-meross-status">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Device:</span>
                                <span class="overview-value" id="overview-meross-device">-</span>
                            </div>
                        </div>

                        <!-- Spoolman Card -->
                        <div class="card">
                            <h3 style="margin: 0 0 12px 0; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                                <span>üßµ</span> Spoolman
                            </h3>
                            <div class="overview-item">
                                <span class="overview-label">Status:</span>
                                <span class="overview-status" id="overview-spoolman-status">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">URL:</span>
                                <span class="overview-value" id="overview-spoolman-url" style="font-size: 12px; word-break: break-all;">-</span>
                            </div>
                        </div>

                        <!-- Filament Drying Card -->
                        <div class="card">
                            <h3 style="margin: 0 0 12px 0; font-size: 15px; display: flex; align-items: center; gap: 8px;">
                                <span>üî•</span> Filament Drying
                            </h3>
                            <div class="overview-item">
                                <span class="overview-label">Status:</span>
                                <span class="overview-status" id="overview-drying-status">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Materials:</span>
                                <span class="overview-value" id="overview-drying-materials">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Settings Card -->
                    <div class="card">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>‚öôÔ∏è</span> Additional Settings
                        </h3>
                        <div style="display: grid; gap: 12px;">
                            <div class="overview-item">
                                <span class="overview-label">CORS Origins:</span>
                                <span class="overview-value" id="overview-cors-count">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">SSH User:</span>
                                <span class="overview-value" id="overview-ssh-user">-</span>
                            </div>
                            <div class="overview-item">
                                <span class="overview-label">Camera Size:</span>
                                <span class="overview-value" id="overview-camera-size">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- License Section -->
                <div class="settings-section" id="section-license">
                    <div class="section-title" id="card-license-title">License Management</div>
                    <div class="info-box">
                        ‚ÑπÔ∏è Your license information and activation status
                    </div>

                    <div class="card">
                        <!-- License Status Badge -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span id="license-status-label" style="font-size: 13px; color: var(--text-secondary);">Status:</span>
                                <span id="license-status-badge" style="padding: 6px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                    <span class="loading" style="width: 14px; height: 14px;"></span>
                                </span>
                            </div>
                        </div>

                        <!-- License Details -->
                        <div id="license-details" style="display: none;">
                            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                                <!-- License Type -->
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="license-type-label">License Type</div>
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" id="license-type-value">-</div>
                                </div>

                                <!-- Customer Name -->
                                <div style="margin-bottom: 12px;" id="license-customer-container">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="license-customer-label">Customer</div>
                                    <div style="font-size: 14px; color: var(--text-primary);" id="license-customer-value">-</div>
                                </div>

                                <!-- Expiration -->
                                <div id="license-expiration-container">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="license-expiration-label">Expires</div>
                                    <div style="font-size: 14px; color: var(--text-primary);" id="license-expiration-value">-</div>
                                </div>

                                <!-- Activated On -->
                                <div style="margin-top: 12px;" id="license-activated-container">
                                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;" id="license-activated-label">Activated On</div>
                                    <div style="font-size: 14px; color: var(--text-secondary);" id="license-activated-value">-</div>
                                </div>
                            </div>

                            <!-- Hardware ID -->
                            <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--border-color);">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;" id="license-hwid-label">Hardware ID</div>
                                <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                    <input type="text" id="license-hwid-value" readonly
                                           style="flex: 1; min-width: 0; padding: 8px; font-family: monospace; font-size: 11px; background: var(--input-bg);
                                                  color: var(--text-primary); border: 1px solid var(--input-border); border-radius: 4px; box-sizing: border-box;">
                                    <button onclick="copyHardwareId()" class="btn" style="width: auto; padding: 8px 16px; white-space: nowrap; flex-shrink: 0;" id="btn-copy-hwid">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>

                            <!-- Deactivate Button -->
                            <button class="btn btn-danger" onclick="deactivateLicense()" id="btn-deactivate-license" style="width: 100%;">
                                üîì Deactivate License
                            </button>
                        </div>

                        <!-- No License / Activate -->
                        <div id="license-no-license" style="display: none;">
                            <div style="background: var(--info-bg); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-orange);">
                                <p id="license-no-license-text" style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                                    No valid license found. Please activate a license to use the application.
                                </p>
                            </div>
                            <a href="/license/activate" style="text-decoration: none;">
                                <button class="btn btn-success" id="btn-activate-license" style="width: 100%;">
                                    üîê Activate License
                                </button>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- MQTT Section -->
                <div class="settings-section" id="section-mqtt">
                    <div class="section-title" id="card-mqtt-title">MQTT / Bambu Printer</div>

                    <div class="card">
                        <div class="form-group">
                            <label for="printer_name" id="label-printer-name">Printer Name</label>
                            <input type="text" id="printer_name" placeholder="Speed-Knuffel">
                        </div>
                        <div class="form-group">
                            <div class="printer-gallery-container">
                                <label class="printer-gallery-label" id="label-printer-model">Printer Model</label>
                                <div class="printer-gallery-wrapper">
                                    <div class="printer-gallery" id="printer-gallery">
                                        <!-- P1P -->
                                        <div class="printer-card" data-value="P1P">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/p1p.png" alt="Bambu Lab P1P">
                                            </div>
                                            <div class="printer-card-title">Bambu Lab P1P</div>
                                            <div class="printer-card-specs">256√ó256√ó256mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Offen</span>
                                                <span class="printer-feature-badge">Schnell</span>
                                            </div>
                                        </div>

                                        <!-- P1S -->
                                        <div class="printer-card selected" data-value="P1S">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/p1s.png" alt="Bambu Lab P1S">
                                            </div>
                                            <div class="printer-card-title">Bambu Lab P1S</div>
                                            <div class="printer-card-specs">256√ó256√ó256mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Geschlossen</span>
                                                <span class="printer-feature-badge">Leise</span>
                                            </div>
                                        </div>

                                        <!-- P2S -->
                                        <div class="printer-card" data-value="P2S">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/p2s.png" alt="Bambu Lab P2S">
                                            </div>
                                            <div class="printer-card-title">Bambu Lab P2S</div>
                                            <div class="printer-card-specs">256√ó256√ó256mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Kamera</span>
                                                <span class="printer-feature-badge">AMS</span>
                                            </div>
                                        </div>

                                        <!-- X1C -->
                                        <div class="printer-card" data-value="X1C">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/x1c.png" alt="Bambu Lab X1 Carbon">
                                            </div>
                                            <div class="printer-card-title">X1 Carbon</div>
                                            <div class="printer-card-specs">256√ó256√ó256mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Kamera</span>
                                                <span class="printer-feature-badge">Premium</span>
                                            </div>
                                        </div>

                                        <!-- X1E -->
                                        <div class="printer-card" data-value="X1E">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/x1e.png" alt="Bambu Lab X1E">
                                            </div>
                                            <div class="printer-card-title">X1 Engineering</div>
                                            <div class="printer-card-specs">256√ó256√ó256mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Geh√§rtet</span>
                                                <span class="printer-feature-badge">Pro</span>
                                            </div>
                                        </div>

                                        <!-- H2S -->
                                        <div class="printer-card" data-value="H2S">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/h2s.png" alt="Bambu Lab H2S">
                                            </div>
                                            <div class="printer-card-title">Bambu Lab H2S</div>
                                            <div class="printer-card-specs">340√ó320√ó340mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">High-Temp</span>
                                                <span class="printer-feature-badge">65¬∞C</span>
                                            </div>
                                        </div>

                                        <!-- A1 -->
                                        <div class="printer-card" data-value="A1">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/A1.png" alt="Bambu Lab A1">
                                            </div>
                                            <div class="printer-card-title">Bambu Lab A1</div>
                                            <div class="printer-card-specs">256√ó256√ó256mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Kamera</span>
                                                <span class="printer-feature-badge">Kompakt</span>
                                            </div>
                                        </div>

                                        <!-- A1 Mini -->
                                        <div class="printer-card" data-value="A1_MINI">
                                            <div class="printer-card-image">
                                                <img src="/static/images/printers/a1_mini.png" alt="Bambu Lab A1 Mini">
                                            </div>
                                            <div class="printer-card-title">A1 Mini</div>
                                            <div class="printer-card-specs">180√ó180√ó180mm</div>
                                            <div class="printer-card-features">
                                                <span class="printer-feature-badge">Klein</span>
                                                <span class="printer-feature-badge">Starter</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="swipe-hint">Wischen zum Ausw√§hlen</div>
                            </div>
                            <input type="hidden" id="printer_model" value="P1S">
                        </div>
                        <div class="form-group">
                            <label for="bambu_ip" id="label-bambu-ip">Bambu IP</label>
                            <input type="text" id="bambu_ip" placeholder="192.168.178.100">
                        </div>
                        <div class="form-group">
                            <label for="bambu_serial" id="label-bambu-serial">Serial Number</label>
                            <input type="text" id="bambu_serial" placeholder="01S00A123456789">
                        </div>
                        <div class="form-group">
                            <label for="bambu_access_code" id="label-bambu-access-code">Access Code</label>
                            <input type="password" id="bambu_access_code" placeholder="12345678">
                        </div>

                        <!-- Maintenance Notifications -->
                        <div class="card" style="margin-top: 20px;">
                            <h3 id="label-maintenance-notifications" style="margin-bottom: 15px; color: var(--text-primary); font-size: 16px;">üîî Wartungsmeldungen</h3>

                            <div class="switch-row">
                                <label id="label-maintenance-enable">Wartungsmeldungen aktivieren</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="maintenance_notifications_enabled">
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="form-group">
                                <label for="maintenance_notification_frequency" id="label-maintenance-frequency">Benachrichtigungsfrequenz</label>
                                <select id="maintenance_notification_frequency" style="width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 5px; background: var(--input-bg); color: var(--text-primary); font-size: 14px;">
                                    <option value="3">Alle 3 Stunden</option>
                                    <option value="6" selected>Alle 6 Stunden</option>
                                    <option value="12">Alle 12 Stunden</option>
                                    <option value="24">Einmal t√§glich</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="maintenance_notification_start_hour" id="label-maintenance-start-hour">Startzeit (Stunde)</label>
                                <select id="maintenance_notification_start_hour" style="width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 5px; background: var(--input-bg); color: var(--text-primary); font-size: 14px;">
                                    <option value="0" selected>00:00 (Mitternacht)</option>
                                    <option value="6">06:00 (Morgens)</option>
                                    <option value="7">07:00</option>
                                    <option value="8">08:00</option>
                                    <option value="9">09:00</option>
                                    <option value="10">10:00</option>
                                    <option value="12">12:00 (Mittag)</option>
                                    <option value="14">14:00</option>
                                    <option value="16">16:00</option>
                                    <option value="18">18:00 (Abends)</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                </select>
                            </div>

                            <div class="info-box" style="background: var(--info-bg); padding: 12px; border-radius: 5px; margin-top: 15px; font-size: 13px; color: var(--text-secondary);">
                                <p id="maintenance-notification-info" style="margin: 0;">‚ÑπÔ∏è Benachrichtigungen werden basierend auf der gew√§hlten Frequenz und Startzeit gesendet. Beispiel: Bei "Alle 6 Stunden" ab 00:00 ‚Üí 00:00, 06:00, 12:00, 18:00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Automation Section -->
                <div class="settings-section" id="section-automation">
                    <div class="section-title" id="card-automation-title">Automation</div>

                    <div class="card">
                        <!-- Auto Power Off -->
                        <div class="switch-row">
                            <label id="label-auto-power-enable">Enable Auto Power Off</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto_power_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label for="power_off_delay" id="label-power-delay">After Print (Minutes)</label>
                                <input type="number" id="power_off_delay" placeholder="15" min="1">
                            </div>
                            <div class="form-group">
                                <label for="power_off_idle" id="label-power-idle">On Idle (Minutes)</label>
                                <input type="number" id="power_off_idle" placeholder="60" min="1">
                            </div>
                        </div>

                        <!-- Auto Light -->
                        <div class="switch-row">
                            <label id="label-auto-light-mqtt">Auto Light via MQTT</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto_light_mqtt">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="switch-row">
                            <label id="label-only-dark-hours">Only during dark hours</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto_light_only_dark">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="settings-grid" id="dark-hours-container">
                            <div class="form-group">
                                <label for="dark_start_hour" id="label-dark-start">Dark starts (Hour)</label>
                                <input type="number" id="dark_start_hour" placeholder="22" min="0" max="23">
                            </div>
                            <div class="form-group">
                                <label for="dark_end_hour" id="label-dark-end">Dark ends (Hour)</label>
                                <input type="number" id="dark_end_hour" placeholder="7" min="0" max="23">
                            </div>
                        </div>

                        <!-- Hardware Button -->
                        <div class="switch-row">
                            <label id="label-hardware-button-enable">Enable Hardware Button</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="hardware_button_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Camera Section -->
                <div class="settings-section" id="section-camera">
                    <div class="section-title" id="card-camera-title">uStreamer Camera</div>

                    <div class="card">
                        <div class="switch-row">
                            <label id="label-camera-enable">Enable Camera</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="camera_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="camera_ip" id="label-camera-ip">Pi IP Address</label>
                            <input type="text" id="camera_ip" placeholder="192.168.178.50">
                        </div>
                        <div class="form-group">
                            <label for="camera_port" id="label-camera-port">Port</label>
                            <input type="number" id="camera_port" placeholder="8080">
                        </div>
                        <div class="form-group">
                            <label for="camera_username" id="label-camera-username">Username</label>
                            <input type="text" id="camera_username" placeholder="admin">
                        </div>
                        <div class="form-group">
                            <label for="camera_password" id="label-camera-password">Password</label>
                            <input type="password" id="camera_password" placeholder="Password">
                        </div>
                    </div>

                    <!-- Bambu Camera Status -->
                    <div class="card" style="margin-top: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);" id="label-bambu-camera-title">
                        </h3>

                        <!-- Status Display -->
                        <div id="bambu-camera-status" style="margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: 150px 1fr; gap: 10px; font-size: 14px;">
                                <div style="color: var(--text-secondary);" id="label-bambu-status"></div>
                                <div id="bambu-status-message" style="color: var(--text-primary); font-weight: 500;"></div>

                                <div style="color: var(--text-secondary);" id="label-bambu-frame-count"></div>
                                <div id="bambu-frame-count" style="color: var(--text-primary);">-</div>

                                <div style="color: var(--text-secondary);">FPS:</div>
                                <div id="bambu-fps" style="color: var(--text-primary);">-</div>

                                <div style="color: var(--text-secondary);" id="label-bambu-last-frame"></div>
                                <div id="bambu-last-frame" style="color: var(--text-primary);">-</div>

                                <div style="color: var(--text-secondary);" id="label-bambu-thread"></div>
                                <div id="bambu-thread-status" style="color: var(--text-primary);">-</div>
                            </div>
                        </div>

                        <!-- Restart Button -->
                        <button id="bambu-restart-btn" class="btn" onclick="restartBambuCamera()" style="width: 100%;">
                            <span id="label-bambu-restart-btn"></span>
                        </button>
                        <div id="bambu-restart-message" style="margin-top: 10px; font-size: 14px; text-align: center;"></div>
                    </div>
                </div>

                <!-- Costs Section -->
                <div class="settings-section" id="section-costs">
                    <div class="section-title" id="card-costs-title">Costs</div>

                    <div class="card">
                        <div class="form-group">
                            <label for="filament_cost" id="label-filament-cost">Filament Cost (‚Ç¨/kg)</label>
                            <input type="number" id="filament_cost" placeholder="21.00" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="power_cost" id="label-power-cost">Power Cost (‚Ç¨/kWh)</label>
                            <input type="number" id="power_cost" placeholder="0.285" step="0.001" min="0">
                        </div>
                    </div>
                </div>

                <!-- Print Defaults Section -->
                <div class="settings-section" id="section-print-defaults">
                    <div class="section-title" id="card-print-defaults-title">Print Defaults</div>

                    <div class="card">
                        <div class="switch-row">
                            <label id="label-timelapse">üìπ Timelapse</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="print_timelapse">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="switch-row">
                            <label id="label-use-ams">üé® Use AMS</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="print_use_ams">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="switch-row">
                            <label id="label-bed-leveling">üìè Bed Leveling</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="print_bed_leveling">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="switch-row">
                            <label id="label-layer-inspect">üëÅÔ∏è Layer Inspect</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="print_layer_inspect">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="switch-row">
                            <label id="label-flow-cali">üåä Flow Calibration</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="print_flow_cali">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="switch-row">
                            <label id="label-vibration-cali">üì≥ Vibration Calibration</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="print_vibration_cali">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Filament Management Section -->
                <div class="settings-section" id="section-filament">
                    <div class="section-title">üßµ Filament Management</div>

                    <div class="info-box">
                        üßµ Manage your filament tracking with Spoolman and configure drying settings
                    </div>

                    <!-- Spoolman Integration -->
                    <div class="card">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);" id="card-spoolman-title">
                            üì¶ Spoolman Integration
                        </h3>
                        <div class="switch-row">
                            <label id="label-spoolman-enable">Enable Spoolman</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="spoolman_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="spoolman_url" id="label-spoolman-url">API URL (Internal)</label>
                            <input type="text" id="spoolman_url" placeholder="http://192.168.178.x:7912">
                        </div>
                        <div class="form-group">
                            <label for="spoolman_external_url" id="label-spoolman-external">External URL (Browser)</label>
                            <input type="text" id="spoolman_external_url" placeholder="https://spoolman.example.com">
                        </div>
                        <div class="form-group">
                            <label for="spoolman_threshold" id="label-spoolman-threshold">Low Threshold (g)</label>
                            <input type="number" id="spoolman_threshold" placeholder="200" min="0">
                        </div>
                        <div class="switch-row">
                            <label id="label-spoolman-auto-track">Auto Tracking</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="spoolman_auto_track">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Filament Drying -->
                    <div class="card">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);" id="card-filament-drying-title">
                            üå°Ô∏è Filament Drying
                        </h3>
                        <div class="switch-row">
                            <label id="label-filament-drying-enable">Enable Filament Drying</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="filament_drying_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <!-- Parking Position -->
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="label-parking-position">Parking Position</label>
                            <div class="settings-grid">
                                <div class="form-group">
                                    <label for="parking_x" id="label-parking-x">X Position</label>
                                    <input type="number" id="parking_x" placeholder="255" min="0" max="300">
                                </div>
                                <div class="form-group">
                                    <label for="parking_y" id="label-parking-y">Y Position</label>
                                    <input type="number" id="parking_y" placeholder="250" min="0" max="300">
                                </div>
                                <div class="form-group">
                                    <label for="parking_z" id="label-parking-z">Z Position</label>
                                    <input type="number" id="parking_z" placeholder="200" min="0" max="300">
                                </div>
                            </div>
                        </div>
                        <!-- Material Settings -->
                        <div style="margin-top: 15px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600;" id="label-material-settings">Material Settings</label>
                            <div class="scrollable-no-scrollbar" style="background: var(--bg-section); padding: 15px; border-radius: 8px; max-height: 400px;">
                                <div id="filament-materials-list">
                                    <!-- Material items werden hier dynamisch eingef√ºgt -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Home Assistant Section -->
                <div class="settings-section" id="section-homeassistant">
                    <div class="section-title" id="card-ha-title">Home Assistant</div>

                    <div class="card">
                        <div class="switch-row">
                            <label id="label-ha-enable">Enable Home Assistant</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="ha_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="ha_url" id="label-ha-url">Home Assistant URL</label>
                            <input type="text" id="ha_url" placeholder="http://homeassistant.local:8123">
                        </div>
                        <div class="form-group">
                            <label for="ha_token" id="label-ha-token">Long-Lived Access Token</label>
                            <input type="password" id="ha_token" placeholder="Token">
                        </div>
                        <button class="btn" onclick="testHomeAssistant()" id="btn-test-ha" style="margin-top: 10px;">
                            üß™ Test Home Assistant
                        </button>
                    </div>
                </div>

                <!-- Meross Section -->
                <div class="settings-section" id="section-meross">
                    <div class="section-title" id="card-meross-title">Meross Smart Plug</div>

                    <div class="card">
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 15px;" id="meross-desc">
                            Direct control without Home Assistant
                        </p>
                        <div class="switch-row">
                            <label id="label-meross-enable">Enable Meross</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="meross_enabled">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="meross_email" id="label-meross-email">Meross Account Email</label>
                            <input type="email" id="meross_email" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="meross_password" id="label-meross-password">Meross Account Password</label>
                            <input type="password" id="meross_password" placeholder="Password">
                        </div>
                        <div class="form-group">
                            <label for="meross_device" id="label-meross-device">Device Name (Optional)</label>
                            <input type="text" id="meross_device" placeholder="Drucker">
                            <small style="color: var(--text-secondary); font-size: 11px;" id="meross-device-hint">Leave empty to use first device</small>
                        </div>
                        <div class="form-group">
                            <label for="meross_region" id="label-meross-region">API Region</label>
                            <select id="meross_region" style="background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--input-border); padding: 10px; border-radius: 8px; width: 100%;">
                                <option value="eu">üá™üá∫ Europe (EU)</option>
                                <option value="us">üá∫üá∏ United States (US)</option>
                                <option value="ap">üåè Asia-Pacific (AP)</option>
                            </select>
                            <small style="color: var(--text-secondary); font-size: 11px;" id="meross-region-hint">Must match your account region</small>
                        </div>
                        <div class="form-group">
                            <label for="power_control_mode" id="label-power-mode">Power Control Mode</label>
                            <select id="power_control_mode" style="background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--input-border); padding: 10px; border-radius: 8px; width: 100%;">
                                <option value="homeassistant">Home Assistant</option>
                                <option value="meross">Meross</option>
                            </select>
                            <small style="color: var(--text-secondary); font-size: 11px;" id="power-mode-hint">Choose your power control method</small>
                        </div>
                    </div>
                </div>

                <!-- Security & SSH Section -->
                <div class="settings-section" id="section-security">
                    <div class="section-title" id="card-security-title">Security & SSH</div>

                    <div class="info-box">
                        üîí Configure CORS origins, Redis authentication and SSH remote control
                    </div>

                    <!-- CORS & Redis -->
                    <div class="card">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);">
                            üõ°Ô∏è CORS & Redis Security
                        </h3>
                        <!-- CORS Origins -->
                        <div style="margin-bottom: 20px;">
                            <label id="label-cors-origins" style="display: block; margin-bottom: 8px; font-weight: 600;">CORS Allowed Origins</label>
                            <div style="background: var(--info-bg); padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; color: var(--text-secondary);">
                                ‚ÑπÔ∏è <span id="info-cors">Define which domains can access the API. Leave empty for auto-detection (local networks only).</span>
                            </div>
                            <div id="cors-origins-list" style="margin-bottom: 10px;">
                                <!-- CORS origins werden hier dynamisch eingef√ºgt -->
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="new-cors-origin" placeholder="https://your-domain.com:5555" style="flex: 1;">
                                <button class="btn" onclick="addCorsOrigin()" id="btn-add-cors" style="width: auto;">+ Add</button>
                            </div>
                        </div>

                        <!-- Redis Password -->
                        <div class="switch-row">
                            <label id="label-redis-auth">Enable Redis Auth</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="redis_auth_enabled" onchange="toggleRedisPassword()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group" id="redis-password-group" style="display: none;">
                            <label for="redis_password" id="label-redis-password">Redis Password</label>
                            <input type="password" id="redis_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;" id="info-redis">
                                ‚ö†Ô∏è <span id="info-redis-restart">Requires server restart to take effect</span>
                            </div>
                        </div>
                    </div>

                    <!-- SSH Remote Control -->
                    <div class="card">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: var(--text-primary);" id="card-ssh-title">
                            üîê SSH Remote Control
                        </h3>
                        <div style="background: var(--info-bg); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px; color: var(--text-secondary);">
                            ‚ÑπÔ∏è <span id="info-ssh">For server restart via iOS app and remote commands</span>
                        </div>
                        <div class="form-group">
                            <label for="ssh_user" id="label-ssh-user">SSH User</label>
                            <input type="text" id="ssh_user" placeholder="pi">
                        </div>
                        <div class="form-group">
                            <label for="ssh_password" id="label-ssh-password">SSH Password</label>
                            <input type="password" id="ssh_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                </div>

                <!-- UI Preferences Section -->
                <div class="settings-section" id="section-ui">
                    <div class="section-title" id="card-ui-title">UI Preferences</div>

                    <div class="card">
                        <div class="form-group">
                            <label id="label-theme">Theme</label>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 10px;">
                                W√§hle zwischen Auto (System), Dark Mode oder Light Mode.
                            </p>
                            <button onclick="window.themeManager.toggleTheme()" class="btn" style="background: var(--accent-blue); width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <span id="theme-icon-settings">üåì</span>
                                <span id="theme-label-settings">Theme wechseln</span>
                            </button>
                        </div>

                        <div class="form-group">
                            <label id="label-camera-size">Default Camera Size</label>
                            <select id="default_camera_size" style="width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 5px; background: var(--input-bg); color: var(--text-primary);">
                                <option value="1" id="option-camera-small">Small (1x)</option>
                                <option value="2" id="option-camera-medium">Medium (2x)</option>
                                <option value="3" id="option-camera-large">Large (3x)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label id="label-dashboard-reset">Dashboard Layout</label>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 10px;">
                                Setze das Dashboard-Layout auf die Standardeinstellungen zur√ºck.
                            </p>
                            <button onclick="resetDashboardLayoutFromSettings()" class="btn" style="background: var(--accent-orange); width: 100%;">
                                üîÑ Dashboard-Layout zur√ºcksetzen
                            </button>
                        </div>

                        <div class="form-group">
                            <label id="label-card-visibility">Dashboard Cards</label>
                            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 15px;">
                                W√§hle welche Cards auf dem Dashboard angezeigt werden sollen.
                            </p>

                            <div class="toggle-row" style="margin-bottom: 10px;">
                                <span>üìπ Kamera</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="card_camera_visible" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="toggle-row" style="margin-bottom: 10px;">
                                <span>üìä Druck-Fortschritt</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="card_progress_visible" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="toggle-row" style="margin-bottom: 10px;">
                                <span>üßµ Spoolman</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="card_spoolman_visible" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="toggle-row" style="margin-bottom: 10px;">
                                <span>üî• Filament-Trocknung</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="card_drying_visible" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token Management Section -->
                <div class="settings-section" id="section-tokens">
                    <div class="section-title" id="card-token-management-title">Token Management</div>

                    <!-- Info Box -->
                    <div class="info-box" id="token-info-box" style="background: var(--info-bg); border-left: 4px solid var(--accent-blue); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
                        <strong>‚ÑπÔ∏è Token-Verwaltung</strong><br>
                        Hier kannst du alle registrierten Tokens f√ºr FCM-Benachrichtigungen, Live Activities und registrierte Ger√§te verwalten und bei Bedarf entfernen.
                    </div>

                    <!-- Refresh Button -->
                    <div style="text-align: right; margin-bottom: 20px;">
                        <button class="btn" onclick="loadAllTokens()" id="btn-refresh-tokens" style="background: var(--accent-green);">
                            üîÑ Aktualisieren
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div class="loading-container" id="tokens-loading-state">
                        <div class="loading"></div>
                        <p style="margin-top: 20px; color: var(--text-secondary);">Lade Token-Daten...</p>
                    </div>

                    <!-- Device Tokens Section -->
                    <div class="card" id="device-tokens-section" style="display: none;">
                        <div class="token-section-header">
                            <h3 class="token-section-title" id="section-devices-title">
                                üì± Registrierte Ger√§te
                            </h3>
                            <span class="token-count" id="device-token-count">0</span>
                        </div>
                        <div class="token-cards" id="device-tokens-list"></div>
                    </div>

                    <!-- Web Sessions Section -->
                    <div class="card" id="web-sessions-section" style="display: none;">
                        <div class="token-section-header">
                            <h3 class="token-section-title" id="section-sessions-title">
                                üåê Web-Sessions (Browser)
                            </h3>
                            <span class="token-count" id="web-sessions-count">0</span>
                        </div>
                        <div style="margin-bottom: 15px; font-size: 12px; color: var(--text-secondary);">
                            <strong>Status:</strong>
                            <span class="status-badge status-active" id="legend-status-active">Active</span> <span id="legend-status-active-desc">Mit g√ºltigem Token</span> |
                            <span class="status-badge status-idle" id="legend-status-idle">Idle</span> <span id="legend-status-idle-desc">>30 Min inaktiv</span> |
                            <span class="status-badge status-inactive" id="legend-status-inactive">Inactive</span> <span id="legend-status-inactive-desc">Token abgelaufen</span> |
                            <span class="status-badge status-orphaned" id="legend-status-orphaned">Orphaned</span> <span id="legend-status-orphaned-desc">Verwaiste Session</span>
                        </div>
                        <div class="token-cards" id="web-sessions-list"></div>
                    </div>

                    <!-- FCM Tokens Section -->
                    <div class="card" id="fcm-tokens-section" style="display: none;">
                        <div class="token-section-header">
                            <h3 class="token-section-title" id="section-fcm-title">
                                üîî FCM Tokens (Push Notifications)
                            </h3>
                            <span class="token-count" id="fcm-token-count">0</span>
                        </div>
                        <div class="token-cards" id="fcm-tokens-list"></div>
                    </div>

                    <!-- Live Activity Tokens Section -->
                    <div class="card" id="la-tokens-section" style="display: none;">
                        <div class="token-section-header">
                            <h3 class="token-section-title" id="section-la-title">
                                üìä Live Activity Tokens (iOS)
                            </h3>
                            <span class="token-count" id="la-token-count">0</span>
                        </div>
                        <div class="token-cards" id="la-tokens-list"></div>
                    </div>

                    <!-- Live Activity Start Tokens Section -->
                    <div class="card" id="las-tokens-section" style="display: none;">
                        <div class="token-section-header">
                            <h3 class="token-section-title" id="section-las-title">
                                üöÄ Live Activity Start Tokens (iOS)
                            </h3>
                            <span class="token-count" id="las-token-count">0</span>
                        </div>
                        <div class="token-cards" id="las-tokens-list"></div>
                    </div>

                    <!-- Orphaned Tokens Section -->
                    <div class="card" id="orphaned-tokens-section" style="display: none;">
                        <div class="token-section-header">
                            <h3 class="token-section-title" id="section-orphaned-title">
                                ‚ö†Ô∏è Verwaiste Tokens
                            </h3>
                            <span class="token-count" id="orphaned-token-count">0</span>
                        </div>
                        <div style="margin-bottom: 15px; font-size: 12px; color: var(--text-secondary);" id="orphaned-token-desc">
                            Refresh-Tokens ohne zugeh√∂rige Session (k√∂nnen gel√∂scht werden)
                        </div>
                        <div class="token-cards" id="orphaned-tokens-list"></div>
                    </div>
                </div>

                <!-- Debug Tools Section -->
                <div class="settings-section" id="section-debug">
                    <div class="section-title" id="card-debug-title">Debug Tools</div>

                    <div class="card">
                        <!-- HMS Test Section -->
                        <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <h4 id="hms-code-test-title" style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 14px;">üß™ HMS Code Test</h4>

                            <!-- HMS Input & Test Button -->
                            <div style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="hms-code-input" placeholder="z.B. 0700-0300-0002-0002"
                                       style="flex: 1; min-width: 0; padding: 8px; background: var(--input-bg); color: var(--text-primary);
                                              border: 1px solid var(--input-border); border-radius: 4px; font-size: 13px; box-sizing: border-box;">
                                <button id="btn-test-hms" onclick="testCustomHMS()" class="btn" style="padding: 8px 16px; white-space: nowrap; width: auto; flex-shrink: 0;">
                                    üß™ Test HMS
                                </button>
                            </div>

                            <!-- FCM Push Test Button -->
                            <div style="display: flex; gap: 8px; margin-bottom: 10px; align-items: center; flex-wrap: wrap;">
                                <button id="btn-test-fcm" onclick="testFCMNotification()" class="btn" style="padding: 8px 16px; white-space: nowrap; width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                    üî• Test ECHTE FCM Push Notification
                                </button>
                            </div>

                            <!-- Quick Select Buttons -->
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button id="btn-hms-error" onclick="document.getElementById('hms-code-input').value='0700-0300-0002-0002'"
                                        style="padding: 6px 10px; background: var(--bg-secondary); color: var(--text-secondary);
                                               border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    ‚ö†Ô∏è Fehler
                                </button>
                                <button id="btn-hms-filament" onclick="document.getElementById('hms-code-input').value='0300-8013'"
                                        style="padding: 6px 10px; background: var(--bg-secondary); color: var(--text-secondary);
                                               border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    ‚ÑπÔ∏è Filament-Wechsel
                                </button>
                                <button id="btn-hms-ams" onclick="document.getElementById('hms-code-input').value='0300-8004'"
                                        style="padding: 6px 10px; background: var(--bg-secondary); color: var(--text-secondary);
                                               border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    ‚ÑπÔ∏è AMS
                                </button>
                            </div>
                        </div>

                        <!-- Connection & Restart Buttons -->
                        <button class="btn btn-warning" onclick="testConnection()" id="btn-test-connection" style="margin-bottom: 10px;">
                            üîå Test Connection
                        </button>
                        <button class="btn btn-danger" onclick="restartServer()" id="btn-restart-server">
                            üîÑ Restart Server
                        </button>
                    </div>
                </div>

                <!-- System Health Section -->
                <div class="settings-section" id="section-health">
                    <div class="section-title">ü©∫ System Health Monitor</div>

                    <!-- Health Status Card -->
                    <div class="card" id="health-status-card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                                <span id="health-status-icon">‚è≥</span>
                                <span>System Status</span>
                            </h3>
                            <button class="btn" onclick="loadHealthStatus()" style="padding: 8px 16px;">
                                üîÑ Refresh
                            </button>
                        </div>

                        <!-- Overall Status Badge -->
                        <div id="health-overall-status" style="padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: 600; font-size: 16px; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                            Loading...
                        </div>

                        <!-- Uptime Info -->
                        <div id="health-uptime" style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">UPTIME</div>
                                <div id="health-uptime-value" style="font-size: 18px; font-weight: 600;">-</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">MEMORY</div>
                                <div id="health-memory-value" style="font-size: 18px; font-weight: 600;">-</div>
                            </div>
                            <div style="flex: 1; min-width: 150px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">THREADS</div>
                                <div id="health-threads-value" style="font-size: 18px; font-weight: 600;">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- MQTT Status Card -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>üì°</span> MQTT Status
                        </h3>
                        <div id="health-mqtt-details" style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Connected</span>
                                <span id="mqtt-connected-status" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Fully Initialized</span>
                                <span id="mqtt-initialized-status" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Last Disconnect Code</span>
                                <span id="mqtt-disconnect-code" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Reconnect Attempts</span>
                                <span id="mqtt-reconnect-attempts" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Reconnect In Progress</span>
                                <span id="mqtt-reconnect-progress" style="font-weight: 600;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Meross Status Card -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>üîå</span> Meross Status
                        </h3>
                        <div id="health-meross-details" style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Enabled</span>
                                <span id="meross-enabled-status" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Connected</span>
                                <span id="meross-connected-status" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Device Offline</span>
                                <span id="meross-offline-status" style="font-weight: 600;">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px;">
                                <span style="color: var(--text-secondary);">Consecutive Failures</span>
                                <span id="meross-failures" style="font-weight: 600;">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Active Threads Card -->
                    <div class="card">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <span>üßµ</span> Active Threads
                        </h3>
                        <div id="health-threads-list" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; background: var(--bg-secondary); border-radius: 8px; padding: 12px;">
                            Loading...
                        </div>
                    </div>

                    <!-- Issues Card (only shown if issues exist) -->
                    <div class="card" id="health-issues-card" style="margin-top: 20px; display: none; border-left: 4px solid var(--accent-orange);">
                        <h3 style="margin: 0 0 15px 0; font-size: 16px; display: flex; align-items: center; gap: 8px; color: var(--accent-orange);">
                            <span>‚ö†Ô∏è</span> Issues Detected
                        </h3>
                        <div id="health-issues-list" style="display: grid; gap: 8px;">
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="successToast" class="toast toast-success"></div>
    <div id="errorToast" class="toast toast-error"></div>

    <!-- Floating Save Button -->
    <button class="fab-save" id="fab-save" onclick="saveSettings()" title="Save Settings">
        üíæ
        <span class="fab-badge" id="fab-badge" style="display: none;">!</span>
    </button>

    <!-- Theme & Sidebar Modules -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/sidebar-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>

    <script src="/static/auth-handler.js"></script>
    <!-- Socket.IO f√ºr WebSocket Notifications -->
    <script src="/static/socket.io.js"></script>
    <!-- Sprachinitialisierung -->
    <script>
        // Global variables for translations
        let hasUnsavedChanges = false;
        let currentSection = 'overview';
        let initialFormState = null;
        const currentLang = localStorage.getItem('language') || 'de';
        const translationsMap = {
            'de': typeof translations_de !== 'undefined' ? translations_de : {},
            'en': typeof translations_en !== 'undefined' ? translations_en : {},
            'fr': typeof translations_fr !== 'undefined' ? translations_fr : {},
            'es': typeof translations_es !== 'undefined' ? translations_es : {},
            'it': typeof translations_it !== 'undefined' ? translations_it : {}
        };
        const texts = translationsMap[currentLang] || translationsMap['en'] || {};

        // Helper: Safe access to translations
        function getText(key, fallback = '') {
            return texts && texts[key] ? texts[key] : fallback;
        }

        // Translations werden im DOMContentLoaded Event angewendet (siehe unten)
    </script>
    <script>

        // Section Switching
        function switchSection(sectionId) {
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Update content
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('section-' + sectionId).classList.add('active');

            // Update header title
            const titles = {
                'overview': 'üìä ' + getText('settings_overview', 'Overview'),
                'license': 'üîê ' + getText('settings_license', 'License'),
                'mqtt': 'üì° ' + getText('settings_mqtt_printer', 'MQTT/Printer'),
                'camera': 'üì∑ ' + getText('settings_camera', 'Camera'),
                'print-defaults': 'üñ®Ô∏è ' + getText('settings_print_defaults', 'Print Defaults'),
                'filament': 'üßµ ' + getText('settings_filament_management', 'Filament Management'),
                'automation': 'ü§ñ ' + getText('settings_automation', 'Automation'),
                'homeassistant': 'üè† ' + getText('settings_home_assistant', 'Home Assistant'),
                'meross': 'üîå ' + getText('settings_meross', 'Meross'),
                'security': 'üîí ' + getText('settings_security_ssh', 'Security & SSH'),
                'tokens': 'üîë ' + getText('settings_token_management', 'Token Management'),
                'costs': 'üí∞ ' + getText('settings_costs', 'Costs'),
                'ui': 'üé® ' + getText('settings_ui_preferences', 'UI Preferences'),
                'debug': 'üêõ ' + getText('settings_debug_tools', 'Debug Tools'),
                'health': 'ü©∫ System Health'
            };
            document.getElementById('content-title').textContent = titles[sectionId];

            currentSection = sectionId;

            // Load tokens when Token Management section is opened
            if (sectionId === 'tokens') {
                loadAllTokens();
            }

            // Load health status when Health section is opened
            if (sectionId === 'health') {
                loadHealthStatus();
            }

            // Close mobile menu
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }

        // Mobile Menu Toggle
        let sidebarHoverTimeout = null;
        let sidebarCloseTimeout = null;

        function toggleMobileMenu() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        function openSidebarOnHover() {
            const sidebar = document.getElementById('sidebar');

            // Don't open if already open or opening
            if (sidebar.classList.contains('mobile-open') || sidebarHoverTimeout) {
                return;
            }

            // Clear any pending close timeout
            if (sidebarCloseTimeout) {
                clearTimeout(sidebarCloseTimeout);
                sidebarCloseTimeout = null;
            }

            // Open sidebar with slight delay
            sidebarHoverTimeout = setTimeout(() => {
                sidebar.classList.add('mobile-open');
                sidebarHoverTimeout = null; // Reset timeout reference
            }, 200);
        }

        function closeSidebarOnLeave() {
            const sidebar = document.getElementById('sidebar');

            // Don't close if not open or already closing
            if (!sidebar.classList.contains('mobile-open') || sidebarCloseTimeout) {
                return;
            }

            // Clear any pending open timeout
            if (sidebarHoverTimeout) {
                clearTimeout(sidebarHoverTimeout);
                sidebarHoverTimeout = null;
            }

            // Close sidebar with slight delay
            sidebarCloseTimeout = setTimeout(() => {
                sidebar.classList.remove('mobile-open');
                sidebarCloseTimeout = null; // Reset timeout reference
            }, 300);
        }

        function keepSidebarOpen() {
            // Clear close timeout when hovering over sidebar
            if (sidebarCloseTimeout) {
                clearTimeout(sidebarCloseTimeout);
                sidebarCloseTimeout = null;
            }
        }

        // Dark Mode Toggle (f√ºr Kompatibilit√§t mit altem Code)
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            // Nutze neues Theme System
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Entferne altes darkMode flag
            localStorage.removeItem('darkMode');
        }

        // Track changes
        function trackChanges() {
            hasUnsavedChanges = true;
            document.getElementById('fab-save').classList.add('visible');
        }

        // Dark Mode beim Laden anwenden
        function applyStoredTheme() {
            // Migration: Altes darkMode System zu neuem Theme System
            const oldDarkMode = localStorage.getItem('darkMode');
            let theme = localStorage.getItem('theme');

            if (!theme && oldDarkMode !== null) {
                // Migriere altes System
                theme = oldDarkMode === 'true' ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                localStorage.removeItem('darkMode');
            }

            theme = theme || 'auto';
            const isAndroidApp = window.isAndroidApp || false;
            const androidSystemDarkMode = window.androidSystemDarkMode || false;

            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'light') {
                document.body.classList.remove('dark-mode');
            } else if (theme === 'auto') {
                if (isAndroidApp) {
                    if (androidSystemDarkMode) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                } else {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            }
        }

        // Theme beim Laden anwenden
        applyStoredTheme();

        // System Theme Changes listener
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                const theme = localStorage.getItem('theme') || 'auto';
                if (theme === 'auto') {
                    if (e.matches) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                }
            });
        }

        // ===== Printer Gallery (Swipe Cards) =====
        function initPrinterGallery() {
            const gallery = document.getElementById('printer-gallery');
            const cards = gallery.querySelectorAll('.printer-card');
            const hiddenInput = document.getElementById('printer_model');

            let isDown = false;
            let startX;
            let scrollLeft;

            // Mouse drag to scroll
            gallery.addEventListener('mousedown', (e) => {
                isDown = true;
                gallery.style.cursor = 'grabbing';
                startX = e.pageX - gallery.offsetLeft;
                scrollLeft = gallery.scrollLeft;
            });

            gallery.addEventListener('mouseleave', () => {
                isDown = false;
                gallery.style.cursor = 'grab';
            });

            gallery.addEventListener('mouseup', () => {
                isDown = false;
                gallery.style.cursor = 'grab';
            });

            gallery.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - gallery.offsetLeft;
                const walk = (x - startX) * 2;
                gallery.scrollLeft = scrollLeft - walk;
            });

            // Touch swipe
            let touchStartX = 0;
            let touchEndX = 0;

            gallery.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            gallery.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
            }, { passive: true });

            // Card selection
            cards.forEach(card => {
                card.addEventListener('click', (e) => {
                    // Prevent selection if user was dragging
                    const dragDistance = Math.abs(touchEndX - touchStartX);
                    if (dragDistance > 10 && touchStartX !== 0) return;

                    const value = card.dataset.value;

                    // Update selected state
                    cards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');

                    // Update hidden input
                    hiddenInput.value = value;

                    // Trigger change tracking
                    setTimeout(() => {
                        if (typeof updateUnsavedChangesUI === 'function') {
                            updateUnsavedChangesUI();
                        }
                    }, 50);

                    // Smooth scroll to center the selected card
                    const cardRect = card.getBoundingClientRect();
                    const galleryRect = gallery.getBoundingClientRect();
                    const cardCenter = cardRect.left + cardRect.width / 2;
                    const galleryCenter = galleryRect.left + galleryRect.width / 2;
                    const scrollOffset = cardCenter - galleryCenter;

                    gallery.scrollBy({
                        left: scrollOffset,
                        behavior: 'smooth'
                    });
                });
            });
        }

        // Update gallery from loaded value
        function updatePrinterGallery(modelId) {
            const gallery = document.getElementById('printer-gallery');
            const card = gallery.querySelector(`.printer-card[data-value="${modelId}"]`);
            if (card) {
                // Remove selected from all cards
                gallery.querySelectorAll('.printer-card').forEach(c => c.classList.remove('selected'));
                // Add selected to the target card
                card.classList.add('selected');

                // Scroll to center the card
                setTimeout(() => {
                    const cardRect = card.getBoundingClientRect();
                    const galleryRect = gallery.getBoundingClientRect();
                    const cardCenter = cardRect.left + cardRect.width / 2;
                    const galleryCenter = galleryRect.left + galleryRect.width / 2;
                    const scrollOffset = cardCenter - galleryCenter;

                    gallery.scrollBy({
                        left: scrollOffset,
                        behavior: 'smooth'
                    });
                }, 100);
            }
        }

        // Load Settings from Server
        async function loadSettings() {
            try {
                const response = await apiCall('/api/config');
                if (!response.ok) {
                    throw new Error('Failed to load settings');
                }
                const config = await response.json();
                populateFields(config);
            } catch (error) {
                console.error('Error loading settings:', error);
                showError(texts.error_loading_settings || 'Error loading settings');
            }
        }

        function updateOverview(config) {
            // Printer Info
            if (config.mqtt) {
                document.getElementById('overview-printer-name').textContent = config.mqtt.printer_name || '-';
                document.getElementById('overview-printer-model').textContent = config.mqtt.printer_model || '-';
                document.getElementById('overview-printer-ip').textContent = config.mqtt.bambu_ip || '-';
                const serial = config.mqtt.bambu_serial || '-';
                document.getElementById('overview-printer-serial').textContent = serial.length > 8 ? serial.substring(0, 8) + '...' : serial;
            }

            // Home Assistant Status
            if (config.homeassistant) {
                const haEnabled = config.homeassistant.enabled !== false;
                const haStatus = document.getElementById('overview-ha-status');
                haStatus.textContent = haEnabled ? getText('settings_enabled', 'Enabled') : getText('settings_disabled', 'Disabled');
                haStatus.className = 'overview-status ' + (haEnabled ? 'enabled' : 'disabled');
                document.getElementById('overview-ha-url').textContent = config.homeassistant.ha_url || '-';
            }

            // Meross Status
            if (config.meross) {
                const merossEnabled = config.meross.enabled || false;
                const merossStatus = document.getElementById('overview-meross-status');
                merossStatus.textContent = merossEnabled ? getText('settings_enabled', 'Enabled') : getText('settings_disabled', 'Disabled');
                merossStatus.className = 'overview-status ' + (merossEnabled ? 'enabled' : 'disabled');
                document.getElementById('overview-meross-device').textContent = config.meross.device_name || '-';
            }

            // Spoolman Status
            if (config.spoolman) {
                const spoolmanEnabled = config.spoolman.enabled || false;
                const spoolmanStatus = document.getElementById('overview-spoolman-status');
                spoolmanStatus.textContent = spoolmanEnabled ? getText('settings_enabled', 'Enabled') : getText('settings_disabled', 'Disabled');
                spoolmanStatus.className = 'overview-status ' + (spoolmanEnabled ? 'enabled' : 'disabled');
                document.getElementById('overview-spoolman-url').textContent = config.spoolman.url || '-';
            }

            // Filament Drying Status
            if (config.filament_drying) {
                const dryingEnabled = config.filament_drying.enabled || false;
                const dryingStatus = document.getElementById('overview-drying-status');
                dryingStatus.textContent = dryingEnabled ? getText('settings_enabled', 'Enabled') : getText('settings_disabled', 'Disabled');
                dryingStatus.className = 'overview-status ' + (dryingEnabled ? 'enabled' : 'disabled');

                const materialCount = config.filament_drying.materials ? Object.keys(config.filament_drying.materials).length : 0;
                document.getElementById('overview-drying-materials').textContent = materialCount + ' configured';
            }

            // CORS Origins Count
            if (config.cors && config.cors.allowed_origins) {
                const corsCount = config.cors.allowed_origins.length;
                document.getElementById('overview-cors-count').textContent = corsCount + ' origin' + (corsCount !== 1 ? 's' : '');
            } else {
                document.getElementById('overview-cors-count').textContent = 'Auto-detect';
            }

            // SSH User
            if (config.ssh) {
                document.getElementById('overview-ssh-user').textContent = config.ssh.user || 'Not configured';
            } else {
                document.getElementById('overview-ssh-user').textContent = 'Not configured';
            }

            // Camera Size
            if (config.ui) {
                const cameraSize = config.ui.default_camera_size || 2;
                const sizeNames = { 1: 'Small (1x)', 2: 'Medium (2x)', 3: 'Large (3x)' };
                document.getElementById('overview-camera-size').textContent = sizeNames[cameraSize] || 'Medium (2x)';
            } else {
                document.getElementById('overview-camera-size').textContent = 'Medium (2x)';
            }
        }

        function populateFields(config) {
            // Update Overview
            updateOverview(config);

            // MQTT/Bambu
            if (config.mqtt) {
                document.getElementById('printer_name').value = config.mqtt.printer_name || '';
                const printerModel = config.mqtt.printer_model || 'P1S';
                document.getElementById('printer_model').value = printerModel;
                updatePrinterGallery(printerModel);
                document.getElementById('bambu_ip').value = config.mqtt.bambu_ip || '';
                document.getElementById('bambu_serial').value = config.mqtt.bambu_serial || '';
                document.getElementById('bambu_access_code').value = config.mqtt.bambu_access_code || '';

                // Maintenance Notifications
                document.getElementById('maintenance_notifications_enabled').checked = config.mqtt.maintenance_notifications?.enabled !== false;
                document.getElementById('maintenance_notification_frequency').value = config.mqtt.maintenance_notifications?.frequency || 6;
                document.getElementById('maintenance_notification_start_hour').value = config.mqtt.maintenance_notifications?.start_hour || 0;
            }

            // Auto Power Off
            if (config.auto_power_off) {
                document.getElementById('auto_power_enabled').checked = config.auto_power_off.enabled || false;
                document.getElementById('power_off_delay').value = config.auto_power_off.minutes_after_print || 15;
                document.getElementById('power_off_idle').value = config.auto_power_off.minutes_idle || 60;
            }

            // Auto Light
            if (config.automation) {
                document.getElementById('auto_light_mqtt').checked = config.automation.auto_light_on_mqtt || false;
                document.getElementById('auto_light_only_dark').checked = config.automation.auto_light_only_dark || false;
                document.getElementById('dark_start_hour').value = config.automation.dark_start_hour || 22;
                document.getElementById('dark_end_hour').value = config.automation.dark_end_hour || 7;
            }

            // Hardware Button
            if (config.hardware_button) {
                document.getElementById('hardware_button_enabled').checked = config.hardware_button.enabled || false;
            }

            // Camera
            if (config.ustreamer) {
                document.getElementById('camera_enabled').checked = config.ustreamer.enabled || false;
                document.getElementById('camera_ip').value = config.ustreamer.pi5_ip || '';
                document.getElementById('camera_port').value = config.ustreamer.port || 8080;
                document.getElementById('camera_username').value = config.ustreamer.username || '';
                document.getElementById('camera_password').value = config.ustreamer.password || '';
            }

            // Costs
            if (config.costs) {
                document.getElementById('filament_cost').value = config.costs.filament_per_kg || 21.0;
                document.getElementById('power_cost').value = config.costs.power_per_kwh || 0.285;
            }

            // Print Defaults
            if (config.print_defaults) {
                document.getElementById('print_timelapse').checked = config.print_defaults.timelapse !== false;
                document.getElementById('print_use_ams').checked = config.print_defaults.use_ams !== false;
                document.getElementById('print_bed_leveling').checked = config.print_defaults.bed_leveling !== false;
                document.getElementById('print_layer_inspect').checked = config.print_defaults.layer_inspect !== false;
                document.getElementById('print_flow_cali').checked = config.print_defaults.flow_cali || false;
                document.getElementById('print_vibration_cali').checked = config.print_defaults.vibration_cali || false;
            }

            // Spoolman
            if (config.spoolman) {
                document.getElementById('spoolman_enabled').checked = config.spoolman.enabled || false;
                document.getElementById('spoolman_url').value = config.spoolman.url || '';
                document.getElementById('spoolman_external_url').value = config.spoolman.external_url || '';
                document.getElementById('spoolman_threshold').value = config.spoolman.min_filament_threshold || 200;
                document.getElementById('spoolman_auto_track').checked = config.spoolman.auto_track || false;
            }

            // Home Assistant
            if (config.homeassistant) {
                document.getElementById('ha_enabled').checked = config.homeassistant.enabled !== false;
                document.getElementById('ha_url').value = config.homeassistant.ha_url || '';
                document.getElementById('ha_token').value = config.homeassistant.token || '';
            }

            // Meross
            if (config.meross) {
                document.getElementById('meross_enabled').checked = config.meross.enabled || false;
                document.getElementById('meross_email').value = config.meross.email || '';
                document.getElementById('meross_password').value = config.meross.password || '';
                document.getElementById('meross_device').value = config.meross.device_name || '';
                document.getElementById('meross_region').value = config.meross.region || 'eu';
            }

            // Security (CORS)
            if (config.cors) {
                loadCorsOrigins(config.cors.allowed_origins || []);
            }

            // SSH Settings
            if (config.ssh) {
                document.getElementById('ssh_user').value = config.ssh.user || '';
                document.getElementById('ssh_password').value = config.ssh.password || '';
            }

            // UI Settings
            if (config.ui) {
                document.getElementById('default_camera_size').value = config.ui.default_camera_size || 2;

                // Card Visibility (default: alle sichtbar)
                const cardVis = config.ui.card_visibility || {};
                document.getElementById('card_camera_visible').checked = cardVis.camera !== false;
                document.getElementById('card_progress_visible').checked = cardVis.progress !== false;
                document.getElementById('card_spoolman_visible').checked = cardVis.spoolman !== false;
                document.getElementById('card_drying_visible').checked = cardVis.drying !== false;
            }

            // Filament Drying
            if (config.filament_drying) {
                document.getElementById('filament_drying_enabled').checked = config.filament_drying.enabled || false;
                if (config.filament_drying.materials) {
                    renderFilamentMaterials(config.filament_drying.materials);
                }
                if (config.filament_drying.parking_position) {
                    document.getElementById('parking_x').value = config.filament_drying.parking_position.x || 255;
                    document.getElementById('parking_y').value = config.filament_drying.parking_position.y || 250;
                    document.getElementById('parking_z').value = config.filament_drying.parking_position.z || 200;
                }
            }

            // Redis Authentication
            if (config.redis) {
                document.getElementById('redis_auth_enabled').checked = config.redis.password_enabled || false;
                document.getElementById('redis_password').value = config.redis.password || '';
                // Zeige/Verstecke Password-Feld basierend auf Checkbox
                toggleRedisPassword();
            }

            // Power Control Mode
            if (config.power_control) {
                document.getElementById('power_control_mode').value = config.power_control.mode || 'homeassistant';
            }

            // Nach dem Laden: Initial State speichern f√ºr Change Detection
            setTimeout(() => {
                captureInitialState();
                initializeChangeTracking();
            }, 100);
        }

        // ===== UNSAVED CHANGES TRACKING =====

        // Erfasse den initialen Zustand aller Form-Felder
        function captureInitialState() {
            initialFormState = getCurrentFormState();
            console.log('üì∏ Initial form state captured');
        }

        // Hole den aktuellen Zustand aller Form-Felder
        function getCurrentFormState() {
            const state = {};

            // Alle Input-Felder
            document.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], input[type="number"]').forEach(input => {
                if (input.id) state[input.id] = input.value;
            });

            // Alle Checkboxen
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.id) state[checkbox.id] = checkbox.checked;
            });

            // Hidden Input (Printer Model)
            const printerModel = document.getElementById('printer_model');
            if (printerModel) state.printer_model = printerModel.value;

            // CORS Origins Array
            state.cors_origins = JSON.stringify(corsOriginsArray);

            // Filament Materials Data
            state.filament_materials = JSON.stringify(filamentMaterialsData);

            return state;
        }

        // Pr√ºfe ob es √Ñnderungen gibt
        function checkForChanges() {
            if (!initialFormState) return false;

            const currentState = getCurrentFormState();

            // Vergleiche alle Felder
            for (const key in currentState) {
                if (currentState[key] !== initialFormState[key]) {
                    return true;
                }
            }

            return false;
        }

        // Update UI basierend auf √Ñnderungen
        function updateUnsavedChangesUI() {
            const hasChanges = checkForChanges();

            if (hasChanges !== hasUnsavedChanges) {
                hasUnsavedChanges = hasChanges;

                const fab = document.getElementById('fab-save');
                const badge = document.getElementById('fab-badge');

                if (hasChanges) {
                    fab.classList.add('visible', 'has-changes');
                    badge.style.display = 'flex';
                    console.log('‚ö†Ô∏è Unsaved changes detected');
                } else {
                    fab.classList.remove('visible', 'has-changes');
                    badge.style.display = 'none';
                    console.log('‚úÖ No unsaved changes');
                }
            }
        }

        // Initialisiere Change Tracking f√ºr alle Form-Elemente
        function initializeChangeTracking() {
            // Text/Number/Password Inputs
            document.querySelectorAll('input[type="text"], input[type="email"], input[type="password"], input[type="number"]').forEach(input => {
                input.addEventListener('input', updateUnsavedChangesUI);
            });

            // Checkboxen
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateUnsavedChangesUI);
            });

            // Note: Printer Gallery handles its own change tracking in initPrinterGallery()

            console.log('üëÄ Change tracking initialized');
        }

        // Beforeunload Warning
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = texts.unsaved_changes_warning || 'Sie haben ungespeicherte √Ñnderungen. M√∂chten Sie die Seite wirklich verlassen?';
                return e.returnValue;
            }
        });

        // Save Settings to Server
        async function saveSettings() {
            const config = {
                mqtt: {
                    printer_name: document.getElementById('printer_name').value,
                    printer_model: document.getElementById('printer_model').value,
                    bambu_ip: document.getElementById('bambu_ip').value,
                    bambu_serial: document.getElementById('bambu_serial').value,
                    bambu_access_code: document.getElementById('bambu_access_code').value,
                    maintenance_notifications: {
                        enabled: document.getElementById('maintenance_notifications_enabled').checked,
                        frequency: parseInt(document.getElementById('maintenance_notification_frequency').value) || 6,
                        start_hour: parseInt(document.getElementById('maintenance_notification_start_hour').value) || 0
                    }
                },
                auto_power_off: {
                    enabled: document.getElementById('auto_power_enabled').checked,
                    minutes_after_print: parseInt(document.getElementById('power_off_delay').value) || 15,
                    minutes_idle: parseInt(document.getElementById('power_off_idle').value) || 60
                },
                automation: {
                    auto_light_on_mqtt: document.getElementById('auto_light_mqtt').checked,
                    auto_light_only_dark: document.getElementById('auto_light_only_dark').checked,
                    dark_start_hour: parseInt(document.getElementById('dark_start_hour').value) || 22,
                    dark_end_hour: parseInt(document.getElementById('dark_end_hour').value) || 7
                },
                hardware_button: {
                    enabled: document.getElementById('hardware_button_enabled').checked
                },
                ustreamer: {
                    enabled: document.getElementById('camera_enabled').checked,
                    pi5_ip: document.getElementById('camera_ip').value,
                    port: parseInt(document.getElementById('camera_port').value) || 8080,
                    username: document.getElementById('camera_username').value,
                    password: document.getElementById('camera_password').value
                },
                costs: {
                    filament_per_kg: parseFloat(document.getElementById('filament_cost').value) || 21.0,
                    power_per_kwh: parseFloat(document.getElementById('power_cost').value) || 0.285
                },
                print_defaults: {
                    timelapse: document.getElementById('print_timelapse').checked,
                    use_ams: document.getElementById('print_use_ams').checked,
                    bed_leveling: document.getElementById('print_bed_leveling').checked,
                    layer_inspect: document.getElementById('print_layer_inspect').checked,
                    flow_cali: document.getElementById('print_flow_cali').checked,
                    vibration_cali: document.getElementById('print_vibration_cali').checked
                },
                spoolman: {
                    enabled: document.getElementById('spoolman_enabled').checked,
                    url: document.getElementById('spoolman_url').value,
                    external_url: document.getElementById('spoolman_external_url').value,
                    min_filament_threshold: parseInt(document.getElementById('spoolman_threshold').value) || 200,
                    auto_track: document.getElementById('spoolman_auto_track').checked
                },
                homeassistant: {
                    enabled: document.getElementById('ha_enabled').checked,
                    ha_url: document.getElementById('ha_url').value,
                    token: document.getElementById('ha_token').value
                },
                meross: {
                    enabled: document.getElementById('meross_enabled').checked,
                    email: document.getElementById('meross_email').value,
                    password: document.getElementById('meross_password').value,
                    device_name: document.getElementById('meross_device').value,
                    region: document.getElementById('meross_region').value
                },
                power_control: {
                    mode: document.getElementById('power_control_mode').value
                },
                cors: {
                    allowed_origins: getCorsOrigins()
                },
                ssh: {
                    user: document.getElementById('ssh_user').value,
                    password: document.getElementById('ssh_password').value
                },
                ui: {
                    default_camera_size: parseInt(document.getElementById('default_camera_size').value) || 2,
                    card_visibility: {
                        camera: document.getElementById('card_camera_visible').checked,
                        progress: document.getElementById('card_progress_visible').checked,
                        spoolman: document.getElementById('card_spoolman_visible').checked,
                        drying: document.getElementById('card_drying_visible').checked
                    }
                },
                filament_drying: {
                    enabled: document.getElementById('filament_drying_enabled').checked,
                    materials: getFilamentMaterials(),
                    parking_position: {
                        x: parseInt(document.getElementById('parking_x').value) || 255,
                        y: parseInt(document.getElementById('parking_y').value) || 250,
                        z: parseInt(document.getElementById('parking_z').value) || 200
                    }
                },
                redis: {
                    password_enabled: document.getElementById('redis_auth_enabled').checked,
                    password: document.getElementById('redis_password').value
                }
            };

            try {
                const response = await apiCall('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showSuccess(texts.settings_saved_msg || 'Settings saved successfully!');

                    // Nach erfolgreichem Speichern: Initial State neu erfassen
                    captureInitialState();
                    hasUnsavedChanges = false;

                    // UI zur√ºcksetzen
                    const fab = document.getElementById('fab-save');
                    const badge = document.getElementById('fab-badge');

                    fab.classList.remove('visible', 'has-changes');
                    badge.style.display = 'none';
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showError(texts.error_saving_settings || 'Error saving settings');
            }
        }

        // Test Connection
        async function testConnection() {
            try {
                const response = await apiCall('/api/health');
                if (response.ok) {
                    showSuccess(texts.connection_success || '‚úÖ Connection successful!');
                } else {
                    showError(texts.connection_failed || '‚ùå Connection failed!');
                }
            } catch (error) {
                console.error('Connection test error:', error);
                showError(texts.connection_failed || '‚ùå Connection failed!');
            }
        }

        // Restart Server
        async function restartServer() {
            if (!confirm(texts.confirm_restart || 'Really restart the server?')) {
                return;
            }

            try {
                const response = await apiCall('/api/server/restart', { method: 'POST' });
                if (response.ok) {
                    showSuccess(texts.server_restarting || 'Server is restarting...');
                } else {
                    showError(texts.restart_failed || 'Restart failed');
                }
            } catch (error) {
                console.error('Restart error:', error);
                showError(texts.restart_failed || 'Restart failed');
            }
        }

        // Load System Health Status
        async function loadHealthStatus() {
            try {
                const response = await apiCall('/api/health/detailed');
                const data = await response.json();

                // Overall Status
                const statusEl = document.getElementById('health-overall-status');
                const statusIcon = document.getElementById('health-status-icon');

                if (data.status === 'healthy') {
                    statusEl.textContent = '‚úÖ System Healthy';
                    statusEl.style.background = 'rgba(76, 175, 80, 0.15)';
                    statusEl.style.color = 'var(--accent-green)';
                    statusEl.style.borderColor = 'var(--accent-green)';
                    statusIcon.textContent = '‚úÖ';
                } else if (data.status === 'degraded') {
                    statusEl.textContent = '‚ö†Ô∏è System Degraded';
                    statusEl.style.background = 'rgba(255, 152, 0, 0.15)';
                    statusEl.style.color = 'var(--accent-orange)';
                    statusEl.style.borderColor = 'var(--accent-orange)';
                    statusIcon.textContent = '‚ö†Ô∏è';
                } else {
                    statusEl.textContent = '‚ùå System Unhealthy';
                    statusEl.style.background = 'rgba(220, 53, 69, 0.15)';
                    statusEl.style.color = 'var(--accent-red)';
                    statusEl.style.borderColor = 'var(--accent-red)';
                    statusIcon.textContent = '‚ùå';
                }

                // Uptime, Memory, Threads
                if (data.checks.uptime) {
                    document.getElementById('health-uptime-value').textContent = data.checks.uptime.human || '-';
                }
                if (data.checks.memory) {
                    document.getElementById('health-memory-value').textContent = `${data.checks.memory.rss_mb} MB`;
                }
                if (data.checks.threads) {
                    document.getElementById('health-threads-value').textContent = data.checks.threads.total_count;
                }

                // MQTT Status
                if (data.checks.mqtt) {
                    const mqtt = data.checks.mqtt;
                    document.getElementById('mqtt-connected-status').innerHTML = mqtt.connected
                        ? '<span style="color: var(--accent-green);">‚úÖ Yes</span>'
                        : '<span style="color: var(--accent-red);">‚ùå No</span>';
                    document.getElementById('mqtt-initialized-status').innerHTML = mqtt.fully_initialized
                        ? '<span style="color: var(--accent-green);">‚úÖ Yes</span>'
                        : '<span style="color: var(--accent-orange);">‚è≥ No</span>';
                    document.getElementById('mqtt-disconnect-code').textContent = mqtt.last_disconnect_code || '-';
                    document.getElementById('mqtt-reconnect-attempts').textContent = mqtt.reconnect_attempts || '0';
                    document.getElementById('mqtt-reconnect-progress').innerHTML = mqtt.reconnect_in_progress
                        ? '<span style="color: var(--accent-orange);">üîÑ Yes</span>'
                        : '<span style="color: var(--text-secondary);">No</span>';
                }

                // Meross Status
                if (data.checks.meross) {
                    const meross = data.checks.meross;
                    document.getElementById('meross-enabled-status').innerHTML = meross.enabled
                        ? '<span style="color: var(--accent-green);">‚úÖ Yes</span>'
                        : '<span style="color: var(--text-secondary);">No</span>';
                    document.getElementById('meross-connected-status').innerHTML = meross.connected
                        ? `<span style="color: var(--accent-green);">‚úÖ ${meross.device_name || 'Yes'}</span>`
                        : '<span style="color: var(--accent-red);">‚ùå No</span>';
                    document.getElementById('meross-offline-status').innerHTML = meross.device_offline
                        ? '<span style="color: var(--accent-red);">‚ö†Ô∏è Yes</span>'
                        : '<span style="color: var(--accent-green);">No</span>';
                    document.getElementById('meross-failures').textContent = meross.consecutive_failures || '0';
                }

                // Active Threads List
                if (data.checks.threads && data.checks.threads.threads) {
                    const threadsList = document.getElementById('health-threads-list');
                    const threads = data.checks.threads.threads;

                    if (threads.length > 0) {
                        threadsList.innerHTML = threads.map(t => {
                            const statusColor = t.alive ? 'var(--accent-green)' : 'var(--accent-red)';
                            const daemonBadge = t.daemon ? '<span style="color: var(--text-secondary); font-size: 10px;"> [daemon]</span>' : '';
                            return `<div style="padding: 4px 0; border-bottom: 1px solid var(--border-color);">
                                <span style="color: ${statusColor};">‚óè</span> ${t.name}${daemonBadge}
                            </div>`;
                        }).join('');
                    } else {
                        threadsList.innerHTML = '<span style="color: var(--text-secondary);">No threads found</span>';
                    }
                }

                // Issues
                const issuesCard = document.getElementById('health-issues-card');
                const issuesList = document.getElementById('health-issues-list');

                if (data.issues && data.issues.length > 0) {
                    issuesCard.style.display = 'block';
                    issuesList.innerHTML = data.issues.map(issue =>
                        `<div style="padding: 8px 12px; background: rgba(255, 152, 0, 0.1); border-radius: 6px; color: var(--accent-orange);">
                            ‚ö†Ô∏è ${issue}
                        </div>`
                    ).join('');
                } else {
                    issuesCard.style.display = 'none';
                }

            } catch (error) {
                console.error('Health check error:', error);
                document.getElementById('health-overall-status').textContent = '‚ùå Failed to load health status';
                document.getElementById('health-overall-status').style.background = 'rgba(220, 53, 69, 0.15)';
                document.getElementById('health-overall-status').style.color = 'var(--accent-red)';
            }
        }

        // Test Home Assistant
        async function testHomeAssistant() {
            try {
                const response = await apiCall('/api/test/ha');
                if (!response.ok) {
                    showError(texts.ha_test_failed || '‚ùå Home Assistant test failed');
                    return;
                }

                const data = await response.json();
                if (data.success) {
                    showSuccess(texts.ha_test_success || '‚úÖ Home Assistant connection successful!');
                } else {
                    showError(texts.ha_test_failed || '‚ùå Home Assistant not reachable');
                }
            } catch (error) {
                console.error('Home Assistant test error:', error);
                showError(texts.ha_test_failed || '‚ùå Home Assistant test failed');
            }
        }

        // Show Toast Functions
        function showToast(id, message) {
            const toast = document.getElementById(id);
            toast.textContent = message;
            toast.classList.remove('hiding');
            toast.classList.add('show');

            // Auto-hide nach 4 Sekunden
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    toast.classList.remove('show', 'hiding');
                }, 300); // Animation duration
            }, 4000);
        }

        // Toast-Funktionen f√ºr settings.html
        // WICHTIG: Im Electron-Kontext sind showSuccess/showError bereits von toast.js injiziert
        // Diese haben eine andere Signatur: showSuccess(title, message) statt showSuccess(msg)
        // Daher m√ºssen wir einen Wrapper erstellen, der beide Signaturen unterst√ºtzt

        // Speichere injizierte Funktionen falls vorhanden
        const injectedShowSuccess = window.showSuccess;
        const injectedShowError = window.showError;

        // Speichere Referenz zur lokalen showToast Funktion
        const localShowToast = showToast;

        // Definiere lokale Wrapper-Funktionen
        window.showSuccess = (msg) => {
            // Pr√ºfe ob Electron Toast-System verf√ºgbar ist (checke window.showToast.name)
            if (window.showToast && window.showToast.toString().includes('options')) {
                // Electron: Nutze Electron showToast mit Object-Parameter
                window.showToast({ title: 'Erfolg', message: msg, type: 'success' });
            } else {
                // Browser: Nutze lokale showToast Funktion (legacy)
                localShowToast('successToast', msg);
            }
        };

        window.showError = (msg) => {
            // Pr√ºfe ob Electron Toast-System verf√ºgbar ist
            if (window.showToast && window.showToast.toString().includes('options')) {
                // Electron: Nutze Electron showToast mit Object-Parameter
                window.showToast({ title: 'Fehler', message: msg, type: 'error' });
            } else {
                // Browser: Nutze lokale showToast Funktion (legacy)
                localShowToast('errorToast', msg);
            }
        };

        // Test Custom HMS Code
        async function testCustomHMS() {
            const hmsCode = document.getElementById('hms-code-input').value.trim();

            if (!hmsCode) {
                showError(texts.toast_enter_hms_code || 'Please enter an HMS code');
                return;
            }

            try {
                const response = await apiCall('/api/test/simulate_hms_error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: hmsCode })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('‚úÖ ' + (texts.toast_hms_simulated || 'HMS Test sent: {code}').replace('{code}', hmsCode));
                } else {
                    showError(data.error || texts.hms_test_failed || 'HMS Test failed');
                }
            } catch (error) {
                console.error('HMS Test error:', error);
                showError(texts.hms_test_failed || 'HMS Test failed');
            }
        }

        // Test FCM Push Notification
        async function testFCMNotification() {
            try {
                const response = await apiCall('/api/test/fcm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'üß™ FCM Test',
                        body: 'Dies ist eine ECHTE FCM Push Notification!',
                        type: 'hms_error'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess('‚úÖ FCM Push Notification gesendet! Pr√ºfe die App auf eingehende Notification.');
                } else {
                    showError(data.error || 'FCM Test fehlgeschlagen');
                }
            } catch (error) {
                console.error('FCM Test error:', error);
                showError('FCM Test fehlgeschlagen: ' + error.message);
            }
        }

        // Load License Information
        async function loadLicenseInfo() {
            try {
                const response = await fetch('/license/api/info');
                const data = await response.json();

                const statusBadge = document.getElementById('license-status-badge');
                const licenseDetails = document.getElementById('license-details');
                const noLicenseDiv = document.getElementById('license-no-license');

                if (data.valid) {
                    // Show license details, hide no-license message
                    licenseDetails.style.display = 'block';
                    noLicenseDiv.style.display = 'none';

                    // Status Badge
                    statusBadge.innerHTML = `‚úÖ ${texts.license_valid || 'Valid'}`;
                    statusBadge.style.background = 'var(--accent-green)';
                    statusBadge.style.color = 'white';

                    // License Type
                    const licenseTypeValue = document.getElementById('license-type-value');
                    let typeText = data.license_type;
                    if (data.license_type === 'DEMO') {
                        typeText = `${texts.license_demo || 'DEMO'} ‚è±Ô∏è`;
                    } else if (data.license_type === 'YEARLY') {
                        typeText = `${texts.license_yearly || 'YEARLY'} üìÖ`;
                    } else if (data.license_type === 'LIFETIME') {
                        typeText = `${texts.license_lifetime || 'LIFETIME'} ‚àû`;
                    }
                    licenseTypeValue.textContent = typeText;

                    // Customer Name
                    if (data.customer_name) {
                        document.getElementById('license-customer-value').textContent = data.customer_name;
                        document.getElementById('license-customer-container').style.display = 'block';
                    } else {
                        document.getElementById('license-customer-container').style.display = 'none';
                    }

                    // Expiration
                    const expirationValue = document.getElementById('license-expiration-value');
                    if (data.license_type === 'LIFETIME') {
                        expirationValue.innerHTML = `<strong>${texts.license_unlimited || 'Unlimited'} ‚àû</strong>`;
                        expirationValue.style.color = 'var(--accent-green)';
                    } else if (data.expires_at) {
                        const expiryDate = new Date(data.expires_at);
                        const now = new Date();
                        const daysRemaining = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

                        expirationValue.textContent = expiryDate.toLocaleDateString(currentLang, {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        if (daysRemaining > 0) {
                            expirationValue.innerHTML += ` <span style="font-size: 12px; color: var(--text-secondary);">(${daysRemaining} ${texts.license_days_remaining || 'days remaining'})</span>`;
                        }

                        if (daysRemaining <= 30) {
                            expirationValue.style.color = 'var(--accent-orange)';
                        }
                    }

                    // Activated On
                    if (data.activated_at) {
                        const activatedDate = new Date(data.activated_at);
                        document.getElementById('license-activated-value').textContent = activatedDate.toLocaleDateString(currentLang, {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        document.getElementById('license-activated-container').style.display = 'block';
                    } else {
                        document.getElementById('license-activated-container').style.display = 'none';
                    }

                    // Hardware ID
                    document.getElementById('license-hwid-value').value = data.hardware_id || '';

                } else if (data.expired) {
                    // License expired
                    licenseDetails.style.display = 'none';
                    noLicenseDiv.style.display = 'block';

                    statusBadge.innerHTML = `‚è∞ ${texts.license_expired || 'Expired'}`;
                    statusBadge.style.background = 'var(--accent-red)';
                    statusBadge.style.color = 'white';

                } else {
                    // No license
                    licenseDetails.style.display = 'none';
                    noLicenseDiv.style.display = 'block';

                    statusBadge.innerHTML = `‚ùå ${texts.license_invalid || 'No License'}`;
                    statusBadge.style.background = 'var(--accent-red)';
                    statusBadge.style.color = 'white';
                }

            } catch (error) {
                console.error('Error loading license info:', error);
                const statusBadge = document.getElementById('license-status-badge');
                statusBadge.innerHTML = `‚ö†Ô∏è ${texts.error || 'Error'}`;
                statusBadge.style.background = 'var(--accent-orange)';
                statusBadge.style.color = 'white';
            }
        }

        // Copy Hardware ID to Clipboard
        async function copyHardwareId() {
            const hwidInput = document.getElementById('license-hwid-value');
            const hwid = hwidInput.value;

            try {
                await navigator.clipboard.writeText(hwid);
                showSuccess(texts.license_hardware_id_copied || '‚úÖ Hardware ID copied to clipboard');

                // Visual feedback
                const btn = document.getElementById('btn-copy-hwid');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ ' + (texts.copied || 'Copied');
                btn.style.background = 'var(--accent-green)';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (error) {
                console.error('Copy error:', error);
                // Fallback for older browsers
                hwidInput.select();
                document.execCommand('copy');
                showSuccess(texts.license_hardware_id_copied || '‚úÖ Hardware ID copied to clipboard');
            }
        }

        // Deactivate License
        async function deactivateLicense() {
            const confirmMsg = texts.license_deactivate_confirm || 'Are you sure you want to deactivate this license? The application will stop working until you activate a new license.';

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const response = await apiCall('/license/api/deactivate', {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(texts.license_deactivate_success || '‚úÖ License deactivated successfully');

                    // Reload license info
                    setTimeout(() => {
                        loadLicenseInfo();
                    }, 1000);
                } else {
                    showError(data.error || texts.license_deactivate_error || '‚ùå Failed to deactivate license');
                }
            } catch (error) {
                console.error('Deactivate error:', error);
                showError(texts.license_deactivate_error || '‚ùå Failed to deactivate license');
            }
        }

        // ============ HELPER FUNCTIONS ============

        // CORS Origins Management
        let corsOriginsArray = [];

        function loadCorsOrigins(origins) {
            corsOriginsArray = origins || [];
            renderCorsOrigins();
        }

        function renderCorsOrigins() {
            const container = document.getElementById('cors-origins-list');
            container.innerHTML = '';

            if (corsOriginsArray.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 12px; padding: 8px;">No origins configured (auto-detection active)</div>';
                return;
            }

            corsOriginsArray.forEach((origin, index) => {
                const originDiv = document.createElement('div');
                originDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-section); border-radius: 5px; margin-bottom: 5px;';
                originDiv.innerHTML = `
                    <span style="flex: 1; font-size: 13px;">${origin}</span>
                    <button onclick="removeCorsOrigin(${index})" style="background: var(--accent-red); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">‚úï</button>
                `;
                container.appendChild(originDiv);
            });
        }

        function addCorsOrigin() {
            const input = document.getElementById('new-cors-origin');
            const origin = input.value.trim();

            if (!origin) return;

            // Simple validation
            if (!origin.startsWith('http://') && !origin.startsWith('https://')) {
                alert('Origin must start with http:// or https://');
                return;
            }

            if (corsOriginsArray.includes(origin)) {
                alert('Origin already exists');
                return;
            }

            corsOriginsArray.push(origin);
            renderCorsOrigins();
            input.value = '';

            // Mark as changed
            updateUnsavedChangesUI();
        }

        function removeCorsOrigin(index) {
            corsOriginsArray.splice(index, 1);
            renderCorsOrigins();
            updateUnsavedChangesUI();
        }

        function getCorsOrigins() {
            return corsOriginsArray;
        }

        // Redis Password Toggle
        function toggleRedisPassword() {
            const enabled = document.getElementById('redis_auth_enabled').checked;
            const passwordGroup = document.getElementById('redis-password-group');
            passwordGroup.style.display = enabled ? 'block' : 'none';
        }

        // Filament Materials Management
        let filamentMaterialsData = {};

        function renderFilamentMaterials(materials) {
            filamentMaterialsData = materials || {};
            const container = document.getElementById('filament-materials-list');
            container.innerHTML = '';

            const materialNames = Object.keys(filamentMaterialsData);

            if (materialNames.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">' + getText('no_materials_configured', 'No materials configured') + '</div>';
                return;
            }

            materialNames.forEach(material => {
                const data = filamentMaterialsData[material];
                const materialDiv = document.createElement('div');
                materialDiv.style.cssText = 'padding: 12px; background: var(--bg-card); border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border-color);';
                materialDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span style="font-size: 20px;">${data.emoji || 'üì¶'}</span>
                        <strong style="flex: 1;">${material}</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; font-size: 13px;">
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary);">${getText('material_min_temp', 'Min Temp (¬∞C)')}</label>
                            <input type="number" value="${data.temp_min}" onchange="updateMaterialField('${material}', 'temp_min', this.value)"
                                   style="width: 100%; padding: 6px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px; color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary);">${getText('material_max_temp', 'Max Temp (¬∞C)')}</label>
                            <input type="number" value="${data.temp_max}" onchange="updateMaterialField('${material}', 'temp_max', this.value)"
                                   style="width: 100%; padding: 6px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px; color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary);">${getText('material_duration', 'Duration (Hours)')}</label>
                            <input type="number" value="${data.duration_hours}" onchange="updateMaterialField('${material}', 'duration_hours', this.value)"
                                   style="width: 100%; padding: 6px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px; color: var(--text-primary);">
                        </div>
                        ${data.reminder_hours !== undefined ? `
                        <div>
                            <label style="font-size: 11px; color: var(--text-secondary);">${getText('material_reminder', 'Reminder (Hours)')}</label>
                            <input type="number" value="${data.reminder_hours}" onchange="updateMaterialField('${material}', 'reminder_hours', this.value)"
                                   style="width: 100%; padding: 6px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 4px; color: var(--text-primary);">
                        </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(materialDiv);
            });
        }

        function updateMaterialField(material, field, value) {
            if (!filamentMaterialsData[material]) return;
            filamentMaterialsData[material][field] = field.includes('temp') || field.includes('hours') ? parseInt(value) : value;
            updateUnsavedChangesUI();
        }

        function getFilamentMaterials() {
            return filamentMaterialsData;
        }

        // ============ END HELPER FUNCTIONS ============

        // Update Page Texts with Translations
        function updatePageTexts() {
            // Update Page Title
            const pageTitle = document.getElementById('page-title');
            if (pageTitle) {
                pageTitle.textContent = getText('settings', 'Settings') + ' - 3D Printer Dashboard';
            }

            const sidebarTitle = document.getElementById('sidebar-title');
            if (sidebarTitle) {
                sidebarTitle.innerHTML = '‚öôÔ∏è ' + getText('settings', 'Settings');
            }

            // Update Sidebar Categories
            const categories = document.querySelectorAll('.sidebar-category');
            if (categories.length >= 6) {
                categories[0].innerHTML = 'üìã ' + getText('settings_sidebar_category_basis', 'Basis');
                categories[1].innerHTML = 'üñ®Ô∏è ' + getText('settings_sidebar_category_printer', 'Drucker & Hardware');
                categories[2].innerHTML = 'üßµ ' + getText('settings_sidebar_category_filament', 'Filament Management');
                categories[3].innerHTML = 'ü§ñ ' + getText('settings_sidebar_category_automation', 'Automatisierung');
                categories[4].innerHTML = 'üîí ' + getText('settings_sidebar_category_security', 'Sicherheit');
                categories[5].innerHTML = '‚öôÔ∏è ' + getText('settings_sidebar_category_system', 'System & UI');
            }

            // Update Sidebar Items (skip Dashboard item by starting from index 1)
            const allSidebarItems = document.querySelectorAll('.sidebar-item span:not(.sidebar-icon)');
            const itemKeys = [
                'settings_overview',
                'settings_license',
                'settings_mqtt_printer',
                'settings_camera',
                'settings_print_defaults',
                'settings_filament_management',
                'settings_automation',
                'settings_home_assistant',
                'settings_meross',
                'settings_security_ssh',
                'settings_token_management',
                'settings_costs',
                'settings_ui_preferences',
                'settings_debug_tools'
            ];
            // Skip first item (Dashboard) by starting loop at index 1
            for (let i = 1; i < allSidebarItems.length && i - 1 < itemKeys.length; i++) {
                allSidebarItems[i].textContent = getText(itemKeys[i - 1], allSidebarItems[i].textContent);
            }

            // Update Content Title
            const contentTitle = document.getElementById('content-title');
            if (contentTitle && contentTitle.textContent.includes('Overview')) {
                contentTitle.innerHTML = 'üìä ' + getText('settings_overview', 'Overview');
            }

            // Update Section Titles
            const sectionTitles = document.querySelectorAll('.section-title');
            sectionTitles.forEach(title => {
                if (title.textContent === 'System Overview') {
                    title.textContent = getText('settings_system_overview', 'System Overview');
                }
            });

            // Update Overview Labels
            const overviewLabels = document.querySelectorAll('.overview-label');
            overviewLabels.forEach(label => {
                const text = label.textContent.trim();
                if (text === 'Printer Name:') label.textContent = getText('settings_printer_name', 'Printer Name:');
                else if (text === 'Model:') label.textContent = getText('settings_model', 'Model:');
                else if (text === 'IP Address:') label.textContent = getText('settings_ip_address', 'IP Address:');
                else if (text === 'Serial:') label.textContent = getText('settings_serial', 'Serial:');
                else if (text === 'Status:') label.textContent = getText('settings_status', 'Status:');
                else if (text === 'URL:') label.textContent = getText('settings_url', 'URL:');
                else if (text === 'Device:') label.textContent = getText('settings_device', 'Device:');
                else if (text === 'Materials:') label.textContent = getText('settings_materials', 'Materials:');
                else if (text === 'SSH User:') label.textContent = getText('settings_ssh_user', 'SSH User:');
                else if (text === 'CORS Origins:') label.textContent = getText('settings_cors_origins', 'CORS Origins:');
                else if (text === 'Camera Size:') label.textContent = getText('settings_camera_size', 'Camera Size:');
            });

            // Update card headings
            const cardHeadings = document.querySelectorAll('.card h3');
            cardHeadings.forEach(heading => {
                const text = heading.textContent.trim();
                if (text.includes('Printer Information')) {
                    heading.innerHTML = '<span>üñ®Ô∏è</span> ' + getText('settings_printer_information', 'Printer Information');
                } else if (text.includes('Home Assistant')) {
                    heading.innerHTML = '<span>üè†</span> ' + getText('settings_home_assistant_card', 'Home Assistant');
                } else if (text.includes('Meross') && !text.includes('Settings')) {
                    heading.innerHTML = '<span>üîå</span> ' + getText('settings_meross_card', 'Meross');
                } else if (text.includes('Spoolman')) {
                    heading.innerHTML = '<span>üßµ</span> ' + getText('settings_spoolman_card', 'Spoolman');
                } else if (text.includes('Filament Drying')) {
                    heading.innerHTML = '<span>üî•</span> ' + getText('settings_filament_drying_card', 'Filament Drying');
                } else if (text.includes('Additional Settings')) {
                    heading.innerHTML = '<span>‚öôÔ∏è</span> ' + getText('settings_additional_settings', 'Additional Settings');
                }
            });

            // Update overview status texts
            const overviewStatuses = document.querySelectorAll('.overview-status');
            overviewStatuses.forEach(status => {
                const text = status.textContent.trim();
                if (text === 'Connected') {
                    status.textContent = getText('settings_connected', 'Connected');
                } else if (text === 'Not Connected') {
                    status.textContent = getText('settings_not_connected', 'Not Connected');
                } else if (text === 'Enabled') {
                    status.textContent = getText('settings_enabled', 'Enabled');
                } else if (text === 'Disabled') {
                    status.textContent = getText('settings_disabled', 'Disabled');
                }
            });

            // Update License Section
            const licenseTitle = document.getElementById('card-license-title');
            if (licenseTitle) licenseTitle.textContent = getText('settings_license_management', 'License Management');

            const licenseInfo = document.querySelector('#section-license .info-box');
            if (licenseInfo) licenseInfo.innerHTML = '‚ÑπÔ∏è ' + getText('settings_license_info', 'Your license information and activation status');

            const licenseStatusLabel = document.getElementById('license-status-label');
            if (licenseStatusLabel) licenseStatusLabel.textContent = getText('settings_status', 'Status:');

            const licenseTypeLabel = document.getElementById('license-type-label');
            if (licenseTypeLabel) licenseTypeLabel.textContent = getText('settings_license_type_label', 'License Type');

            const licenseCustomerLabel = document.getElementById('license-customer-label');
            if (licenseCustomerLabel) licenseCustomerLabel.textContent = getText('settings_license_customer', 'Customer');

            const licenseExpirationLabel = document.getElementById('license-expiration-label');
            if (licenseExpirationLabel) licenseExpirationLabel.textContent = getText('settings_license_expires', 'Expires');

            const licenseActivatedLabel = document.getElementById('license-activated-label');
            if (licenseActivatedLabel) licenseActivatedLabel.textContent = getText('settings_license_activated_on', 'Activated On');

            const licenseHwidLabel = document.getElementById('license-hwid-label');
            if (licenseHwidLabel) licenseHwidLabel.textContent = getText('settings_license_hwid', 'Hardware ID');

            const btnCopyHwid = document.getElementById('btn-copy-hwid');
            if (btnCopyHwid) btnCopyHwid.innerHTML = 'üìã ' + getText('settings_license_copy', 'Copy');

            const btnDeactivateLicense = document.getElementById('btn-deactivate-license');
            if (btnDeactivateLicense) btnDeactivateLicense.innerHTML = 'üîì ' + getText('settings_license_deactivate', 'Deactivate License');

            const licenseNoLicenseText = document.getElementById('license-no-license-text');
            if (licenseNoLicenseText) licenseNoLicenseText.textContent = getText('settings_license_no_license_text', 'No valid license found. Please activate a license to use the application.');

            const btnActivateLicense = document.getElementById('btn-activate-license');
            if (btnActivateLicense) btnActivateLicense.innerHTML = 'üîê ' + getText('settings_license_activate', 'Activate License');

            // Update MQTT/Printer Section
            const mqttTitle = document.getElementById('card-mqtt-title');
            if (mqttTitle) mqttTitle.textContent = getText('settings_mqtt_printer_title', 'MQTT / Bambu Printer');

            const labelPrinterName = document.getElementById('label-printer-name');
            if (labelPrinterName) labelPrinterName.textContent = getText('settings_printer_name_label', 'Printer Name');

            const labelPrinterModel = document.getElementById('label-printer-model');
            if (labelPrinterModel) labelPrinterModel.textContent = getText('settings_printer_model_label', 'Printer Model');

            // Update ALL Other Section Titles
            const cameraTitle = document.getElementById('card-camera-title');
            if (cameraTitle) cameraTitle.textContent = getText('settings_camera_title', 'Camera Settings');

            const printDefaultsTitle = document.getElementById('card-print-defaults-title');
            if (printDefaultsTitle) printDefaultsTitle.textContent = getText('settings_print_defaults_title', 'Print Defaults');

            const automationTitle = document.getElementById('card-automation-title');
            if (automationTitle) automationTitle.textContent = getText('settings_automation_title', 'Automation');

            const haTitle = document.getElementById('card-ha-title');
            if (haTitle) haTitle.textContent = getText('settings_ha_title', 'Home Assistant');

            const merossTitle = document.getElementById('card-meross-title');
            if (merossTitle) merossTitle.textContent = getText('settings_meross_title', 'Meross Smart Plug');

            const securityTitle = document.getElementById('card-security-title');
            if (securityTitle) securityTitle.textContent = getText('settings_security_title', 'Security & SSH');

            const tokensTitle = document.getElementById('card-token-management-title');
            if (tokensTitle) tokensTitle.textContent = getText('settings_tokens_title', 'Token Management');

            const costsTitle = document.getElementById('card-costs-title');
            if (costsTitle) costsTitle.textContent = getText('settings_costs_title', 'Cost Calculation');

            const uiTitle = document.getElementById('card-ui-title');
            if (uiTitle) uiTitle.textContent = getText('settings_ui_title', 'UI Preferences');

            // Debug Section might not have an ID yet - find it
            const debugSection = document.querySelector('#section-debug .section-title');
            if (debugSection) debugSection.textContent = getText('settings_debug_title', 'Debug Tools');

            // Update ALL Form Labels - MQTT Section
            const labelBambuIp = document.getElementById('label-bambu-ip');
            if (labelBambuIp) labelBambuIp.textContent = getText('settings_bambu_ip_label', 'Bambu IP');

            const labelBambuSerial = document.getElementById('label-bambu-serial');
            if (labelBambuSerial) labelBambuSerial.textContent = getText('settings_bambu_serial_label', 'Serial Number');

            const labelBambuAccessCode = document.getElementById('label-bambu-access-code');
            if (labelBambuAccessCode) labelBambuAccessCode.textContent = getText('settings_bambu_access_code_label', 'Access Code');

            // Update Maintenance Notification Labels
            const labelMaintenanceNotifications = document.getElementById('label-maintenance-notifications');
            if (labelMaintenanceNotifications) labelMaintenanceNotifications.textContent = getText('settings_maintenance_notifications', 'üîî Wartungsmeldungen');

            const labelMaintenanceEnable = document.getElementById('label-maintenance-enable');
            if (labelMaintenanceEnable) labelMaintenanceEnable.textContent = getText('settings_maintenance_enable', 'Wartungsmeldungen aktivieren');

            const labelMaintenanceFrequency = document.getElementById('label-maintenance-frequency');
            if (labelMaintenanceFrequency) labelMaintenanceFrequency.textContent = getText('settings_maintenance_frequency', 'Benachrichtigungsfrequenz');

            const labelMaintenanceStartHour = document.getElementById('label-maintenance-start-hour');
            if (labelMaintenanceStartHour) labelMaintenanceStartHour.textContent = getText('settings_maintenance_start_hour', 'Startzeit (Stunde)');

            const maintenanceNotificationInfo = document.getElementById('maintenance-notification-info');
            if (maintenanceNotificationInfo) maintenanceNotificationInfo.textContent = '‚ÑπÔ∏è ' + getText('settings_maintenance_notification_info', 'Benachrichtigungen werden basierend auf der gew√§hlten Frequenz und Startzeit gesendet. Beispiel: Bei "Alle 6 Stunden" ab 00:00 ‚Üí 00:00, 06:00, 12:00, 18:00');

            // Update Automation Section Labels
            const labelAutoPowerEnable = document.getElementById('label-auto-power-enable');
            if (labelAutoPowerEnable) labelAutoPowerEnable.textContent = getText('settings_auto_power_enable_label', 'Enable Auto Power Off');

            const labelPowerDelay = document.getElementById('label-power-delay');
            if (labelPowerDelay) labelPowerDelay.textContent = getText('settings_power_delay_label', 'After Print (Minutes)');

            const labelPowerIdle = document.getElementById('label-power-idle');
            if (labelPowerIdle) labelPowerIdle.textContent = getText('label_power_idle', 'On Idle (Minutes)');

            const labelAutoLightMqtt = document.getElementById('label-auto-light-mqtt');
            if (labelAutoLightMqtt) labelAutoLightMqtt.textContent = getText('label_auto_light_mqtt', 'Auto Light via MQTT');

            const labelOnlyDarkHours = document.getElementById('label-only-dark-hours');
            if (labelOnlyDarkHours) labelOnlyDarkHours.textContent = getText('label_only_dark_hours', 'Only during dark hours');

            const labelDarkStart = document.getElementById('label-dark-start');
            if (labelDarkStart) labelDarkStart.textContent = getText('label_dark_start', 'Dark starts (Hour)');

            const labelDarkEnd = document.getElementById('label-dark-end');
            if (labelDarkEnd) labelDarkEnd.textContent = getText('label_dark_end', 'Dark ends (Hour)');

            const labelHardwareButtonEnable = document.getElementById('label-hardware-button-enable');
            if (labelHardwareButtonEnable) labelHardwareButtonEnable.textContent = getText('label_hardware_button_enable', 'Enable Hardware Button');

            // Update Camera Section Labels
            const labelCameraEnable = document.getElementById('label-camera-enable');
            if (labelCameraEnable) labelCameraEnable.textContent = getText('label_camera_enable', 'Enable Camera');

            const labelCameraIp = document.getElementById('label-camera-ip');
            if (labelCameraIp) labelCameraIp.textContent = getText('label_camera_ip', 'Pi IP Address');

            const labelCameraPort = document.getElementById('label-camera-port');
            if (labelCameraPort) labelCameraPort.textContent = getText('label_camera_port', 'Port');

            const labelCameraUsername = document.getElementById('label-camera-username');
            if (labelCameraUsername) labelCameraUsername.textContent = getText('label_camera_username', 'Username');

            const labelCameraPassword = document.getElementById('label-camera-password');
            if (labelCameraPassword) labelCameraPassword.textContent = getText('label_camera_password', 'Password');

            // Update Print Defaults Section Labels
            const labelTimelapse = document.getElementById('label-timelapse');
            if (labelTimelapse) labelTimelapse.textContent = getText('label_timelapse', 'üìπ Timelapse');

            const labelUseAms = document.getElementById('label-use-ams');
            if (labelUseAms) labelUseAms.textContent = getText('label_use_ams', 'üé® Use AMS');

            const labelBedLeveling = document.getElementById('label-bed-leveling');
            if (labelBedLeveling) labelBedLeveling.textContent = getText('label_bed_leveling', 'üìè Bed Leveling');

            const labelLayerInspect = document.getElementById('label-layer-inspect');
            if (labelLayerInspect) labelLayerInspect.textContent = getText('label_layer_inspect', 'üëÅÔ∏è Layer Inspect');

            const labelFlowCali = document.getElementById('label-flow-cali');
            if (labelFlowCali) labelFlowCali.textContent = getText('label_flow_cali', 'üåä Flow Calibration');

            const labelVibrationCali = document.getElementById('label-vibration-cali');
            if (labelVibrationCali) labelVibrationCali.textContent = getText('label_vibration_cali', 'üì≥ Vibration Calibration');

            // Update Filament Management Section
            const filamentSectionTitle = document.querySelector('#section-filament .section-title');
            if (filamentSectionTitle) filamentSectionTitle.textContent = getText('filament_section_title', 'üßµ Filament Management');

            const filamentInfoBox = document.querySelector('#section-filament .info-box');
            if (filamentInfoBox) filamentInfoBox.textContent = getText('filament_section_info', 'üßµ Manage your filament tracking with Spoolman and configure drying settings');

            // Update Spoolman Section Labels
            const labelSpoolmanEnable = document.getElementById('label-spoolman-enable');
            if (labelSpoolmanEnable) labelSpoolmanEnable.textContent = getText('label_spoolman_enable', 'Enable Spoolman');

            const labelSpoolmanUrl = document.getElementById('label-spoolman-url');
            if (labelSpoolmanUrl) labelSpoolmanUrl.textContent = getText('label_spoolman_url', 'API URL (Internal)');

            const labelSpoolmanExternal = document.getElementById('label-spoolman-external');
            if (labelSpoolmanExternal) labelSpoolmanExternal.textContent = getText('label_spoolman_external', 'External URL (Browser)');

            const labelSpoolmanThreshold = document.getElementById('label-spoolman-threshold');
            if (labelSpoolmanThreshold) labelSpoolmanThreshold.textContent = getText('label_spoolman_threshold', 'Low Threshold (g)');

            const labelSpoolmanAutoTrack = document.getElementById('label-spoolman-auto-track');
            if (labelSpoolmanAutoTrack) labelSpoolmanAutoTrack.textContent = getText('label_spoolman_auto_track', 'Auto Tracking');

            // Update Filament Drying Section Labels
            const labelFilamentDryingEnable = document.getElementById('label-filament-drying-enable');
            if (labelFilamentDryingEnable) labelFilamentDryingEnable.textContent = getText('label_filament_drying_enable', 'Enable Filament Drying');

            // Update Home Assistant Section Labels
            const labelHaEnable = document.getElementById('label-ha-enable');
            if (labelHaEnable) labelHaEnable.textContent = getText('label_ha_enable', 'Enable Home Assistant');

            const labelHaUrl = document.getElementById('label-ha-url');
            if (labelHaUrl) labelHaUrl.textContent = getText('label_ha_url', 'Home Assistant URL');

            const labelHaToken = document.getElementById('label-ha-token');
            if (labelHaToken) labelHaToken.textContent = getText('label_ha_token', 'Long-Lived Access Token');

            const btnTestHa = document.getElementById('btn-test-ha');
            if (btnTestHa) btnTestHa.innerHTML = 'üß™ ' + getText('btn_test_ha', 'Test Home Assistant');

            // Update Meross Section Labels
            const merossDesc = document.getElementById('meross-desc');
            if (merossDesc) merossDesc.textContent = getText('meross_desc', 'Direct control without Home Assistant');

            const labelMerossEnable = document.getElementById('label-meross-enable');
            if (labelMerossEnable) labelMerossEnable.textContent = getText('label_meross_enable', 'Enable Meross');

            const labelMerossEmail = document.getElementById('label-meross-email');
            if (labelMerossEmail) labelMerossEmail.textContent = getText('label_meross_email', 'Meross Account Email');

            const labelMerossPassword = document.getElementById('label-meross-password');
            if (labelMerossPassword) labelMerossPassword.textContent = getText('label_meross_password', 'Meross Account Password');

            const labelMerossDevice = document.getElementById('label-meross-device');
            if (labelMerossDevice) labelMerossDevice.textContent = getText('label_meross_device', 'Device Name (Optional)');

            const merossDeviceHint = document.getElementById('meross-device-hint');
            if (merossDeviceHint) merossDeviceHint.textContent = getText('meross_device_hint', 'Leave empty to use first device');

            const labelMerossRegion = document.getElementById('label-meross-region');
            if (labelMerossRegion) labelMerossRegion.textContent = getText('label_meross_region', 'API Region');

            const merossRegionHint = document.getElementById('meross-region-hint');
            if (merossRegionHint) merossRegionHint.textContent = getText('meross_region_hint', 'Must match your account region');

            const labelPowerMode = document.getElementById('label-power-mode');
            if (labelPowerMode) labelPowerMode.textContent = getText('label_power_mode', 'Power Control Mode');

            const powerModeHint = document.getElementById('power-mode-hint');
            if (powerModeHint) powerModeHint.textContent = getText('power_mode_hint', 'Choose your power control method');

            // Update Security Section Labels
            const securityInfoBox = document.querySelector('#section-security .info-box');
            if (securityInfoBox) securityInfoBox.textContent = getText('settings_security_info', 'üîí Configure CORS origins, Redis authentication and SSH remote control');

            const corsRedisTitle = document.querySelector('#section-security .card h3');
            if (corsRedisTitle && corsRedisTitle.textContent.includes('CORS')) {
                corsRedisTitle.textContent = getText('settings_cors_redis_title', 'üõ°Ô∏è CORS & Redis Security');
            }

            const labelCorsOrigins = document.getElementById('label-cors-origins');
            if (labelCorsOrigins) labelCorsOrigins.textContent = getText('label_cors_origins', 'CORS Allowed Origins');

            const infoCors = document.getElementById('info-cors');
            if (infoCors) infoCors.textContent = getText('info_cors', 'Define which domains can access the API. Leave empty for auto-detection (local networks only).');

            const labelRedisAuth = document.getElementById('label-redis-auth');
            if (labelRedisAuth) labelRedisAuth.textContent = getText('label_redis_auth', 'Enable Redis Auth');

            const labelRedisPassword = document.getElementById('label-redis-password');
            if (labelRedisPassword) labelRedisPassword.textContent = getText('label_redis_password', 'Redis Password');

            const infoRedisRestart2 = document.getElementById('info-redis-restart');
            if (infoRedisRestart2) infoRedisRestart2.textContent = getText('settings_security_redis_restart', 'Requires server restart to take effect');

            const sshCardTitle = document.getElementById('card-ssh-title');
            if (sshCardTitle) sshCardTitle.textContent = getText('settings_ssh_title', 'üîê SSH Remote Control');

            const infoSsh = document.getElementById('info-ssh');
            if (infoSsh) infoSsh.textContent = getText('info_ssh', 'For server restart via iOS app and remote commands');

            const labelSshUser = document.getElementById('label-ssh-user');
            if (labelSshUser) labelSshUser.textContent = getText('label_ssh_user', 'SSH User');

            const labelSshPassword = document.getElementById('label-ssh-password');
            if (labelSshPassword) labelSshPassword.textContent = getText('label_ssh_password', 'SSH Password');

            // Update Token Management Section - COMPLETE
            const tokenInfoBox = document.getElementById('token-info-box');
            if (tokenInfoBox) {
                tokenInfoBox.innerHTML = '<strong>‚ÑπÔ∏è ' + getText('settings_tokens_title', 'Token Management') + '</strong><br>' +
                    getText('settings_tokens_info_text', 'Here you can manage all registered tokens for FCM notifications, Live Activities and registered devices and remove them if needed.');
            }

            const btnRefreshTokens = document.getElementById('btn-refresh-tokens');
            if (btnRefreshTokens) {
                btnRefreshTokens.innerHTML = 'üîÑ ' + getText('settings_tokens_refresh', 'Refresh');
            }

            const tokensLoadingText = document.querySelector('#tokens-loading-state p');
            if (tokensLoadingText) {
                tokensLoadingText.textContent = getText('settings_tokens_loading', 'Loading token data...');
            }

            const sectionDevicesTitle = document.getElementById('section-devices-title');
            if (sectionDevicesTitle) sectionDevicesTitle.innerHTML = 'üì± ' + getText('settings_tokens_devices_title', 'Registered Devices');

            const sectionSessionsTitle = document.getElementById('section-sessions-title');
            if (sectionSessionsTitle) sectionSessionsTitle.innerHTML = 'üåê ' + getText('settings_tokens_sessions_title', 'Web Sessions (Browser)');

            const sectionFcmTitle = document.getElementById('section-fcm-title');
            if (sectionFcmTitle) sectionFcmTitle.innerHTML = 'üîî ' + getText('settings_tokens_fcm_title', 'FCM Tokens (Push Notifications)');

            const sectionLaTitle = document.getElementById('section-la-title');
            if (sectionLaTitle) sectionLaTitle.innerHTML = 'üìä ' + getText('settings_tokens_la_title', 'Live Activity Tokens (iOS)');

            const sectionLasTitle = document.getElementById('section-las-title');
            if (sectionLasTitle) sectionLasTitle.innerHTML = 'üöÄ ' + getText('settings_tokens_las_title', 'Live Activity Start Tokens (iOS)');

            const sectionOrphanedTitle = document.getElementById('section-orphaned-title');
            if (sectionOrphanedTitle) sectionOrphanedTitle.innerHTML = '‚ö†Ô∏è ' + getText('settings_tokens_orphaned_title', 'Orphaned Tokens');

            const orphanedDesc = document.getElementById('orphaned-token-desc');
            if (orphanedDesc) orphanedDesc.textContent = getText('settings_tokens_orphaned_desc', 'Refresh tokens without associated session (can be deleted)');

            // Update Session Status Legend
            const legendStatusActive = document.getElementById('legend-status-active');
            if (legendStatusActive) legendStatusActive.textContent = getText('settings_status_active', 'Active');

            const legendStatusIdle = document.getElementById('legend-status-idle');
            if (legendStatusIdle) legendStatusIdle.textContent = getText('settings_status_idle', 'Idle');

            const legendStatusInactive = document.getElementById('legend-status-inactive');
            if (legendStatusInactive) legendStatusInactive.textContent = getText('settings_status_inactive', 'Inactive');

            const legendStatusOrphaned = document.getElementById('legend-status-orphaned');
            if (legendStatusOrphaned) legendStatusOrphaned.textContent = getText('settings_status_orphaned', 'Orphaned');

            const legendStatusActiveDesc = document.getElementById('legend-status-active-desc');
            if (legendStatusActiveDesc) legendStatusActiveDesc.textContent = getText('settings_status_active_desc', 'With valid token');

            const legendStatusIdleDesc = document.getElementById('legend-status-idle-desc');
            if (legendStatusIdleDesc) legendStatusIdleDesc.textContent = getText('settings_status_idle_desc', '>30 min inactive');

            const legendStatusInactiveDesc = document.getElementById('legend-status-inactive-desc');
            if (legendStatusInactiveDesc) legendStatusInactiveDesc.textContent = getText('settings_status_inactive_desc', 'Token expired');

            const legendStatusOrphanedDesc = document.getElementById('legend-status-orphaned-desc');
            if (legendStatusOrphanedDesc) legendStatusOrphanedDesc.textContent = getText('settings_status_orphaned_desc', 'Orphaned session');

            // Update Costs Section Labels
            const labelFilamentCost = document.getElementById('label-filament-cost');
            if (labelFilamentCost) labelFilamentCost.textContent = getText('settings_costs_filament_label', 'Filament Cost (‚Ç¨/kg)');

            const labelPowerCost = document.getElementById('label-power-cost');
            if (labelPowerCost) labelPowerCost.textContent = getText('settings_costs_power_label', 'Power Cost (‚Ç¨/kWh)');

            // Update UI Preferences Labels
            const labelCameraSize = document.getElementById('label-camera-size');
            if (labelCameraSize) labelCameraSize.textContent = getText('settings_ui_camera_size_label', 'Default Camera Size');

            const optionCameraSmall = document.getElementById('option-camera-small');
            if (optionCameraSmall) optionCameraSmall.textContent = getText('settings_ui_camera_small', 'Small (1x)');

            const optionCameraMedium = document.getElementById('option-camera-medium');
            if (optionCameraMedium) optionCameraMedium.textContent = getText('settings_ui_camera_medium', 'Medium (2x)');

            const optionCameraLarge = document.getElementById('option-camera-large');
            if (optionCameraLarge) optionCameraLarge.textContent = getText('settings_ui_camera_large', 'Large (3x)');

            // Update Debug Tools Section
            const hmsTestTitle = document.getElementById('hms-code-test-title');
            if (hmsTestTitle) hmsTestTitle.innerHTML = 'üß™ ' + getText('settings_debug_hms_test_title', 'HMS Code Test');

            const hmsInput = document.getElementById('hms-code-input');
            if (hmsInput) hmsInput.placeholder = getText('settings_debug_hms_placeholder', 'e.g. 0700-0300-0002-0002');

            const btnTestHms = document.getElementById('btn-test-hms');
            if (btnTestHms) btnTestHms.innerHTML = 'üß™ ' + getText('settings_debug_test_hms', 'Test HMS');

            const btnHmsError = document.getElementById('btn-hms-error');
            if (btnHmsError) btnHmsError.innerHTML = '‚ö†Ô∏è ' + getText('settings_debug_hms_error', 'Error');

            const btnHmsFilament = document.getElementById('btn-hms-filament');
            if (btnHmsFilament) btnHmsFilament.innerHTML = '‚ÑπÔ∏è ' + getText('settings_debug_hms_filament', 'Filament Change');

            const btnHmsAms = document.getElementById('btn-hms-ams');
            if (btnHmsAms) btnHmsAms.innerHTML = '‚ÑπÔ∏è ' + getText('settings_debug_hms_ams', 'AMS');

            const btnTestConnection = document.getElementById('btn-test-connection');
            if (btnTestConnection) btnTestConnection.innerHTML = 'üîå ' + getText('settings_debug_test_connection', 'Test Connection');

            const btnRestartServer = document.getElementById('btn-restart-server');
            if (btnRestartServer) btnRestartServer.innerHTML = 'üîÑ ' + getText('settings_debug_restart_server', 'Restart Server');

            // Update Filament Drying Additional Labels
            const labelParkingPosition = document.getElementById('label-parking-position');
            if (labelParkingPosition) labelParkingPosition.textContent = getText('settings_filament_parking_position', 'Parking Position');

            const labelParkingX = document.getElementById('label-parking-x');
            if (labelParkingX) labelParkingX.textContent = getText('settings_filament_parking_x', 'X Position');

            const labelParkingY = document.getElementById('label-parking-y');
            if (labelParkingY) labelParkingY.textContent = getText('settings_filament_parking_y', 'Y Position');

            const labelParkingZ = document.getElementById('label-parking-z');
            if (labelParkingZ) labelParkingZ.textContent = getText('settings_filament_parking_z', 'Z Position');

            const labelMaterialSettings = document.getElementById('label-material-settings');
            if (labelMaterialSettings) labelMaterialSettings.textContent = getText('settings_filament_material_settings', 'Material Settings');

            // Update Security Section Additional Labels
            const btnAddCors = document.getElementById('btn-add-cors');
            if (btnAddCors) btnAddCors.innerHTML = '+ ' + getText('settings_cors_add', 'Add');

            const infoRedisRestart = document.getElementById('info-redis-restart');
            if (infoRedisRestart) infoRedisRestart.textContent = getText('settings_security_redis_restart', 'Requires server restart to take effect');

            // Update ALL labels by searching for common patterns
            document.querySelectorAll('label').forEach(label => {
                const text = label.textContent.trim();

                // Common button texts
                if (text === 'Save' || text === 'Speichern') label.textContent = getText('settings_save', 'Save');
                else if (text === 'Test Connection') label.textContent = getText('settings_test_connection', 'Test Connection');
                else if (text === 'Cancel') label.textContent = getText('settings_cancel', 'Cancel');
                else if (text === 'Delete') label.textContent = getText('settings_delete', 'Delete');
                else if (text === 'Edit') label.textContent = getText('settings_edit', 'Edit');
                else if (text === 'Add') label.textContent = getText('settings_add', 'Add');
            });
        }

        // Android App Back Button Support
        document.addEventListener('DOMContentLoaded', function() {
            // Render Sidebar
            if (window.sidebarManager) {
                window.sidebarManager.render();
            }

            // Update theme icons to show current state
            if (window.themeManager) {
                window.themeManager.updateIcons();
            }

            // Apply translations (language files are already loaded synchronously in <head>)
            updatePageTexts();

            // Initialize Printer Gallery
            initPrinterGallery();

            // Add event listeners for changes
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', trackChanges);
                input.addEventListener('input', trackChanges);
            });

            // Load settings and license info
            loadSettings();
            loadLicenseInfo();

            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.get('app') === 'android') {
                const backButton = document.getElementById('back-btn');
                if (backButton) {
                    backButton.href = "javascript:void(0);";
                    backButton.onclick = function(event) {
                        event.preventDefault();
                        if (window.Android && typeof window.Android.goBackToDashboard === 'function') {
                            window.Android.goBackToDashboard();
                        } else {
                            window.location.href = '/?app=android';
                        }
                    };
                }
            }
        });

        // Periodic license status checking
        let licenseCheckInterval = null;

        function checkLicenseStatus() {
            fetch('/license/api/check', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    console.warn('License became invalid - redirecting to activation page');
                    if (licenseCheckInterval) {
                        clearInterval(licenseCheckInterval);
                    }
                    window.location.href = '/license/activate';
                }
            })
            .catch(error => {
                console.error('Error checking license status:', error);
            });
        }

        // Start periodic checking when page loads
        setTimeout(checkLicenseStatus, 5000);
        licenseCheckInterval = setInterval(checkLicenseStatus, 60000);

        // WebSocket Verbindung f√ºr Notifications (z.B. HMS Test)
        (function() {
            // Socket.IO Verbindung aufbauen
            const socket = io({
                transports: ['polling'],
                upgrade: false,
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000,
                forceNew: true
            });

            // Socket global verf√ºgbar machen f√ºr cleanup
            window.settingsSocket = socket;

            socket.on('connect', function() {
                console.log('‚úÖ Settings: WebSocket verbunden');
            });

            socket.on('disconnect', function() {
                console.log('‚ùå Settings: WebSocket getrennt');
            });

            // Notification Listener f√ºr HMS Test etc.
            socket.on('notification', function(data) {
                console.log('üì¨ Settings: Notification empfangen:', data);

                // Toast-Notification anzeigen
                const isError = data.type === 'hms_error' || data.type === 'error' || data.type === 'print_failed';
                const toastMessage = `${data.title}\n${data.message}`;

                if (isError) {
                    showError(toastMessage);
                } else {
                    showSuccess(toastMessage);
                }

                // Optional: Browser-Notification wenn Berechtigung vorhanden
                if ('Notification' in window && Notification.permission === 'granted') {
                    const options = {
                        body: data.message,
                        icon: '/static/icon-192x192.png',
                        tag: data.type || 'general'
                    };

                    // HMS Errors mit st√§rkerer Vibration
                    if (data.type === 'hms_error') {
                        options.requireInteraction = true;
                        options.vibrate = [500, 200, 500, 200, 500];
                    }

                    new Notification(data.title, options);
                }
            });
        })();

        // ============ TOKEN MANAGEMENT FUNCTIONS ============

        // Load all tokens when token section is opened
        async function loadAllTokens() {
            try {
                document.getElementById('tokens-loading-state').style.display = 'block';
                document.getElementById('device-tokens-section').style.display = 'none';
                document.getElementById('web-sessions-section').style.display = 'none';
                document.getElementById('fcm-tokens-section').style.display = 'none';
                document.getElementById('la-tokens-section').style.display = 'none';
                document.getElementById('las-tokens-section').style.display = 'none';
                document.getElementById('orphaned-tokens-section').style.display = 'none';

                // Load Device Tokens
                await loadDeviceTokens();

                // Load Web Sessions
                await loadWebSessions();

                // Load FCM, Live Activity, and Live Activity Start Tokens
                await loadNotificationTokens();

                // Load Orphaned Tokens
                await loadOrphanedTokens();

                document.getElementById('tokens-loading-state').style.display = 'none';
            } catch (error) {
                console.error('Error loading tokens:', error);
                document.getElementById('tokens-loading-state').style.display = 'none';
                showError('Fehler beim Laden der Tokens');
            }
        }

        // Load Device Tokens
        async function loadDeviceTokens() {
            try {
                const response = await apiCall('/api/auth/devices');
                if (!response.ok) throw new Error('Failed to load device tokens');

                const devices = await response.json();
                const container = document.getElementById('device-tokens-list');
                const section = document.getElementById('device-tokens-section');
                const count = document.getElementById('device-token-count');

                container.innerHTML = '';
                count.textContent = devices.length;

                if (devices.length > 0) {
                    section.style.display = 'block';

                    devices.forEach(device => {
                        const card = document.createElement('div');
                        card.className = 'token-card';
                        card.innerHTML = `
                            <div class="token-header">
                                <div style="display: flex; align-items: flex-start; flex: 1;">
                                    <div class="token-icon">${device.device_type === 'ios' ? 'üì±' : 'ü§ñ'}</div>
                                    <div class="token-info">
                                        <div class="token-label">Device Name</div>
                                        <div class="token-value" style="font-size: 15px; font-family: inherit;">${device.device_name || 'Unknown'}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="token-details">
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Platform:</span>
                                    <span class="platform-badge platform-${device.device_type}">${device.device_type.toUpperCase()}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Model:</span>
                                    <span class="token-detail-value">${device.device_model || 'Unknown'}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Device ID:</span>
                                    <span class="token-detail-value" style="font-family: monospace; font-size: 11px;">${device.device_id.substring(0, 20)}...</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Erstellt:</span>
                                    <span class="token-detail-value">${formatTokenDate(device.created)}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Zuletzt verwendet:</span>
                                    <span class="token-detail-value">${formatTokenDate(device.last_used)}</span>
                                </div>
                            </div>
                            <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="deleteDeviceToken('${device.device_id}')">
                                üóëÔ∏è Ger√§t entfernen
                            </button>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    section.style.display = 'block';
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì±</div><p>Keine Ger√§te registriert</p></div>';
                }
            } catch (error) {
                console.error('Error loading device tokens:', error);
            }
        }

        // Load Web Sessions
        async function loadWebSessions() {
            try {
                const response = await apiCall('/api/auth/sessions/all');
                if (!response.ok) throw new Error('Failed to load web sessions');

                const data = await response.json();
                const container = document.getElementById('web-sessions-list');
                const section = document.getElementById('web-sessions-section');
                const count = document.getElementById('web-sessions-count');

                container.innerHTML = '';
                count.textContent = data.total || 0;

                if (data.sessions && data.sessions.length > 0) {
                    section.style.display = 'block';

                    data.sessions.forEach(session => {
                        const card = document.createElement('div');
                        card.className = 'token-card';

                        // Status-spezifische Icons und Texte
                        const statusConfig = {
                            'active': { icon: '‚úÖ', text: getText('settings_status_active', 'Active') },
                            'idle': { icon: '‚è∏Ô∏è', text: getText('settings_status_idle', 'Idle') },
                            'inactive': { icon: '‚èπÔ∏è', text: getText('settings_status_inactive', 'Inactive') },
                            'orphaned': { icon: '‚ö†Ô∏è', text: getText('settings_status_orphaned', 'Orphaned') }
                        };

                        const config = statusConfig[session.status] || statusConfig.inactive;

                        card.innerHTML = `
                            <div class="token-header">
                                <div style="display: flex; align-items: flex-start; flex: 1;">
                                    <div class="token-icon">üåê</div>
                                    <div class="token-info">
                                        <div class="token-label">Browser Session</div>
                                        <div class="token-value" style="font-size: 15px; font-family: inherit;">${session.device_name || 'Unknown Browser'}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="token-details">
                                <div class="token-detail-row">
                                    <span class="token-detail-label">User:</span>
                                    <span class="token-detail-value">${session.username}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Status:</span>
                                    <span class="status-badge status-${session.status}">${config.icon} ${config.text}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Session ID:</span>
                                    <span class="token-detail-value" style="font-family: monospace; font-size: 11px;">${session.session_id.substring(0, 20)}...</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Erstellt:</span>
                                    <span class="token-detail-value">${formatTokenDate(session.created)} ${session.age_days !== null ? `(${session.age_days}d alt)` : ''}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Zuletzt verwendet:</span>
                                    <span class="token-detail-value">${formatTokenDate(session.last_used)} ${session.inactive_minutes !== null && session.inactive_minutes > 0 ? `(vor ${session.inactive_minutes} Min)` : ''}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Tokens:</span>
                                    <span class="token-detail-value">
                                        ${session.has_refresh_token ? 'üîë' : '‚ùå'} Refresh
                                        ${session.has_access_token ? 'üîë' : '‚ùå'} Access
                                    </span>
                                </div>
                            </div>
                            <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="deleteWebSession('${session.session_id}')">
                                üóëÔ∏è Session l√∂schen
                            </button>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    section.style.display = 'block';
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üåê</div><p>Keine Web-Sessions gefunden</p></div>';
                }
            } catch (error) {
                console.error('Error loading web sessions:', error);
            }
        }

        // Load Orphaned Tokens
        async function loadOrphanedTokens() {
            try {
                const response = await apiCall('/api/auth/debug/tokens');
                if (!response.ok) throw new Error('Failed to load orphaned tokens');

                const data = await response.json();
                const orphanedTokens = data.orphaned_tokens || [];

                const container = document.getElementById('orphaned-tokens-list');
                const section = document.getElementById('orphaned-tokens-section');
                const count = document.getElementById('orphaned-token-count');

                container.innerHTML = '';
                count.textContent = orphanedTokens.length;

                if (orphanedTokens.length > 0) {
                    section.style.display = 'block';

                    orphanedTokens.forEach(token => {
                        const card = document.createElement('div');
                        card.className = 'token-card';
                        card.innerHTML = `
                            <div class="token-header">
                                <div style="display: flex; align-items: flex-start; flex: 1;">
                                    <div class="token-icon">‚ö†Ô∏è</div>
                                    <div class="token-info">
                                        <div class="token-label">Orphaned Refresh Token</div>
                                        <div class="token-value" style="font-family: monospace; font-size: 12px;">${token.jti}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="token-details">
                                <div class="token-detail-row">
                                    <span class="token-detail-label">User:</span>
                                    <span class="token-detail-value">${token.username}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">Session:</span>
                                    <span class="token-detail-value">${token.has_session ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                                <div class="token-detail-row">
                                    <span class="token-detail-label">In User List:</span>
                                    <span class="token-detail-value">${token.in_user_list ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                            </div>
                            <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="deleteOrphanedToken('${token.jti}')">
                                üóëÔ∏è Token l√∂schen
                            </button>
                        `;
                        container.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error loading orphaned tokens:', error);
            }
        }

        // Load Notification Tokens (FCM, Live Activity, Live Activity Start)
        async function loadNotificationTokens() {
            try {
                const response = await apiCall('/api/tokens/list');
                if (!response.ok) throw new Error('Failed to load notification tokens');

                const data = await response.json();

                // FCM Tokens
                renderFCMTokens(data.fcm_tokens);

                // Live Activity Tokens
                renderLiveActivityTokens(data.live_activity_tokens);

                // Live Activity Start Tokens
                renderLiveActivityStartTokens(data.live_activity_start_tokens);

            } catch (error) {
                console.error('Error loading notification tokens:', error);
            }
        }

        // Format Date Helper Function
        function formatDate(dateString) {
            if (!dateString || dateString === 'unknown') return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;

            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Heute';
            if (days === 1) return 'Gestern';
            if (days < 7) return `vor ${days} Tagen`;

            return date.toLocaleDateString('de-DE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // Render FCM Tokens
        function renderFCMTokens(tokens) {
            const container = document.getElementById('fcm-tokens-list');
            const section = document.getElementById('fcm-tokens-section');
            const count = document.getElementById('fcm-token-count');

            container.innerHTML = '';
            count.textContent = tokens.length;

            if (tokens.length > 0) {
                section.style.display = 'block';

                tokens.forEach(token => {
                    const card = document.createElement('div');
                    card.className = 'token-card';

                    // Icon basierend auf Platform
                    const icon = token.platform === 'ios' ? 'üì±' : 'ü§ñ';

                    card.innerHTML = `
                        <div class="token-header">
                            <div style="display: flex; align-items: flex-start; flex: 1;">
                                <div class="token-icon">${icon}</div>
                                <div class="token-info">
                                    <div class="token-label">FCM Push Token</div>
                                    <div class="token-value">${token.token}</div>
                                </div>
                            </div>
                        </div>
                        <div class="token-details">
                            <div class="token-detail-row">
                                <span class="token-detail-label">Platform:</span>
                                <span class="platform-badge platform-${token.platform}">${token.platform.toUpperCase()}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Device:</span>
                                <span class="token-detail-value">${token.device_name || 'Unknown'}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Model:</span>
                                <span class="token-detail-value">${token.device_model || 'Unknown Device'}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">HMS Sound:</span>
                                <span class="token-detail-value">${token.hms_sound ? '‚úÖ' : '‚ùå'}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Registriert:</span>
                                <span class="token-detail-value">${formatDate(token.registered_at)}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="deleteFCMToken('${token.full_token}')">
                            üóëÔ∏è Token l√∂schen
                        </button>
                    `;
                    container.appendChild(card);
                });
            } else {
                section.style.display = 'block';
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîî</div><p>Keine FCM Tokens registriert</p></div>';
            }
        }

        // Render Live Activity Tokens
        function renderLiveActivityTokens(tokens) {
            const container = document.getElementById('la-tokens-list');
            const section = document.getElementById('la-tokens-section');
            const count = document.getElementById('la-token-count');

            container.innerHTML = '';
            count.textContent = tokens.length;

            if (tokens.length > 0) {
                section.style.display = 'block';

                tokens.forEach(token => {
                    const card = document.createElement('div');
                    card.className = 'token-card';
                    card.innerHTML = `
                        <div class="token-header">
                            <div style="display: flex; align-items: flex-start; flex: 1;">
                                <div class="token-icon">üìä</div>
                                <div class="token-info">
                                    <div class="token-label">Live Activity Token</div>
                                    <div class="token-value">${token.token}</div>
                                </div>
                            </div>
                        </div>
                        <div class="token-details">
                            <div class="token-detail-row">
                                <span class="token-detail-label">Device:</span>
                                <span class="token-detail-value">${token.device_name}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Model:</span>
                                <span class="token-detail-value">${token.device_model}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Environment:</span>
                                <span class="token-detail-value">${token.environment}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Registriert:</span>
                                <span class="token-detail-value">${formatTokenDate(token.registered_at)}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="deleteLiveActivityToken('${token.full_token}')">
                            üóëÔ∏è Token l√∂schen
                        </button>
                    `;
                    container.appendChild(card);
                });
            } else {
                section.style.display = 'block';
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><p>Keine Live Activity Tokens registriert</p></div>';
            }
        }

        // Render Live Activity Start Tokens
        function renderLiveActivityStartTokens(tokens) {
            const container = document.getElementById('las-tokens-list');
            const section = document.getElementById('las-tokens-section');
            const count = document.getElementById('las-token-count');

            container.innerHTML = '';
            count.textContent = tokens.length;

            if (tokens.length > 0) {
                section.style.display = 'block';

                tokens.forEach(token => {
                    const card = document.createElement('div');
                    card.className = 'token-card';
                    card.innerHTML = `
                        <div class="token-header">
                            <div style="display: flex; align-items: flex-start; flex: 1;">
                                <div class="token-icon">üöÄ</div>
                                <div class="token-info">
                                    <div class="token-label">Live Activity Start Token</div>
                                    <div class="token-value">${token.token}</div>
                                </div>
                            </div>
                        </div>
                        <div class="token-details">
                            <div class="token-detail-row">
                                <span class="token-detail-label">Device:</span>
                                <span class="token-detail-value">${token.device_name}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Model:</span>
                                <span class="token-detail-value">${token.device_model}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Environment:</span>
                                <span class="token-detail-value">${token.environment}</span>
                            </div>
                            <div class="token-detail-row">
                                <span class="token-detail-label">Registriert:</span>
                                <span class="token-detail-value">${formatTokenDate(token.registered_at)}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 12px;" onclick="deleteLiveActivityStartToken('${token.full_token}')">
                            üóëÔ∏è Token l√∂schen
                        </button>
                    `;
                    container.appendChild(card);
                });
            } else {
                section.style.display = 'block';
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöÄ</div><p>Keine Live Activity Start Tokens registriert</p></div>';
            }
        }

        // Delete Functions
        async function deleteDeviceToken(deviceId) {
            if (!confirm('M√∂chtest du dieses Ger√§t wirklich entfernen?')) return;

            try {
                const response = await apiCall(`/api/auth/device/${deviceId}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('‚úÖ Ger√§t erfolgreich entfernt');
                    await loadAllTokens();
                } else {
                    showError('‚ùå Fehler beim Entfernen des Ger√§ts');
                }
            } catch (error) {
                console.error('Error deleting device:', error);
                showError('‚ùå Fehler beim Entfernen des Ger√§ts');
            }
        }

        async function deleteWebSession(sessionId) {
            if (!confirm('M√∂chtest du diese Web-Session wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/auth/sessions/${sessionId}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('‚úÖ Web-Session erfolgreich gel√∂scht');
                    await loadAllTokens();
                } else {
                    showError('‚ùå Fehler beim L√∂schen der Session');
                }
            } catch (error) {
                console.error('Error deleting web session:', error);
                showError('‚ùå Fehler beim L√∂schen der Session');
            }
        }

        async function deleteFCMToken(token) {
            if (!confirm('M√∂chtest du diesen FCM Token wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/tokens/fcm/${encodeURIComponent(token)}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('‚úÖ FCM Token erfolgreich gel√∂scht');
                    await loadAllTokens();
                } else {
                    showError('‚ùå Fehler beim L√∂schen des FCM Tokens');
                }
            } catch (error) {
                console.error('Error deleting FCM token:', error);
                showError('‚ùå Fehler beim L√∂schen des FCM Tokens');
            }
        }

        async function deleteLiveActivityToken(token) {
            if (!confirm('M√∂chtest du diesen Live Activity Token wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/tokens/live_activity/${encodeURIComponent(token)}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('‚úÖ Live Activity Token erfolgreich gel√∂scht');
                    await loadAllTokens();
                } else {
                    showError('‚ùå Fehler beim L√∂schen des Live Activity Tokens');
                }
            } catch (error) {
                console.error('Error deleting Live Activity token:', error);
                showError('‚ùå Fehler beim L√∂schen des Live Activity Tokens');
            }
        }

        async function deleteLiveActivityStartToken(token) {
            if (!confirm('M√∂chtest du diesen Live Activity Start Token wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/tokens/live_activity_start/${encodeURIComponent(token)}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('‚úÖ Live Activity Start Token erfolgreich gel√∂scht');
                    await loadAllTokens();
                } else {
                    showError('‚ùå Fehler beim L√∂schen des Live Activity Start Tokens');
                }
            } catch (error) {
                console.error('Error deleting Live Activity Start token:', error);
                showError('‚ùå Fehler beim L√∂schen des Live Activity Start Tokens');
            }
        }

        async function deleteOrphanedToken(jti) {
            if (!confirm('M√∂chtest du diesen Token wirklich l√∂schen?')) return;

            try {
                const response = await apiCall(`/api/auth/tokens/orphaned/${jti}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('‚úÖ Token erfolgreich gel√∂scht');
                    await loadAllTokens();
                } else {
                    showError('‚ùå Fehler beim L√∂schen des Tokens');
                }
            } catch (error) {
                console.error('Error deleting orphaned token:', error);
                showError('‚ùå Fehler beim L√∂schen des Tokens');
            }
        }

        // Format Date for Token Management
        function formatTokenDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;

            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'Heute';
            if (days === 1) return 'Gestern';
            if (days < 7) return `vor ${days} Tagen`;

            return date.toLocaleDateString('de-DE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ============ END TOKEN MANAGEMENT FUNCTIONS ============

        // ============ DASHBOARD RESET FUNCTION ============
        function resetDashboardLayoutFromSettings() {
            if (confirm('‚ö†Ô∏è M√∂chtest du das Dashboard-Layout wirklich auf die Standardeinstellungen zur√ºcksetzen?\n\nAlle deine Dashboard-Anpassungen (Kartenpositionen und -gr√∂√üen) gehen verloren.')) {
                // L√∂sche Layout-Einstellungen aus localStorage (korrekter Key mit Bindestrich)
                localStorage.removeItem('dashboard-layout');

                // Zeige Erfolgs-Nachricht
                showSuccess('‚úÖ Dashboard-Layout wurde zur√ºckgesetzt. Die √Ñnderungen werden beim n√§chsten Dashboard-Besuch aktiv.');

                console.log('üîÑ Dashboard layout reset from Settings');
            }
        }
        // ============ END DASHBOARD RESET FUNCTION ============

        // ============ BAMBU CAMERA STATUS & RESTART ============
        let bambuStatusInterval = null;

        async function loadBambuCameraStatus() {
            try {
                const response = await apiCall('/api/camera/status');
                if (!response.ok) {
                    throw new Error('Failed to load camera status');
                }

                const data = await response.json();

                if (data.success) {
                    const status = data.status;
                    const diagnosis = data.diagnosis;

                    // Status message with color (use translated messages ONLY)
                    const statusEl = document.getElementById('bambu-status-message');
                    let statusText = '';
                    if (diagnosis.frozen) {
                        statusText = texts.bambu_status_frozen || 'Kamera-Thread eingefroren';
                        statusEl.style.color = '#ff6b6b'; // Red for frozen
                    } else if (!status.thread_alive) {
                        statusText = texts.bambu_status_not_running || 'Kamera-Thread l√§uft nicht';
                        statusEl.style.color = '#ff6b6b'; // Red
                    } else if (status.frame_count > 0) {
                        statusText = texts.bambu_status_working || 'Kamera funktioniert normal';
                        statusEl.style.color = '#51cf66'; // Green for working
                    } else {
                        statusText = texts.bambu_status_starting || 'Kamera gestartet';
                        statusEl.style.color = '#ffd43b'; // Yellow for starting
                    }
                    statusEl.textContent = statusText;

                    // Frame count
                    document.getElementById('bambu-frame-count').textContent = status.frame_count || 0;

                    // FPS
                    document.getElementById('bambu-fps').textContent = status.fps ? status.fps.toFixed(2) : '0.00';

                    // Last frame time (use translated time strings)
                    const lastFrameEl = document.getElementById('bambu-last-frame');
                    if (status.time_since_frame_seconds !== null) {
                        const seconds = Math.floor(status.time_since_frame_seconds);
                        if (seconds < 60) {
                            lastFrameEl.textContent = (texts.bambu_time_ago_seconds || 'vor {0}s').replace('{0}', seconds);
                        } else if (seconds < 3600) {
                            const minutes = Math.floor(seconds / 60);
                            lastFrameEl.textContent = (texts.bambu_time_ago_minutes || 'vor {0}m').replace('{0}', minutes);
                        } else {
                            const hours = Math.floor(seconds / 3600);
                            const minutes = Math.floor((seconds % 3600) / 60);
                            lastFrameEl.textContent = (texts.bambu_time_ago_hours || 'vor {0}h {1}m').replace('{0}', hours).replace('{1}', minutes);
                        }

                        // Color based on timeout
                        if (status.timeout_exceeded) {
                            lastFrameEl.style.color = '#ff6b6b';
                        } else {
                            lastFrameEl.style.color = 'var(--text-primary)';
                        }
                    } else {
                        lastFrameEl.textContent = texts.bambu_time_never || 'Nie';
                        lastFrameEl.style.color = 'var(--text-secondary)';
                    }

                    // Thread status (use translated strings)
                    const threadEl = document.getElementById('bambu-thread-status');
                    if (status.thread_alive) {
                        threadEl.textContent = texts.bambu_thread_running || '‚úì L√§uft';
                        threadEl.style.color = '#51cf66';
                    } else {
                        threadEl.textContent = texts.bambu_thread_stopped || '‚úó Gestoppt';
                        threadEl.style.color = '#ff6b6b';
                    }
                } else {
                    document.getElementById('bambu-status-message').textContent = data.error || texts.bambu_connection_error || 'Fehler beim Laden';
                    document.getElementById('bambu-status-message').style.color = '#ff6b6b';
                }
            } catch (error) {
                console.error('Error loading Bambu camera status:', error);
                document.getElementById('bambu-status-message').textContent = texts.bambu_connection_error || 'Verbindungsfehler';
                document.getElementById('bambu-status-message').style.color = '#ff6b6b';
            }
        }

        async function restartBambuCamera() {
            const btn = document.getElementById('bambu-restart-btn');
            const btnSpan = document.getElementById('label-bambu-restart-btn');
            const msg = document.getElementById('bambu-restart-message');

            btn.disabled = true;
            btnSpan.textContent = texts.label_bambu_restarting || 'üîÑ Starte neu...';
            msg.textContent = '';

            try {
                const response = await apiCall('/api/camera/restart', { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.success) {
                    msg.textContent = texts.bambu_restart_success || '‚úÖ Stream erfolgreich neu gestartet';
                    msg.style.color = '#51cf66';

                    // Reload status immediately
                    setTimeout(() => loadBambuCameraStatus(), 1000);
                } else {
                    msg.textContent = (texts.bambu_restart_error || '‚ùå Fehler beim Neustarten') + (data.error ? ': ' + data.error : '');
                    msg.style.color = '#ff6b6b';
                }
            } catch (error) {
                console.error('Error restarting camera:', error);
                msg.textContent = texts.bambu_connection_error || '‚ùå Verbindungsfehler';
                msg.style.color = '#ff6b6b';
            } finally {
                btn.disabled = false;
                btnSpan.textContent = texts.label_bambu_restart_btn || 'üîÑ Stream neu starten';

                // Clear message after 5 seconds
                setTimeout(() => {
                    msg.textContent = '';
                }, 5000);
            }
        }

        // Auto-refresh camera status when on camera section
        function startBambuStatusRefresh() {
            loadBambuCameraStatus(); // Load immediately
            bambuStatusInterval = setInterval(loadBambuCameraStatus, 5000); // Then every 5s
        }

        function stopBambuStatusRefresh() {
            if (bambuStatusInterval) {
                clearInterval(bambuStatusInterval);
                bambuStatusInterval = null;
            }
        }

        // Start refresh when camera section is visible
        // (Hook into existing section switching logic)
        const originalShowSection = window.showSection;
        window.showSection = function(sectionId) {
            if (originalShowSection) {
                originalShowSection(sectionId);
            }

            // Start/stop camera status refresh
            if (sectionId === 'section-camera') {
                startBambuStatusRefresh();
            } else {
                stopBambuStatusRefresh();
            }
        };

        // Initialize Bambu Camera labels with translations
        function initBambuCameraLabels() {
            // Apply translations to all labels
            const labelTitle = document.getElementById('label-bambu-camera-title');
            const labelStatus = document.getElementById('label-bambu-status');
            const labelFrameCount = document.getElementById('label-bambu-frame-count');
            const labelLastFrame = document.getElementById('label-bambu-last-frame');
            const labelThread = document.getElementById('label-bambu-thread');
            const labelRestartBtn = document.getElementById('label-bambu-restart-btn');
            const statusMessage = document.getElementById('bambu-status-message');

            if (labelTitle) labelTitle.textContent = texts.label_bambu_camera_title || 'üì∑ Drucker Kamera (Bambu Direct)';
            if (labelStatus) labelStatus.textContent = texts.label_bambu_status || 'Status:';
            if (labelFrameCount) labelFrameCount.textContent = texts.label_bambu_frame_count || 'Frame Count:';
            if (labelLastFrame) labelLastFrame.textContent = texts.label_bambu_last_frame || 'Letzter Frame:';
            if (labelThread) labelThread.textContent = texts.label_bambu_thread || 'Thread:';
            if (labelRestartBtn) labelRestartBtn.textContent = texts.label_bambu_restart_btn || 'üîÑ Stream neu starten';
            if (statusMessage && !statusMessage.textContent) statusMessage.textContent = texts.label_bambu_loading || 'Lade...';
        }

        // Auto-start camera status if camera section is already visible on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize labels
            initBambuCameraLabels();

            setTimeout(() => {
                const cameraSection = document.getElementById('section-camera');
                if (cameraSection && cameraSection.style.display !== 'none') {
                    console.log('üé• Camera section visible on load - starting status refresh');
                    startBambuStatusRefresh();
                }
            }, 500); // Small delay to ensure page is fully loaded
        });
        // ============ END BAMBU CAMERA STATUS & RESTART ============

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            console.log('üßπ Settings: Page unload - Cleanup');

            // Clear intervals
            if (licenseCheckInterval) {
                clearInterval(licenseCheckInterval);
            }
            if (bambuStatusInterval) {
                clearInterval(bambuStatusInterval);
            }

            // WICHTIG: WebSocket sauber schlie√üen
            if (window.settingsSocket) {
                console.log('üîå Settings: Closing WebSocket');
                window.settingsSocket.removeAllListeners();
                window.settingsSocket.disconnect();
                window.settingsSocket = null;
            }
        });

        // Attach sidebar event listeners after functions are defined
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.addEventListener('mouseenter', keepSidebarOpen);
                sidebar.addEventListener('mouseleave', closeSidebarOnLeave);
            }
        });
    </script>
</body>
</html>
