<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">3D Printer Dashboard - Login</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-container { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 400px; padding: 40px; position: relative; }
        .language-selector { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; }
        .lang-btn { background: rgba(102, 126, 234, 0.1); border: 2px solid transparent; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #667eea; transition: all 0.2s; }
        .lang-btn:hover { background: rgba(102, 126, 234, 0.2); }
        .lang-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; margin-top: 20px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-size: 14px; }
        input { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 16px; }
        input:focus { outline: none; border-color: #667eea; }
        .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
        .error-message { background: #fee; border: 1px solid #fcc; color: #c00; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .success-message { background: #efe; border: 1px solid #cfc; color: #060; padding: 10px; border-radius: 8px; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="language-selector">
            <button type="button" class="lang-btn" data-lang="de">ðŸ‡©ðŸ‡ª DE</button>
            <button type="button" class="lang-btn" data-lang="en">ðŸ‡¬ðŸ‡§ EN</button>
            <button type="button" class="lang-btn" data-lang="fr">ðŸ‡«ðŸ‡· FR</button>
            <button type="button" class="lang-btn" data-lang="es">ðŸ‡ªðŸ‡¸ ES</button>
            <button type="button" class="lang-btn" data-lang="it">ðŸ‡®ðŸ‡¹ IT</button>
        </div>
        <h1 id="login-title">3D Printer Dashboard</h1>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
        <form id="loginForm">
            <div class="form-group">
                <label for="username" id="username-label">Benutzername</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="password" id="password-label">Passwort</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="btn" id="login-button">Anmelden</button>
        </form>
    </div>

    <script>
        // Load translations
        let texts = {};
        const currentLang = localStorage.getItem('language') || 'de';
        let translationsLoaded = false;

        // Load language file
        const langScript = document.createElement('script');
        langScript.src = `/static/lang/${currentLang}.js`;
        langScript.onload = function() {
            // Access the loaded translation object directly
            if (currentLang === 'de' && typeof translations_de !== 'undefined') {
                texts = translations_de;
            } else if (currentLang === 'en' && typeof translations_en !== 'undefined') {
                texts = translations_en;
            } else if (currentLang === 'fr' && typeof translations_fr !== 'undefined') {
                texts = translations_fr;
            } else if (currentLang === 'es' && typeof translations_es !== 'undefined') {
                texts = translations_es;
            } else if (currentLang === 'it' && typeof translations_it !== 'undefined') {
                texts = translations_it;
            } else {
                texts = translations_en || translations_de || {};
            }
            translationsLoaded = true;
            // Update texts after DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateTexts);
            } else {
                updateTexts();
            }
        };
        document.head.appendChild(langScript);

        function updateTexts() {
            if (!translationsLoaded) return;

            // Helper function to safely update element
            const updateEl = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            // Update all static texts with fallbacks
            updateEl('page-title', texts.login_page_title || '3D Printer Dashboard - Login');
            updateEl('login-title', texts.login_title || '3D Printer Dashboard');
            updateEl('username-label', texts.login_username || 'Username');
            updateEl('password-label', texts.login_password || 'Password');
            updateEl('login-button', texts.login_button || 'Login');

            // Update active language button
            updateLanguageButtons();
        }

        function updateLanguageButtons() {
            const currentLang = localStorage.getItem('language') || 'de';
            document.querySelectorAll('.lang-btn').forEach(btn => {
                if (btn.dataset.lang === currentLang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function changeLanguage(newLang) {
            // Save to localStorage
            localStorage.setItem('language', newLang);

            // Reload page to apply new language
            window.location.reload();
        }

        // Language selector event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    changeLanguage(lang);
                });
            });

            // Set initial active state
            updateLanguageButtons();
        });
    </script>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const language = localStorage.getItem('language') || 'de';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username, password, language })
                });

                const data = await response.json();

                if (response.ok) {
                    // SECURITY: Token wird als HttpOnly Cookie vom Server gesetzt
                    // Wir speichern NUR nicht-sensitive Daten in localStorage
                    if (data.username) {
                        localStorage.setItem('username', data.username);
                        localStorage.setItem('role', data.role);
                    }

                    if (data.csrf_token) {
                        sessionStorage.setItem('csrf_token', data.csrf_token);
                        localStorage.setItem('csrf_token', data.csrf_token);
                    }

                    // FIX: Warte 100ms damit Browser Zeit hat Cookies zu schreiben (Race Condition Fix)
                    // Problem: Browser hat Set-Cookie Header manchmal noch nicht vollstÃ¤ndig
                    // verarbeitet bevor der nÃ¤chste Request abgeschickt wird
                    const urlParams = new URLSearchParams(window.location.search);
                    const nextUrl = urlParams.get('next') || '/';

                    // Kurzer Delay damit Browser Cookies schreiben kann
                    await new Promise(resolve => setTimeout(resolve, 100));
                    window.location.href = nextUrl;
                } else {
                    const errorMsg = data.error || texts.login_failed || 'Login failed';
                    document.getElementById('errorMessage').textContent = errorMsg;
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                const networkError = texts.login_network_error || 'Network error';
                document.getElementById('errorMessage').textContent = networkError;
                document.getElementById('errorMessage').style.display = 'block';
            }
        });
    </script>
</body>
</html>
