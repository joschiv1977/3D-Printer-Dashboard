<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Benutzer - 3D Printer Dashboard</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css">

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); padding: 5px; transition: background-color 0.3s ease, color 0.3s ease; }
        .container { max-width: 100%; margin: 0; padding: 8px; }

        /* Standard: 2 Spalten f√ºr die meisten Ger√§te */
        .sections-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        /* Nur auf sehr schmalen Screens (<450px) auf 1 Spalte */
        @media (max-width: 450px) {
            .sections-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Gro√üe Tablets und Desktop */
        @media (min-width: 900px) {
            .container { padding: 15px; }
            .sections-grid { gap: 20px; }
        }

        /* Desktop: 3 Spalten f√ºr Username, Password, Language */
        @media (min-width: 800px) {
            .sections-grid { grid-template-columns: 1fr 1fr 1fr; }
        }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header-nav { display: flex; gap: 10px; flex-wrap: wrap; }
        .back-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; text-decoration: none; font-size: 14px; }
        .content { background: var(--bg-card); padding: 15px; border-radius: 0 0 8px 8px; }
        .section { margin-bottom: 15px; padding: 15px; background: var(--bg-section); border-radius: 8px; }
        .section h2 { margin-bottom: 20px; color: var(--text-primary); border-bottom: 2px solid #667eea; padding-bottom: 10px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px; }
        input[type="text"], input[type="password"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: inline-block;
        }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-danger {
            background: #dc3545;
        }
        .btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
            transition: all 0.2s;
        }
        .alert { padding: 12px; border-radius: 5px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        body.dark-mode .alert-success { background: #1a3622; color: #4caf50; border: 1px solid #4caf50; }
        body.dark-mode .alert-error { background: #3a1a1a; color: #f44336; border: 1px solid #f44336; }
        .device-item { background: var(--bg-card); padding: 15px; border: 1px solid var(--border-color); border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .device-info { min-width: 0; flex: 1; }
        .device-name { font-weight: 600; display: flex; align-items: center; gap: 8px; color: var(--text-primary); flex-wrap: wrap; }
        .device-details { font-size: 12px; color: var(--text-secondary); word-wrap: break-word; }
        .device-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px; }
        .badge-web { background: #007bff; color: white; }
        .badge-android { background: #3DDC84; color: white; }
        .badge-ios { background: #000; color: white; }
        .badge-current { background: #28a745; color: white; }
        .user-info { background: var(--info-bg); padding: 15px; border-radius: 5px; margin-bottom: 20px; color: var(--text-primary); }
        .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--border-color); border-radius: 50%; border-top-color: #667eea; animation: spin 1s ease-in-out infinite; }

        /* Device List - Grid Layout */
        #devicesList {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        /* Desktop: 2-3 Spalten f√ºr Devices */
        @media (min-width: 900px) {
            #devicesList {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
        }

        @media (min-width: 1400px) {
            #devicesList {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 15px;
            }
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Tablets und gr√∂√üere Phones */
        @media (min-width: 768px) {
            .container { max-width: 100%; }
            .content { padding: 20px; }
        }

        /* Mobile Anpassungen */
        @media (max-width: 768px) {
            body { padding: 5px; margin-left: 0; }
            .header { border-radius: 8px 8px 0 0; padding: 15px; flex-wrap: wrap; gap: 10px; }
            .header h1 { font-size: 18px; flex: 1; min-width: 0; }
            .header .back-btn { width: 100%; text-align: center; }
            .content { padding: 15px; }
            .section { padding: 12px; }
            .sections-grid { grid-template-columns: 1fr; gap: 10px; }
            .device-item { flex-direction: column; align-items: flex-start; gap: 12px; }
            .device-item button { width: 100%; }

        }

        .back-btn {
            display: none !important; /* Versteckt, da jetzt in Sidebar */
        }
    </style>
    <script>
        // Hide header if embedded in iframe
        if (window.location.search.includes('embedded=true')) {
            document.addEventListener('DOMContentLoaded', function() {
                const header = document.querySelector('.header');
                if (header) header.style.display = 'none';
                const container = document.querySelector('.container');
                if (container) container.style.padding = '0';
                const content = document.querySelector('.content');
                if (content) {
                    content.style.borderRadius = '0';
                    content.style.padding = '20px';
                }
            });
        }
    </script>
</head>
<body>
    <!-- Apply dark mode immediately to prevent white flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Shared Module Scripts -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/sidebar-manager.js"></script>

    <div class="container">
        <div class="header" style="display: flex; align-items: center; gap: 15px;">
            <button class="menu-toggle" id="menu-toggle-header" onclick="toggleSidebar()">‚ò∞</button>
            <h1 id="header-title" style="margin: 0; flex: 1;">üë§ Benutzer</h1>
            <a href="/" class="back-btn" id="back-btn">‚Üê Zur√ºck zum Dashboard</a>
        </div>
        <div class="content">
            <div class="user-info"><span id="logged-in-label">Angemeldet als:</span> <strong id="username">-</strong> | <span id="role-label">Rolle:</span> <strong id="role">-</strong></div>
            <div id="successAlert" class="alert alert-success"></div>
            <div id="errorAlert" class="alert alert-error"></div>

            <div class="sections-grid">
                <div class="section">
                    <h2 id="change-username-title">üë§ Benutzernamen √§ndern</h2>
                    <form id="usernameForm">
                        <div class="form-group">
                            <label for="newUsername" id="new-username-label">Neuer Benutzername</label>
                            <input type="text" id="newUsername" minlength="3" required>
                        </div>
                        <div class="form-group">
                            <label for="currentPasswordForUname" id="current-password-confirm-label">Aktuelles Passwort (zur Best√§tigung)</label>
                            <input type="password" id="currentPasswordForUname" required>
                        </div>
                        <button type="submit" class="btn" id="save-username-btn">Benutzernamen speichern</button>
                    </form>
                </div>

                <div class="section">
                    <h2 id="change-password-title">üîê Passwort √§ndern</h2>
                    <form id="passwordForm">
                        <div class="form-group">
                            <label for="oldPassword" id="old-password-label">Aktuelles Passwort</label>
                            <input type="password" id="oldPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword" id="new-password-label">Neues Passwort (min. 8 Zeichen)</label>
                            <input type="password" id="newPassword" minlength="8" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword" id="confirm-password-label">Neues Passwort best√§tigen</label>
                            <input type="password" id="confirmPassword" minlength="8" required>
                        </div>
                        <button type="submit" class="btn" id="save-password-btn">Passwort speichern</button>
                    </form>
                </div>

                <div class="section">
                    <h2 id="language-title">üåê Sprache / Language</h2>
                    <p id="language-description" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">√Ñndert die Sprache der App und Push-Benachrichtigungen</p>
                    <form id="languageForm">
                        <div class="form-group">
                            <label for="languageSelect" id="language-label">App-Sprache</label>
                            <select id="languageSelect" style="width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 5px; background: var(--input-bg); color: var(--text-primary); font-size: 14px;">
                                <option value="de" id="language-german-option">üá©üá™ Deutsch</option>
                                <option value="en" id="language-english-option">üá¨üáß English</option>
                                <option value="fr" id="language-french-option">üá´üá∑ Fran√ßais</option>
                                <option value="es" id="language-spanish-option">üá™üá∏ Espa√±ol</option>
                                <option value="it" id="language-italian-option">üáÆüáπ Italiano</option>
                            </select>
                        </div>
                        <button type="submit" class="btn" id="save-language-btn">Sprache speichern</button>
                    </form>
                </div>
            </div>

            <div class="section">
                <h2 id="devices-sessions-title">üì± Angemeldete Ger√§te & Sessions</h2>
                <div id="devicesList"><div class="loading"></div> <span id="loading-text">Lade...</span></div>
            </div>

            <div class="section" id="user-management-section" style="display: none;">
                <h2 id="user-management-title">üë• Benutzerverwaltung</h2>
                <p id="user-management-description" style="color: var(--text-secondary); font-size: 14px; margin-bottom: 15px;">Verwalte alle Benutzer im System</p>
                <div id="usersList"><div class="loading"></div> <span id="loading-users-text">Lade Benutzer...</span></div>
            </div>

            <div class="section">
                <h2 id="logout-title">üö™ Abmelden</h2>
                <button onclick="logout()" class="btn btn-danger" id="logout-btn">Von diesem Ger√§t abmelden</button>
            </div>
        </div>
    </div>

    <script src="/static/auth-handler.js"></script>
    <script>
        // Get translations from i18nManager
        function getTexts() {
            return window.i18nManager ? window.i18nManager.getAllTexts() : {};
        }

        // Get current language
        const currentLang = window.i18nManager ? window.i18nManager.getCurrentLang() : 'de';

        // Apply translations when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Render sidebar using shared module
            if (window.sidebarManager) {
                window.sidebarManager.render();
            }

            updateTexts();
        });

        function updateTexts() {
            const texts = getTexts();

            // Helper function to safely update element
            const updateEl = (id, text) => {
                const el = document.getElementById(id);
                if (el && text) el.textContent = text;
            };

            // Update all static texts
            updateEl('page-title', texts.users_page_title);
            updateEl('header-title', texts.users_settings);
            updateEl('sidebar-title', texts.users_settings);
            updateEl('back-btn', texts.users_back_to_dashboard);
            updateEl('logged-in-label', texts.users_logged_in_as);
            updateEl('role-label', texts.users_role);

            // Sidebar Menu
            const sidebarItems = document.querySelectorAll('.sidebar-item span[data-i18n]');
            sidebarItems.forEach(item => {
                const key = item.getAttribute('data-i18n');
                if (key && texts[key]) {
                    item.textContent = texts[key];
                }
            });

            // Change Username Section
            updateEl('change-username-title', texts.users_change_username);
            updateEl('new-username-label', texts.users_new_username);
            updateEl('current-password-confirm-label', texts.users_current_password_confirm);
            updateEl('save-username-btn', texts.users_save_username);

            // Change Password Section
            updateEl('change-password-title', texts.users_change_password);
            updateEl('old-password-label', texts.users_current_password);
            updateEl('new-password-label', texts.users_new_password);
            updateEl('confirm-password-label', texts.users_confirm_password);
            updateEl('save-password-btn', texts.users_save_password);

            // Language Section
            updateEl('language-title', texts.users_language_title);
            updateEl('language-description', texts.users_language_description);
            updateEl('language-label', texts.users_language_label);
            updateEl('language-german-option', 'üá©üá™ ' + texts.users_language_german);
            updateEl('language-english-option', 'üá¨üáß ' + texts.users_language_english);
            updateEl('language-french-option', 'üá´üá∑ ' + texts.users_language_french);
            updateEl('language-spanish-option', 'üá™üá∏ ' + texts.users_language_spanish);
            updateEl('language-italian-option', 'üáÆüáπ ' + texts.users_language_italian);
            updateEl('save-language-btn', texts.users_save_language);

            // Devices & Sessions Section
            updateEl('devices-sessions-title', texts.users_devices_sessions);
            updateEl('loading-text', texts.users_loading);

            // User Management Section
            updateEl('user-management-title', texts.user_management_title);
            updateEl('user-management-description', texts.user_management_description);
            updateEl('loading-users-text', texts.users_loading_users);

            // Logout Section
            updateEl('logout-title', texts.users_logout);
            updateEl('logout-btn', texts.users_logout_device);

            // Update username/role with unknown if empty
            const usernameEl = document.getElementById('username');
            const roleEl = document.getElementById('role');
            if (usernameEl && usernameEl.textContent === '-') usernameEl.textContent = texts.users_unknown;
            if (roleEl && roleEl.textContent === '-') roleEl.textContent = texts.users_unknown;

            // Load devices/sessions after translations are ready
            loadDevicesAndSessions();
        }

        const texts = getTexts();
        document.getElementById('username').textContent = localStorage.getItem('username') || (texts.users_unknown) || 'Unknown';
        document.getElementById('role').textContent = localStorage.getItem('role') || (texts.users_unknown) || 'Unknown';

        // Benutzerverwaltung nur f√ºr Admins anzeigen
        const currentRole = localStorage.getItem('role');
        if (currentRole === 'admin') {
            document.getElementById('user-management-section').style.display = 'block';
            loadAllUsers();
        }

        // NEU: Handler f√ºr Benutzernamen-√Ñnderung
        document.getElementById('usernameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value;
            const password = document.getElementById('currentPasswordForUname').value;

            if (newUsername.length < 3) {
                return showError(texts.users_username_min_length);
            }

            try {
                const response = await apiCall('/api/auth/change-username', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ new_username: newUsername, password: password })
                });
                const data = await response.json();
                if (response.ok) {
                    showSuccess(texts.users_username_changed);
                    setTimeout(() => authHandler.logout(), 3000);
                } else {
                    showError(data.error || texts.users_error_change_username);
                }
            } catch (error) {
                showError(texts.users_network_error);
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) return showError(texts.users_passwords_no_match);

            try {
                const response = await apiCall('/api/auth/change-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });
                const data = await response.json();
                if (response.ok) {
                    showSuccess(texts.users_password_changed);
                    setTimeout(() => authHandler.logout(), 2000);
                } else {
                    showError(data.error || texts.users_error_change_password);
                }
            } catch (error) {
                showError(texts.users_network_error);
            }
        });

        async function loadDevicesAndSessions() {
            const listContainer = document.getElementById('devicesList');
            const loadingText = texts.users_loading_devices || 'Loading devices and sessions...';
            listContainer.innerHTML = `<div class="loading"></div> ${loadingText}`;
            try {
                // Nur /api/auth/sessions nutzen - enth√§lt bereits alle Sessions!
                const sessionsRes = await apiCall('/api/auth/sessions');

                if (sessionsRes.status === 401) return authHandler.redirectToLogin();

                const allSessions = sessionsRes.ok ? await sessionsRes.json() : [];

                // ID f√ºr jeden Eintrag setzen
                allSessions.forEach(s => {
                    s.id = s.session_id || s.device_id;
                });

                allSessions.sort((a, b) => new Date(b.last_used) - new Date(a.last_used));
                displayEntries(allSessions);
            } catch (error) {
                console.error('loadDevicesAndSessions error:', error);
                const errorText = texts.users_error_loading_list || 'Error loading list.';
                listContainer.innerHTML = `<p style="color: #999;">${errorText}</p>`;
            }
        }

        function getEntryIcon(entry) {
            const { type, device_type, device_name, device_model } = entry;
            const nameLower = (device_name || '').toLowerCase();
            const modelLower = (device_model || '').toLowerCase();

            if (type === 'web') {
                if (nameLower.includes('windows')) return 'üñ•Ô∏è';
                if (nameLower.includes('macos')) return 'üíª';
                if (nameLower.includes('linux')) return 'üêß';
                return 'üåê';
            }

            // Device Sessions (iOS/Android/macOS)
            if (type === 'device') {
                if (device_type === 'macos' || modelLower.includes('mac')) return 'üíª';
                if (device_type === 'ipados' || modelLower.includes('ipad')) return 'üì±';
                if (device_type === 'ios' || modelLower.includes('iphone')) return 'üì±';
                if (device_type === 'android') return 'ü§ñ';
            }

            return '‚öôÔ∏è';
        }

        function displayEntries(entries) {
            const container = document.getElementById('devicesList');
            if (!entries || entries.length === 0) {
                const noDevicesText = texts.users_no_devices_found || 'No logged in devices or sessions found.';
                container.innerHTML = `<p style="color: #999;">${noDevicesText}</p>`;
                return;
            }
            container.innerHTML = entries.map(entry => {
                const { type, device_name, device_type, device_model, last_used, is_current, id, app_version } = entry;
                // Zeige device_model falls vorhanden, sonst device_name
                const displayName = device_model || device_name || 'Unknown Device';
                const revokeAction = type === 'web'
                    ? `revokeSession('${id}', '${displayName}')`
                    : `revokeDevice('${id}', '${displayName}')`;
                const typeIcon = getEntryIcon(entry);

                // Badge-Farbe basierend auf device_type
                let badgeClass = 'badge-web';
                const deviceTypeSafe = device_type || 'web';

                if (type === 'device') {
                    if (deviceTypeSafe === 'ios') badgeClass = 'badge-ios';
                    else if (deviceTypeSafe === 'ipados') badgeClass = 'badge-ios';
                    else if (deviceTypeSafe === 'macos') badgeClass = 'badge-ios';
                    else if (deviceTypeSafe === 'android') badgeClass = 'badge-android';
                }

                const locale = currentLang === 'de' ? 'de-DE' : 'en-US';
                const currentBadge = texts.users_current_badge || 'CURRENT';
                const lastActiveLabel = texts.users_last_active || 'Last active:';
                const versionLabel = texts.users_version || 'Version:';
                const logoutBtn = texts.users_logout_button || 'Logout';

                return `
                    <div class="device-item">
                        <div class="device-info">
                            <div class="device-name">
                                ${typeIcon} <span>${displayName}</span>
                                <span class="device-badge ${badgeClass}">${deviceTypeSafe.toUpperCase()}</span>
                                ${is_current ? `<span class="device-badge badge-current">${currentBadge}</span>` : ''}
                            </div>
                            <div class="device-details">
                                ${lastActiveLabel} ${new Date(last_used).toLocaleString(locale)}
                                ${app_version ? `| ${versionLabel} ${app_version}` : ''}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="${revokeAction}" ${is_current ? 'disabled' : ''}>${logoutBtn}</button>
                    </div>`;
            }).join('');
        }

        async function revokeSession(sessionId, deviceName) {
            const confirmMsg = texts.users_confirm_end_session ? texts.users_confirm_end_session.replace('{name}', deviceName) : `Really end web session "${deviceName}"?`;
            const confirmed = await showConfirmDialog(confirmMsg, texts.users_confirm_title || 'Session beenden');
            if (!confirmed) return;
            const successMsg = texts.users_session_ended ? texts.users_session_ended.replace('{name}', deviceName) : `Session "${deviceName}" has been ended.`;
            await revokeEntry(`/api/auth/session/${sessionId}`, successMsg);
        }

        async function revokeDevice(deviceId, deviceName) {
            const confirmMsg = texts.users_confirm_logout_device ? texts.users_confirm_logout_device.replace('{name}', deviceName) : `Really log out device "${deviceName}"?`;
            const confirmed = await showConfirmDialog(confirmMsg, texts.users_confirm_title || 'Ger√§t abmelden');
            if (!confirmed) return;
            const successMsg = texts.users_device_logged_out ? texts.users_device_logged_out.replace('{name}', deviceName) : `Device "${deviceName}" has been logged out.`;
            await revokeEntry(`/api/auth/device/${deviceId}`, successMsg);
        }

        async function revokeEntry(url, successMessage) {
            try {
                const response = await apiCall(url, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess(successMessage);
                    loadDevicesAndSessions();
                } else {
                    showError(texts.users_action_failed || 'Action failed');
                }
            } catch (error) {
                showError(texts.users_network_error || 'Network error');
            }
        }

        async function loadAllUsers() {
            const listContainer = document.getElementById('usersList');
            const loadingText = texts.users_loading_users || 'Lade Benutzer...';
            listContainer.innerHTML = `<div class="loading"></div> ${loadingText}`;

            try {
                const response = await apiCall('/api/users');

                if (response.status === 401) return authHandler.redirectToLogin();
                if (response.status === 403) {
                    listContainer.innerHTML = `<p style="color: #999;">${texts.users_no_permission || 'Keine Berechtigung'}</p>`;
                    return;
                }

                const data = await response.json();
                const users = data.users || [];

                if (users.length === 0) {
                    listContainer.innerHTML = `<p style="color: #999;">${texts.users_no_users_found || 'Keine Benutzer gefunden'}</p>`;
                    return;
                }

                const currentUsername = localStorage.getItem('username');
                const locale = currentLang === 'de' ? 'de-DE' : 'en-US';
                const deleteBtn = texts.users_delete_button || 'L√∂schen';
                const roleLabel = texts.users_role || 'Rolle:';
                const createdLabel = texts.users_created || 'Erstellt:';
                const languageLabel = texts.users_language_short || 'Sprache:';

                // Z√§hle wie viele Admins es gibt
                const adminCount = users.filter(u => u.role === 'admin').length;

                listContainer.innerHTML = users.map(user => {
                    const isCurrentUser = user.username === currentUsername;
                    const isAdmin = user.role === 'admin';

                    // L√∂schen erlauben wenn:
                    // - Nicht der aktuelle User
                    // - UND entweder kein Admin ODER es gibt mehr als einen Admin
                    const canDelete = !isCurrentUser && (!isAdmin || adminCount > 1);

                    // Map language codes to display names
                    const langMap = {
                        'de': 'üá©üá™ Deutsch',
                        'en': 'üá¨üáß English',
                        'fr': 'üá´üá∑ Fran√ßais',
                        'es': 'üá™üá∏ Espa√±ol',
                        'it': 'üáÆüáπ Italiano'
                    };
                    const languageDisplay = langMap[user.language] || user.language;

                    return `
                        <div class="device-item">
                            <div class="device-info">
                                <div class="device-name">
                                    üë§ <span>${user.username}</span>
                                    <span class="device-badge ${user.role === 'admin' ? 'badge-ios' : 'badge-web'}">${user.role.toUpperCase()}</span>
                                    ${isCurrentUser ? `<span class="device-badge badge-current">${texts.users_you || 'DU'}</span>` : ''}
                                </div>
                                <div class="device-details">
                                    ${languageLabel} ${languageDisplay} | ${createdLabel} ${user.created ? new Date(user.created).toLocaleString(locale) : 'N/A'}
                                </div>
                            </div>
                            ${canDelete ? `<button class="btn btn-danger" onclick="deleteUser('${user.username}')">${deleteBtn}</button>` : ''}
                        </div>`;
                }).join('');

            } catch (error) {
                console.error('loadAllUsers error:', error);
                const errorText = texts.users_error_loading_users || 'Fehler beim Laden der Benutzer.';
                listContainer.innerHTML = `<p style="color: #999;">${errorText}</p>`;
            }
        }

        async function deleteUser(username) {
            const confirmMsg = texts.users_confirm_delete_user
                ? texts.users_confirm_delete_user.replace('{username}', username)
                : `M√∂chtest du den Benutzer "${username}" wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!`;

            const confirmed = await showConfirmDialog(confirmMsg, texts.users_delete_title || 'Benutzer l√∂schen');
            if (!confirmed) return;

            try {
                const response = await apiCall(`/api/users/${username}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    const successMsg = texts.users_user_deleted
                        ? texts.users_user_deleted.replace('{username}', username)
                        : `Benutzer "${username}" wurde erfolgreich gel√∂scht.`;
                    showSuccess(successMsg);
                    loadAllUsers();
                } else {
                    showError(data.error || texts.users_action_failed || 'Aktion fehlgeschlagen');
                }
            } catch (error) {
                console.error('deleteUser error:', error);
                showError(texts.users_network_error || 'Netzwerkfehler');
            }
        }

        const logout = () => authHandler.logout();

        function showAlert(id, message) {
            const alert = document.getElementById(id);
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 4000);
        }

        // Wrapper-Funktionen die Electron Toast oder Web Alert nutzen
        function showSuccess(msg) {
            // Pr√ºfe ob Electron Toast verf√ºgbar ist (window.showToast von toast.js)
            if (window.electronAPI && window.showToast) {
                window.showToast({ title: 'Erfolg', message: msg, type: 'success', duration: 4000 });
            } else {
                showAlert('successAlert', msg);
            }
        }
        function showError(msg) {
            // Pr√ºfe ob Electron Toast verf√ºgbar ist (window.showToast von toast.js)
            if (window.electronAPI && window.showToast) {
                window.showToast({ title: 'Fehler', message: msg, type: 'error', duration: 4000 });
            } else {
                showAlert('errorAlert', msg);
            }
        }

        // Wrapper f√ºr confirm() - nutzt Electron showConfirm oder native confirm
        async function showConfirmDialog(message, title = 'Best√§tigung') {
            if (window.electronAPI && window.showConfirm) {
                return await window.showConfirm({ title: title, message: message, type: 'warning' });
            } else {
                return confirm(message);
            }
        }

        // Language change functionality
        async function loadUserLanguage() {
            try {
                const response = await apiCall('/api/auth/language', { method: 'GET' });
                if (response.ok) {
                    const data = await response.json();
                    const languageSelect = document.getElementById('languageSelect');
                    if (languageSelect && data.language) {
                        languageSelect.value = data.language;
                    }
                }
            } catch (error) {
                console.error('Error loading user language:', error);
            }
        }

        // Load user language when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadUserLanguage);
        } else {
            loadUserLanguage();
        }

        // Handle language form submission
        document.addEventListener('DOMContentLoaded', () => {
            const languageForm = document.getElementById('languageForm');
            if (languageForm) {
                languageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const languageSelect = document.getElementById('languageSelect');
                    const selectedLanguage = languageSelect.value;

                    try {
                        const response = await apiCall('/api/auth/language', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ language: selectedLanguage })
                        });

                        if (response.ok) {
                            // Update localStorage
                            localStorage.setItem('language', selectedLanguage);

                            // Show success message
                            showSuccess(texts.users_language_changed || 'Language successfully changed!');

                            // Reload page to apply new language
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            const errorData = await response.json();
                            showError(errorData.error || texts.users_error_change_language || 'Error changing language.');
                        }
                    } catch (error) {
                        console.error('Language change error:', error);
                        showError(texts.users_network_error || 'Network error');
                    }
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);

            // Pr√ºfe, ob wir uns in der Android App befinden
            if (urlParams.get('app') === 'android') {
                const backButton = document.getElementById('back-to-dashboard');
                if (backButton) {
                    // Wandle den Link in einen Button um, der die native Java-Funktion aufruft.
                    backButton.href = "javascript:void(0);"; // Verhindert die Standard-Navigation

                    backButton.onclick = function(event) {
                        event.preventDefault(); // Stoppt das Link-Verhalten sicher

                        // Pr√ºfe, ob die Bridge-Funktion existiert
                        if (window.Android && typeof window.Android.goBackToDashboard === 'function') {
                            // Rufe die native Funktion in MainActivity.java auf
                            window.Android.goBackToDashboard();
                        } else {
                            // Fallback, falls die Bridge nicht da ist
                            console.error("Android Bridge nicht gefunden!");
                            window.location.href = '/?app=android';
                        }
                    };
                }
            }
        });
    </script>

    <script>
        // Periodic license status checking
        // Check every 60 seconds if license is still valid
        let licenseCheckInterval = null;

        function checkLicenseStatus() {
            fetch('/license/api/check', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    console.warn('License became invalid - redirecting to activation page');
                    // Clear interval before redirect
                    if (licenseCheckInterval) {
                        clearInterval(licenseCheckInterval);
                    }
                    // Redirect to license activation
                    window.location.href = '/license/activate';
                }
            })
            .catch(error => {
                console.error('Error checking license status:', error);
            });
        }

        // Start periodic checking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initial check after 5 seconds
            setTimeout(checkLicenseStatus, 5000);

            // Then check every 60 seconds
            licenseCheckInterval = setInterval(checkLicenseStatus, 60000);
        });

        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (licenseCheckInterval) {
                clearInterval(licenseCheckInterval);
            }
        });
    </script>
</body>
</html>
