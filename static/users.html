<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Benutzer - 3D Printer Dashboard</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css?v=2">
    <link rel="stylesheet" href="/static/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/design-tokens.css?v=2">
    <link rel="stylesheet" href="/static/css/base.css?v=2">
    <link rel="stylesheet" href="/static/css/tab-bar.css?v=2">
    <link rel="stylesheet" href="/static/css/sd-card.css?v=4">

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        body {
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 5px;
            padding-bottom: 90px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 12px; }

        /* Page Header */
        .user-page-header {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        body:not(.dark-mode) .user-page-header {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.06);
        }
        .user-page-header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-info-bar {
            font-size: 13px;
            color: var(--text-secondary);
        }
        .user-info-bar strong {
            color: var(--text-primary);
        }

        /* Sections Grid */
        .sections-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        @media (min-width: 800px) {
            .sections-grid { grid-template-columns: 1fr 1fr 1fr; }
        }
        @media (max-width: 450px) {
            .sections-grid { grid-template-columns: 1fr; }
        }

        /* Section Card ‚Äî glassmorphism */
        .section {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            padding: 16px;
        }
        body:not(.dark-mode) .section {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.06);
        }
        .section h2 {
            margin: 0 0 14px 0;
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        body:not(.dark-mode) .section h2 {
            border-bottom-color: rgba(0, 0, 0, 0.06);
        }

        /* Form elements */
        .form-group { margin-bottom: 10px; }
        label {
            display: block;
            margin-bottom: 4px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
        }
        input[type="text"], input[type="password"], select {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }
        select option {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px;
        }
        body:not(.dark-mode) input[type="text"],
        body:not(.dark-mode) input[type="password"],
        body:not(.dark-mode) select {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }
        input[type="text"]:focus, input[type="password"]:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Buttons ‚Äî glassmorphism */
        .btn {
            background: rgba(33, 150, 243, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.3);
            color: var(--accent-blue);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-block;
        }
        body:not(.dark-mode) .btn {
            color: #1565c0;
        }
        .btn:hover:not(:disabled) {
            background: rgba(33, 150, 243, 0.25);
            transform: translateY(-1px);
        }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-danger {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: var(--accent-red);
        }
        body:not(.dark-mode) .btn-danger {
            color: #c62828;
        }
        .btn-danger:hover:not(:disabled) {
            background: rgba(244, 67, 54, 0.25);
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: none;
            font-size: 13px;
        }
        .alert-success {
            background: rgba(76, 175, 80, 0.12);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--accent-green);
        }
        .alert-error {
            background: rgba(244, 67, 54, 0.12);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: var(--accent-red);
        }

        /* Device/Session Items */
        .device-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        body:not(.dark-mode) .device-item {
            background: rgba(0, 0, 0, 0.015);
            border-color: rgba(0, 0, 0, 0.05);
        }
        .device-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        body:not(.dark-mode) .device-item:hover {
            background: rgba(0, 0, 0, 0.03);
        }
        .device-info { min-width: 0; flex: 1; }
        .device-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-primary);
            flex-wrap: wrap;
        }
        .device-details {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 3px;
        }
        .device-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
        }
        .badge-web {
            background: rgba(33, 150, 243, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.3);
            color: var(--accent-blue);
        }
        .badge-android {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--accent-green);
        }
        .badge-ios {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }
        body:not(.dark-mode) .badge-ios {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(0, 0, 0, 0.12);
        }
        .badge-electron {
            background: rgba(156, 39, 176, 0.15);
            border: 1px solid rgba(156, 39, 176, 0.3);
            color: #ce93d8;
        }
        body:not(.dark-mode) .badge-electron {
            color: #7b1fa2;
        }
        .badge-current {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: var(--accent-green);
        }

        /* Device List Grid */
        #devicesList {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        @media (min-width: 900px) {
            #devicesList { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 1400px) {
            #devicesList { grid-template-columns: 1fr 1fr 1fr; }
        }

        /* Section margin-bottom for non-grid sections */
        .section + .section { margin-top: 0; }
        .section:not(:last-child) { margin-bottom: 12px; }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--accent-blue);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Custom Language Dropdown */
        .lang-dropdown {
            position: relative;
            width: 100%;
        }
        .lang-dropdown-selected {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: border-color 0.2s;
        }
        body:not(.dark-mode) .lang-dropdown-selected {
            background: rgba(0, 0, 0, 0.03);
            border-color: rgba(0, 0, 0, 0.1);
        }
        .lang-dropdown-selected:hover,
        .lang-dropdown.open .lang-dropdown-selected {
            border-color: var(--accent-blue);
        }
        .lang-dropdown-arrow {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }
        .lang-dropdown.open .lang-dropdown-arrow {
            transform: rotate(180deg);
        }
        .lang-dropdown-list {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            z-index: 100;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        body:not(.dark-mode) .lang-dropdown-list {
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        .lang-dropdown.open .lang-dropdown-list {
            display: block;
        }
        .lang-dropdown-item {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background 0.15s;
        }
        .lang-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }
        body:not(.dark-mode) .lang-dropdown-item:hover {
            background: rgba(0, 0, 0, 0.04);
        }
        .lang-dropdown-item.selected {
            background: rgba(33, 150, 243, 0.1);
            color: var(--accent-blue);
        }
        .lang-flag {
            width: 22px;
            height: 16px;
            border-radius: 2px;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding: 5px; margin-left: 0; }
            .container { padding: 8px; }
            .sections-grid { grid-template-columns: 1fr; gap: 10px; }
            .device-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .device-item button { width: 100%; }
            .user-page-header { flex-direction: column; align-items: flex-start; }
        }

        .back-btn {
            display: none !important;
        }
    </style>
    <script>
        // Hide header if embedded in iframe
        if (window.location.search.includes('embedded=true')) {
            document.addEventListener('DOMContentLoaded', function() {
                const header = document.querySelector('.header');
                if (header) header.style.display = 'none';
                const container = document.querySelector('.container');
                if (container) container.style.padding = '0';
                const content = document.querySelector('.content');
                if (content) {
                    content.style.borderRadius = '0';
                    content.style.padding = '20px';
                }
            });
        }
    </script>
</head>
<body>
    <!-- Apply dark mode immediately to prevent white flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Shared Module Scripts -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/tab-bar-manager.js"></script>

    <div class="container">
        <div class="user-page-header">
            <h1 id="header-title">üë§ Benutzer</h1>
            <div class="user-info-bar">
                <span id="logged-in-label">Angemeldet als:</span> <strong id="username">-</strong> &nbsp;|&nbsp; <span id="role-label">Rolle:</span> <strong id="role">-</strong>
            </div>
            <a href="/" class="back-btn" id="back-btn">‚Üê Zur√ºck zum Dashboard</a>
        </div>

        <div id="successAlert" class="alert alert-success"></div>
        <div id="errorAlert" class="alert alert-error"></div>

        <div class="sections-grid">
            <div class="section">
                <h2 id="change-username-title">üë§ Benutzernamen √§ndern</h2>
                <form id="usernameForm">
                    <div class="form-group">
                        <label for="newUsername" id="new-username-label">Neuer Benutzername</label>
                        <input type="text" id="newUsername" minlength="3" required>
                    </div>
                    <div class="form-group">
                        <label for="currentPasswordForUname" id="current-password-confirm-label">Aktuelles Passwort (zur Best√§tigung)</label>
                        <input type="password" id="currentPasswordForUname" required>
                    </div>
                    <button type="submit" class="btn" id="save-username-btn">Benutzernamen speichern</button>
                </form>
            </div>

            <div class="section">
                <h2 id="change-password-title">üîê Passwort √§ndern</h2>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="oldPassword" id="old-password-label">Aktuelles Passwort</label>
                        <input type="password" id="oldPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword" id="new-password-label">Neues Passwort (min. 8 Zeichen)</label>
                        <input type="password" id="newPassword" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword" id="confirm-password-label">Neues Passwort best√§tigen</label>
                        <input type="password" id="confirmPassword" minlength="8" required>
                    </div>
                    <button type="submit" class="btn" id="save-password-btn">Passwort speichern</button>
                </form>
            </div>

            <div class="section">
                <h2 id="language-title">üåê Sprache / Language</h2>
                <p id="language-description" style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">√Ñndert die Sprache der App und Push-Benachrichtigungen</p>
                <form id="languageForm">
                    <div class="form-group">
                        <label id="language-label">App-Sprache</label>
                        <input type="hidden" id="languageSelect" value="de">
                        <div class="lang-dropdown" id="langDropdown">
                            <div class="lang-dropdown-selected" onclick="toggleLangDropdown()">
                                <svg class="lang-flag" id="langSelectedFlag" viewBox="0 0 640 480"><rect width="640" height="160" fill="#000"/><rect y="160" width="640" height="160" fill="#D00"/><rect y="320" width="640" height="160" fill="#FFCE00"/></svg>
                                <span id="langSelectedText">Deutsch</span>
                                <span class="lang-dropdown-arrow">‚ñº</span>
                            </div>
                            <div class="lang-dropdown-list">
                                <div class="lang-dropdown-item selected" data-lang="de" onclick="selectLang('de')">
                                    <svg class="lang-flag" viewBox="0 0 640 480"><rect width="640" height="160" fill="#000"/><rect y="160" width="640" height="160" fill="#D00"/><rect y="320" width="640" height="160" fill="#FFCE00"/></svg>
                                    <span id="language-german-option">Deutsch</span>
                                </div>
                                <div class="lang-dropdown-item" data-lang="en" onclick="selectLang('en')">
                                    <svg class="lang-flag" viewBox="0 0 640 480"><rect fill="#012169" width="640" height="480"/><path d="M75 0l244 181L562 0h78v62L400 241l240 178v61h-80L320 301 hindernisse81 480H0v-60l239-178L0 64V0h75z" fill="#fff"/><path d="M424 281l216 159v40L369 281h55zm-184 20l6 35L54 480H0l240-179zM640 0v3L391 191l2-44L590 0h50zM0 0l239 176h-60L0 42V0z" fill="#C8102E"/><path d="M241 0v480h160V0H241zM0 160v160h640V160H0z" fill="#fff"/><path d="M0 193v96h640v-96H0zM273 0v480h96V0h-96z" fill="#C8102E"/></svg>
                                    <span id="language-english-option">English</span>
                                </div>
                                <div class="lang-dropdown-item" data-lang="fr" onclick="selectLang('fr')">
                                    <svg class="lang-flag" viewBox="0 0 640 480"><rect width="213" height="480" fill="#002395"/><rect x="213" width="214" height="480" fill="#fff"/><rect x="427" width="213" height="480" fill="#ED2939"/></svg>
                                    <span id="language-french-option">Fran√ßais</span>
                                </div>
                                <div class="lang-dropdown-item" data-lang="es" onclick="selectLang('es')">
                                    <svg class="lang-flag" viewBox="0 0 640 480"><rect width="640" height="480" fill="#c60b1e"/><rect y="120" width="640" height="240" fill="#ffc400"/></svg>
                                    <span id="language-spanish-option">Espa√±ol</span>
                                </div>
                                <div class="lang-dropdown-item" data-lang="it" onclick="selectLang('it')">
                                    <svg class="lang-flag" viewBox="0 0 640 480"><rect width="213" height="480" fill="#009246"/><rect x="213" width="214" height="480" fill="#fff"/><rect x="427" width="213" height="480" fill="#CE2B37"/></svg>
                                    <span id="language-italian-option">Italiano</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn" id="save-language-btn">Sprache speichern</button>
                </form>
            </div>
        </div>

        <div class="section">
            <h2 id="devices-sessions-title">üì± Angemeldete Ger√§te & Sessions</h2>
            <div id="devicesList"><div class="loading"></div> <span id="loading-text">Lade...</span></div>
        </div>

        <div class="section" id="user-management-section" style="display: none;">
            <h2 id="user-management-title">üë• Benutzerverwaltung</h2>
            <p id="user-management-description" style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">Verwalte alle Benutzer im System</p>
            <div id="usersList"><div class="loading"></div> <span id="loading-users-text">Lade Benutzer...</span></div>
        </div>

        <div class="section">
            <h2 id="logout-title">üö™ Abmelden</h2>
            <button onclick="logout()" class="btn btn-danger" id="logout-btn">Von diesem Ger√§t abmelden</button>
        </div>
    </div>

    <script src="/static/auth-handler.js"></script>
    <script>
        // Get translations from i18nManager
        function getTexts() {
            return window.i18nManager ? window.i18nManager.getAllTexts() : {};
        }

        // Get current language
        const currentLang = window.i18nManager ? window.i18nManager.getCurrentLang() : 'de';

        // Apply translations when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Render sidebar using shared module
            if (window.tabBarManager) {
                window.tabBarManager.render();
            }

            updateTexts();
        });

        function updateTexts() {
            const texts = getTexts();

            // Helper function to safely update element
            const updateEl = (id, text) => {
                const el = document.getElementById(id);
                if (el && text) el.textContent = text;
            };

            // Update all static texts
            updateEl('page-title', texts.users_page_title);
            updateEl('header-title', texts.users_settings);
            updateEl('sidebar-title', texts.users_settings);
            updateEl('back-btn', texts.users_back_to_dashboard);
            updateEl('logged-in-label', texts.users_logged_in_as);
            updateEl('role-label', texts.users_role);

            // Sidebar Menu
            const sidebarItems = document.querySelectorAll('.sidebar-item span[data-i18n]');
            sidebarItems.forEach(item => {
                const key = item.getAttribute('data-i18n');
                if (key && texts[key]) {
                    item.textContent = texts[key];
                }
            });

            // Change Username Section
            updateEl('change-username-title', texts.users_change_username);
            updateEl('new-username-label', texts.users_new_username);
            updateEl('current-password-confirm-label', texts.users_current_password_confirm);
            updateEl('save-username-btn', texts.users_save_username);

            // Change Password Section
            updateEl('change-password-title', texts.users_change_password);
            updateEl('old-password-label', texts.users_current_password);
            updateEl('new-password-label', texts.users_new_password);
            updateEl('confirm-password-label', texts.users_confirm_password);
            updateEl('save-password-btn', texts.users_save_password);

            // Language Section
            updateEl('language-title', texts.users_language_title);
            updateEl('language-description', texts.users_language_description);
            updateEl('language-label', texts.users_language_label);
            updateEl('language-german-option', texts.users_language_german);
            updateEl('language-english-option', texts.users_language_english);
            updateEl('language-french-option', texts.users_language_french);
            updateEl('language-spanish-option', texts.users_language_spanish);
            updateEl('language-italian-option', texts.users_language_italian);
            updateEl('save-language-btn', texts.users_save_language);

            // Devices & Sessions Section
            updateEl('devices-sessions-title', texts.users_devices_sessions);
            updateEl('loading-text', texts.users_loading);

            // User Management Section
            updateEl('user-management-title', texts.user_management_title);
            updateEl('user-management-description', texts.user_management_description);
            updateEl('loading-users-text', texts.users_loading_users);

            // Logout Section
            updateEl('logout-title', texts.users_logout);
            updateEl('logout-btn', texts.users_logout_device);

            // Update username/role with unknown if empty
            const usernameEl = document.getElementById('username');
            const roleEl = document.getElementById('role');
            if (usernameEl && usernameEl.textContent === '-') usernameEl.textContent = texts.users_unknown;
            if (roleEl && roleEl.textContent === '-') roleEl.textContent = texts.users_unknown;

            // Load devices/sessions after translations are ready
            loadDevicesAndSessions();
        }

        const texts = getTexts();
        document.getElementById('username').textContent = localStorage.getItem('username') || (texts.users_unknown) || 'Unknown';
        document.getElementById('role').textContent = localStorage.getItem('role') || (texts.users_unknown) || 'Unknown';

        // Benutzerverwaltung nur f√ºr Admins anzeigen
        const currentRole = localStorage.getItem('role');
        if (currentRole === 'admin') {
            document.getElementById('user-management-section').style.display = 'block';
            loadAllUsers();
        }

        // NEU: Handler f√ºr Benutzernamen-√Ñnderung
        document.getElementById('usernameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = document.getElementById('newUsername').value;
            const password = document.getElementById('currentPasswordForUname').value;

            if (newUsername.length < 3) {
                return showError(texts.users_username_min_length);
            }

            try {
                const response = await apiCall('/api/auth/change-username', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ new_username: newUsername, password: password })
                });
                const data = await response.json();
                if (response.ok) {
                    showSuccess(texts.users_username_changed);
                    setTimeout(() => authHandler.logout(), 3000);
                } else {
                    showError(data.error || texts.users_error_change_username);
                }
            } catch (error) {
                showError(texts.users_network_error);
            }
        });

        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) return showError(texts.users_passwords_no_match);

            try {
                const response = await apiCall('/api/auth/change-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
                });
                const data = await response.json();
                if (response.ok) {
                    showSuccess(texts.users_password_changed);
                    setTimeout(() => authHandler.logout(), 2000);
                } else {
                    showError(data.error || texts.users_error_change_password);
                }
            } catch (error) {
                showError(texts.users_network_error);
            }
        });

        async function loadDevicesAndSessions() {
            const listContainer = document.getElementById('devicesList');
            const loadingText = texts.users_loading_devices || 'Loading devices and sessions...';
            listContainer.innerHTML = `<div class="loading"></div> ${loadingText}`;
            try {
                // Nur /api/auth/sessions nutzen - enth√§lt bereits alle Sessions!
                const sessionsRes = await apiCall('/api/auth/sessions');

                if (sessionsRes.status === 401) return authHandler.redirectToLogin();

                const allSessions = sessionsRes.ok ? await sessionsRes.json() : [];

                // ID f√ºr jeden Eintrag setzen
                allSessions.forEach(s => {
                    s.id = s.session_id || s.device_id;
                });

                // Electron-Deduplizierung: Web-Session ausblenden wenn Device-Eintrag existiert
                const hasElectronDevice = allSessions.some(s => s.type === 'device' && s.device_type === 'electron');
                const filtered = hasElectronDevice
                    ? allSessions.filter(s => !(s.type === 'web' && s.device_type === 'electron'))
                    : allSessions;

                // is_current auf Electron-Device √ºbertragen wenn Web-Session current war
                if (hasElectronDevice) {
                    const electronWebCurrent = allSessions.find(s => s.type === 'web' && s.device_type === 'electron' && s.is_current);
                    if (electronWebCurrent) {
                        const electronDevice = filtered.find(s => s.type === 'device' && s.device_type === 'electron');
                        if (electronDevice) electronDevice.is_current = true;
                    }
                }

                filtered.sort((a, b) => new Date(b.last_used) - new Date(a.last_used));
                displayEntries(filtered);
            } catch (error) {
                console.error('loadDevicesAndSessions error:', error);
                const errorText = texts.users_error_loading_list || 'Error loading list.';
                listContainer.innerHTML = `<p style="color: #999;">${errorText}</p>`;
            }
        }

        function getEntryIcon(entry) {
            const { type, device_type, device_name, device_model } = entry;
            const nameLower = (device_name || '').toLowerCase();
            const modelLower = (device_model || '').toLowerCase();

            if (type === 'web') {
                if (nameLower.includes('windows')) return 'üñ•Ô∏è';
                if (nameLower.includes('macos')) return 'üíª';
                if (nameLower.includes('linux')) return 'üêß';
                return 'üåê';
            }

            // Device Sessions (Electron/iOS/Android/macOS)
            if (type === 'device') {
                if (device_type === 'electron') {
                    if (modelLower.includes('win')) return 'üñ•Ô∏è';
                    if (modelLower.includes('darwin') || modelLower.includes('mac')) return 'üíª';
                    if (modelLower.includes('linux')) return 'üêß';
                    return 'üñ•Ô∏è';
                }
                if (device_type === 'macos' || modelLower.includes('mac')) return 'üíª';
                if (device_type === 'ipados' || modelLower.includes('ipad')) return 'üì±';
                if (device_type === 'ios' || modelLower.includes('iphone')) return 'üì±';
                if (device_type === 'android') return 'ü§ñ';
            }

            return '‚öôÔ∏è';
        }

        function displayEntries(entries) {
            const container = document.getElementById('devicesList');
            if (!entries || entries.length === 0) {
                const noDevicesText = texts.users_no_devices_found || 'No logged in devices or sessions found.';
                container.innerHTML = `<p style="color: #999;">${noDevicesText}</p>`;
                return;
            }
            container.innerHTML = entries.map(entry => {
                const { type, device_name, device_type, device_model, last_used, is_current, id, app_version } = entry;
                // F√ºr Electron/Web: device_name bevorzugen (hostname/browser), f√ºr mobile: device_model (iPhone 15 etc.)
                const displayName = (device_type === 'electron' || type === 'web')
                    ? (device_name || device_model || 'Unknown Device')
                    : (device_model || device_name || 'Unknown Device');
                const revokeAction = type === 'web'
                    ? `revokeSession('${id}', '${displayName}')`
                    : `revokeDevice('${id}', '${displayName}')`;
                const typeIcon = getEntryIcon(entry);

                // Badge-Farbe und Text basierend auf device_type
                let badgeClass = 'badge-web';
                const deviceTypeSafe = device_type || (type === 'web' ? 'web' : 'unknown');

                // Badge-Klasse bestimmen (f√ºr Device- und Web-Sessions)
                const badgeClassMap = { electron: 'badge-electron', ios: 'badge-ios', ipados: 'badge-ios', macos: 'badge-ios', android: 'badge-android' };
                if (badgeClassMap[deviceTypeSafe]) {
                    badgeClass = badgeClassMap[deviceTypeSafe];
                }

                // Badge-Text: sch√∂nere Labels statt raw device_type
                const badgeLabels = { web: 'WEB', electron: 'ELECTRON', ios: 'iOS', ipados: 'iPadOS', macos: 'macOS', android: 'ANDROID', unknown: 'APP' };
                const badgeText = badgeLabels[deviceTypeSafe] || deviceTypeSafe.toUpperCase();

                const locale = currentLang === 'de' ? 'de-DE' : 'en-US';
                const currentBadge = texts.users_current_badge || 'CURRENT';
                const lastActiveLabel = texts.users_last_active || 'Last active:';
                const versionLabel = texts.users_version || 'Version:';
                const logoutBtn = texts.users_logout_button || 'Logout';

                return `
                    <div class="device-item">
                        <div class="device-info">
                            <div class="device-name">
                                ${typeIcon} <span>${displayName}</span>
                                <span class="device-badge ${badgeClass}">${badgeText}</span>
                                ${is_current ? `<span class="device-badge badge-current">${currentBadge}</span>` : ''}
                            </div>
                            <div class="device-details">
                                ${lastActiveLabel} ${new Date(last_used).toLocaleString(locale)}
                                ${app_version ? `| ${versionLabel} ${app_version}` : ''}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="${revokeAction}" ${is_current ? 'disabled' : ''}>${logoutBtn}</button>
                    </div>`;
            }).join('');
        }

        async function revokeSession(sessionId, deviceName) {
            const confirmMsg = texts.users_confirm_end_session ? texts.users_confirm_end_session.replace('{name}', deviceName) : `Really end web session "${deviceName}"?`;
            const confirmed = await showConfirmDialog(confirmMsg, texts.users_confirm_title || 'Session beenden');
            if (!confirmed) return;
            const successMsg = texts.users_session_ended ? texts.users_session_ended.replace('{name}', deviceName) : `Session "${deviceName}" has been ended.`;
            await revokeEntry(`/api/auth/session/${sessionId}`, successMsg);
        }

        async function revokeDevice(deviceId, deviceName) {
            const confirmMsg = texts.users_confirm_logout_device ? texts.users_confirm_logout_device.replace('{name}', deviceName) : `Really log out device "${deviceName}"?`;
            const confirmed = await showConfirmDialog(confirmMsg, texts.users_confirm_title || 'Ger√§t abmelden');
            if (!confirmed) return;
            const successMsg = texts.users_device_logged_out ? texts.users_device_logged_out.replace('{name}', deviceName) : `Device "${deviceName}" has been logged out.`;
            await revokeEntry(`/api/auth/device/${deviceId}`, successMsg);
        }

        async function revokeEntry(url, successMessage) {
            try {
                const response = await apiCall(url, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess(successMessage);
                    loadDevicesAndSessions();
                } else {
                    showError(texts.users_action_failed || 'Action failed');
                }
            } catch (error) {
                showError(texts.users_network_error || 'Network error');
            }
        }

        async function loadAllUsers() {
            const listContainer = document.getElementById('usersList');
            const loadingText = texts.users_loading_users || 'Lade Benutzer...';
            listContainer.innerHTML = `<div class="loading"></div> ${loadingText}`;

            try {
                const response = await apiCall('/api/users');

                if (response.status === 401) return authHandler.redirectToLogin();
                if (response.status === 403) {
                    listContainer.innerHTML = `<p style="color: #999;">${texts.users_no_permission || 'Keine Berechtigung'}</p>`;
                    return;
                }

                const data = await response.json();
                const users = data.users || [];

                if (users.length === 0) {
                    listContainer.innerHTML = `<p style="color: #999;">${texts.users_no_users_found || 'Keine Benutzer gefunden'}</p>`;
                    return;
                }

                const currentUsername = localStorage.getItem('username');
                const locale = currentLang === 'de' ? 'de-DE' : 'en-US';
                const deleteBtn = texts.users_delete_button || 'L√∂schen';
                const roleLabel = texts.users_role || 'Rolle:';
                const createdLabel = texts.users_created || 'Erstellt:';
                const languageLabel = texts.users_language_short || 'Sprache:';

                // Z√§hle wie viele Admins es gibt
                const adminCount = users.filter(u => u.role === 'admin').length;

                listContainer.innerHTML = users.map(user => {
                    const isCurrentUser = user.username === currentUsername;
                    const isAdmin = user.role === 'admin';

                    // L√∂schen erlauben wenn:
                    // - Nicht der aktuelle User
                    // - UND entweder kein Admin ODER es gibt mehr als einen Admin
                    const canDelete = !isCurrentUser && (!isAdmin || adminCount > 1);

                    // Map language codes to display names
                    const langMap = {
                        'de': 'üá©üá™ Deutsch',
                        'en': 'üá¨üáß English',
                        'fr': 'üá´üá∑ Fran√ßais',
                        'es': 'üá™üá∏ Espa√±ol',
                        'it': 'üáÆüáπ Italiano'
                    };
                    const languageDisplay = langMap[user.language] || user.language;

                    return `
                        <div class="device-item">
                            <div class="device-info">
                                <div class="device-name">
                                    üë§ <span>${user.username}</span>
                                    <span class="device-badge ${user.role === 'admin' ? 'badge-ios' : 'badge-web'}">${user.role.toUpperCase()}</span>
                                    ${isCurrentUser ? `<span class="device-badge badge-current">${texts.users_you || 'DU'}</span>` : ''}
                                </div>
                                <div class="device-details">
                                    ${languageLabel} ${languageDisplay} | ${createdLabel} ${user.created ? new Date(user.created).toLocaleString(locale) : 'N/A'}
                                </div>
                            </div>
                            ${canDelete ? `<button class="btn btn-danger" onclick="deleteUser('${user.username}')">${deleteBtn}</button>` : ''}
                        </div>`;
                }).join('');

            } catch (error) {
                console.error('loadAllUsers error:', error);
                const errorText = texts.users_error_loading_users || 'Fehler beim Laden der Benutzer.';
                listContainer.innerHTML = `<p style="color: #999;">${errorText}</p>`;
            }
        }

        async function deleteUser(username) {
            const confirmMsg = texts.users_confirm_delete_user
                ? texts.users_confirm_delete_user.replace('{username}', username)
                : `M√∂chtest du den Benutzer "${username}" wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!`;

            const confirmed = await showConfirmDialog(confirmMsg, texts.users_delete_title || 'Benutzer l√∂schen');
            if (!confirmed) return;

            try {
                const response = await apiCall(`/api/users/${username}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (response.ok) {
                    const successMsg = texts.users_user_deleted
                        ? texts.users_user_deleted.replace('{username}', username)
                        : `Benutzer "${username}" wurde erfolgreich gel√∂scht.`;
                    showSuccess(successMsg);
                    loadAllUsers();
                } else {
                    showError(data.error || texts.users_action_failed || 'Aktion fehlgeschlagen');
                }
            } catch (error) {
                console.error('deleteUser error:', error);
                showError(texts.users_network_error || 'Netzwerkfehler');
            }
        }

        const logout = () => authHandler.logout();

        function showAlert(id, message) {
            const alert = document.getElementById(id);
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 4000);
        }

        // Wrapper-Funktionen die Electron Toast oder Web Alert nutzen
        function showSuccess(msg) {
            // Pr√ºfe ob Electron Toast verf√ºgbar ist (window.showToast von toast.js)
            if (window.electronAPI && window.showToast) {
                window.showToast({ title: 'Erfolg', message: msg, type: 'success', duration: 4000 });
            } else {
                showAlert('successAlert', msg);
            }
        }
        function showError(msg) {
            // Pr√ºfe ob Electron Toast verf√ºgbar ist (window.showToast von toast.js)
            if (window.electronAPI && window.showToast) {
                window.showToast({ title: 'Fehler', message: msg, type: 'error', duration: 4000 });
            } else {
                showAlert('errorAlert', msg);
            }
        }

        // Wrapper f√ºr confirm() - nutzt Electron showConfirm oder native confirm
        async function showConfirmDialog(message, title = 'Best√§tigung') {
            if (window.electronAPI && window.showConfirm) {
                return await window.showConfirm({ title: title, message: message, type: 'warning' });
            } else {
                return confirm(message);
            }
        }

        // Custom language dropdown functions
        const langNames = { de: 'Deutsch', en: 'English', fr: 'Fran√ßais', es: 'Espa√±ol', it: 'Italiano' };

        function toggleLangDropdown() {
            document.getElementById('langDropdown').classList.toggle('open');
        }

        function selectLang(lang) {
            document.getElementById('languageSelect').value = lang;
            // Update selected display
            const selectedItem = document.querySelector(`.lang-dropdown-item[data-lang="${lang}"]`);
            if (selectedItem) {
                const flag = selectedItem.querySelector('.lang-flag');
                document.getElementById('langSelectedFlag').outerHTML = flag.cloneNode(true).outerHTML.replace('class="lang-flag"', 'class="lang-flag" id="langSelectedFlag"');
                document.getElementById('langSelectedText').textContent = selectedItem.querySelector('span').textContent;
            }
            // Update selected state
            document.querySelectorAll('.lang-dropdown-item').forEach(i => i.classList.remove('selected'));
            if (selectedItem) selectedItem.classList.add('selected');
            document.getElementById('langDropdown').classList.remove('open');
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('langDropdown');
            if (dd && !dd.contains(e.target)) dd.classList.remove('open');
        });

        // Language change functionality
        async function loadUserLanguage() {
            try {
                const response = await apiCall('/api/auth/language', { method: 'GET' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.language) {
                        document.getElementById('languageSelect').value = data.language;
                        selectLang(data.language);
                    }
                }
            } catch (error) {
                console.error('Error loading user language:', error);
            }
        }

        // Load user language when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadUserLanguage);
        } else {
            loadUserLanguage();
        }

        // Handle language form submission
        document.addEventListener('DOMContentLoaded', () => {
            const languageForm = document.getElementById('languageForm');
            if (languageForm) {
                languageForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const languageSelect = document.getElementById('languageSelect');
                    const selectedLanguage = languageSelect.value;

                    try {
                        const response = await apiCall('/api/auth/language', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ language: selectedLanguage })
                        });

                        if (response.ok) {
                            // Update localStorage
                            localStorage.setItem('language', selectedLanguage);

                            // Show success message
                            showSuccess(texts.users_language_changed || 'Language successfully changed!');

                            // Reload page to apply new language
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            const errorData = await response.json();
                            showError(errorData.error || texts.users_error_change_language || 'Error changing language.');
                        }
                    } catch (error) {
                        console.error('Language change error:', error);
                        showError(texts.users_network_error || 'Network error');
                    }
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);

            // Pr√ºfe, ob wir uns in der Android App befinden
            if (urlParams.get('app') === 'android') {
                const backButton = document.getElementById('back-to-dashboard');
                if (backButton) {
                    // Wandle den Link in einen Button um, der die native Java-Funktion aufruft.
                    backButton.href = "javascript:void(0);"; // Verhindert die Standard-Navigation

                    backButton.onclick = function(event) {
                        event.preventDefault(); // Stoppt das Link-Verhalten sicher

                        // Pr√ºfe, ob die Bridge-Funktion existiert
                        if (window.Android && typeof window.Android.goBackToDashboard === 'function') {
                            // Rufe die native Funktion in MainActivity.java auf
                            window.Android.goBackToDashboard();
                        } else {
                            // Fallback, falls die Bridge nicht da ist
                            console.error("Android Bridge nicht gefunden!");
                            window.location.href = '/?app=android';
                        }
                    };
                }
            }
        });
    </script>

    <script>
        // Periodic license status checking
        // Check every 60 seconds if license is still valid
        let licenseCheckInterval = null;

        function checkLicenseStatus() {
            fetch('/license/api/check', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    console.warn('License became invalid - redirecting to activation page');
                    // Clear interval before redirect
                    if (licenseCheckInterval) {
                        clearInterval(licenseCheckInterval);
                    }
                    // Redirect to license activation
                    window.location.href = '/license/activate';
                }
            })
            .catch(error => {
                console.error('Error checking license status:', error);
            });
        }

        // Start periodic checking when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initial check after 5 seconds
            setTimeout(checkLicenseStatus, 5000);

            // Then check every 60 seconds
            licenseCheckInterval = setInterval(checkLicenseStatus, 60000);
        });

        // Clean up interval when page unloads
        window.addEventListener('beforeunload', function() {
            if (licenseCheckInterval) {
                clearInterval(licenseCheckInterval);
            }
        });
    </script>
</body>
</html>
