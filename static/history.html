<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Druck-Historie - 3D Printer Dashboard</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css?v=2">
    <link rel="stylesheet" href="/static/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/design-tokens.css?v=2">
    <link rel="stylesheet" href="/static/css/base.css?v=2">
    <link rel="stylesheet" href="/static/css/tab-bar.css?v=2">
    <link rel="stylesheet" href="/static/css/modals.css?v=2">
    <link rel="stylesheet" href="/static/css/sd-card.css?v=4">
    <link rel="stylesheet" href="/static/css/history.css?v=1">

    <!-- Chart.js (local) -->
    <script src="/static/chart.umd.js"></script>

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
    </style>
</head>
<body>
    <!-- Apply dark mode immediately -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Shared Module Scripts -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/tab-bar-manager.js"></script>

    <div class="hist-container">
        <!-- Header -->
        <div class="hist-header">
            <h1 class="hist-header-title">
                üìä <span data-i18n="history_modal_title">Druck-Historie</span>
            </h1>
            <div class="hist-header-actions">
                <button class="hist-btn" onclick="window.location.reload()">
                    üîÑ <span data-i18n="refresh">Aktualisieren</span>
                </button>
                <button class="hist-btn" onclick="toggleHistorySettings()">
                    ‚öôÔ∏è <span data-i18n="settings">Einstellungen</span>
                </button>
            </div>
        </div>

        <!-- Main Content Card -->
        <div class="hist-content-card">
            <!-- Settings Panel -->
            <div id="history-settings-panel" class="hist-settings">
                <h3 class="hist-settings-title" data-i18n="history_settings_title">Einstellungen</h3>
                <div class="hist-settings-grid">
                    <div class="hist-settings-item">
                        <label for="hist_filament_cost" data-i18n="hist_filament_cost_label">Filament-Kosten (‚Ç¨/kg)</label>
                        <input type="number" id="hist_filament_cost" placeholder="25.00" step="0.01">
                    </div>
                    <div class="hist-settings-item">
                        <label for="hist_power_cost" data-i18n="hist_power_cost_label">Stromkosten (‚Ç¨/kWh)</label>
                        <input type="number" id="hist_power_cost" placeholder="0.30" step="0.01">
                    </div>
                    <div class="hist-settings-item">
                        <label for="hist_max_current" data-i18n="hist_max_current_label">Max. Aktuelle Drucke</label>
                        <select id="hist_max_current" class="hist-dropdown">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>
                <div class="hist-settings-footer">
                    <button onclick="saveHistorySettings()" class="hist-btn hist-btn--success">
                        üíæ <span data-i18n="save">Speichern</span>
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="hist-tabs">
                <button id="tab-current" class="hist-tab-btn active" onclick="switchHistoryTab('current')">
                    <span id="history-tab-current-text" data-i18n="history_tab_current">üìå Aktuelle</span>
                </button>
                <button id="tab-archive" class="hist-tab-btn" onclick="switchHistoryTab('archive')">
                    <span id="history-tab-archive-text" data-i18n="history_tab_archive">üìö Archiv</span>
                </button>
                <button id="tab-statistics" class="hist-tab-btn" onclick="switchHistoryTab('statistics')">
                    <span id="history-tab-statistics-text" data-i18n="history_tab_statistics">üìä Statistiken</span>
                </button>
            </div>

            <!-- Controls -->
            <div class="hist-controls">
                <select id="history-filter" class="hist-dropdown" onchange="loadHistory()">
                    <option value="" data-i18n="history_filter_all">Alle anzeigen</option>
                    <option value="success" data-i18n="history_filter_success">‚úÖ Erfolgreich</option>
                    <option value="failed" data-i18n="history_filter_failed">‚ùå Fehlgeschlagen</option>
                    <option value="running" data-i18n="history_filter_running">üîÑ Laufend</option>
                </select>
            </div>

            <!-- Current Tab -->
            <div id="history-list-current" class="hist-tab-content active">
                <div class="hist-empty">
                    <div class="loading"></div>
                    <p data-i18n="history_loading_current">Lade aktuelle Drucke...</p>
                </div>
            </div>

            <!-- Archive Tab -->
            <div id="history-list-archive" class="hist-tab-content">
                <div class="hist-empty">
                    <div class="loading"></div>
                    <p data-i18n="history_loading_archive">Lade Archiv...</p>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="history-list-statistics" class="hist-tab-content">
                <div class="hist-empty">
                    <div class="loading"></div>
                    <p data-i18n="history_calculating_stats">Berechne Statistiken...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Detail Modal -->
    <div id="printDetailModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
        <div class="modal-panel hist-detail-modal">
            <!-- Fixed Header -->
            <div class="sd-modal-header">
                <div class="hist-detail-header" style="flex:1; margin-bottom:0;">
                    <img id="detail-thumbnail" src="" class="hist-detail-thumb" style="display:none;">
                    <div class="hist-detail-info">
                        <h2 id="detail-title" class="hist-detail-title"></h2>
                        <div id="detail-info" class="hist-detail-meta"></div>
                    </div>
                </div>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closePrintDetails()">&times;</button>
                </div>
            </div>

            <!-- Fixed Tabs -->
            <div class="hist-detail-tabs-wrap">
                <div class="hist-detail-tabs">
                    <button class="hist-detail-tab active" onclick="switchDetailTab('overview')" data-tab="overview">
                        üìä <span id="detail-overview-tab-text" data-i18n="detail_overview_tab">√úbersicht</span>
                    </button>
                    <button class="hist-detail-tab" onclick="switchDetailTab('chart')" data-tab="chart">
                        üìà <span id="chart-tab-text" data-i18n="detail_chart_tab">Diagramm</span>
                    </button>
                    <button class="hist-detail-tab" onclick="switchDetailTab('events')" data-tab="events">
                        üìÖ <span id="detail-events-tab-text" data-i18n="detail_events_tab">Ereignisse</span>
                    </button>
                    <button id="timelapse-tab-btn" class="hist-detail-tab" onclick="switchDetailTab('timelapse')" data-tab="timelapse" style="display:none;">
                        üìπ <span id="detail-timelapse-tab-text" data-i18n="detail_timelapse_tab">Timelapse</span>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="hist-detail-body">
                <!-- Overview Tab -->
                <div id="overview-tab" class="detail-tab-content">
                    <div id="detail-stats"></div>
                </div>

                <!-- Chart Tab -->
                <div id="chart-tab" class="detail-tab-content" style="display:none;">
                    <div class="hist-chart-wrap">
                        <canvas id="printProgressChart" style="height:400px;"></canvas>
                    </div>
                </div>

                <!-- Events Tab -->
                <div id="events-tab" class="detail-tab-content" style="display:none;">
                    <div id="detail-events" class="hist-events-wrap"></div>
                </div>

                <!-- Timelapse Tab -->
                <div id="timelapse-tab" class="detail-tab-content" style="display:none;">
                    <div id="detail-timelapse"></div>
                </div>
            </div>

            <!-- Fixed Footer -->
            <div class="hist-detail-footer">
                <button onclick="reloadPrintDetails()" class="hist-btn">
                    üîÑ <span id="detail-refresh-text" data-i18n="detail_refresh">Aktualisieren</span>
                </button>
                <button onclick="exportPrintData()" class="hist-btn">
                    üíæ <span id="detail-export-text" data-i18n="detail_export_csv">CSV Export</span>
                </button>
                <button onclick="reprintFile()" class="hist-btn hist-btn--primary">
                    üîÑ <span id="detail-reprint-text" data-i18n="detail_reprint">Erneut drucken</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Day Statistics Modal -->
    <div id="dayStatisticsModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; padding:20px;">
        <div class="modal-panel sd-modal-panel" style="max-width:900px; max-height:90vh; overflow-y:auto;">
            <div class="sd-modal-header">
                <h2 id="day-statistics-title" class="sd-modal-title"></h2>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closeDayStatistics()">&times;</button>
                </div>
            </div>
            <div id="day-statistics-content" style="padding: 20px 25px;"></div>
        </div>
    </div>

    <script src="/static/auth-handler.js"></script>
    <script>
        // Global variables
        let costSettings = {
            filament_per_kg: 25,
            power_per_kwh: 0.30
        };
        let currentTab = 'current';
        let currentPrintData = null;
        let printProgressChart = null;

        // Get translations
        function getText(key, fallback = key) {
            return window.i18nManager ? window.i18nManager.getText(key, fallback) : fallback;
        }

        // Translation texts - will be populated after i18nManager loads
        let texts = {
            history_modal_title: 'Druck-Historie',
            history_loading_current: 'Lade aktuelle Drucke...',
            history_loading_archive: 'Lade Archiv...',
            history_calculating_stats: 'Berechne Statistiken...',
            stats_no_prints_history: 'Keine Drucke in der Historie',
            stats_no_data: 'Keine Daten verf√ºgbar',
            status_running: 'L√§uft',
            status_success: 'Erfolgreich',
            status_failed: 'Fehlgeschlagen',
            status_cancelled: 'Abgebrochen',
            unknown: 'Unbekannt',
            multifilament_count: '{count} Filamente',
            stats_layers_count: '{count} Schichten',
            confirm_delete_from_history: 'M√∂chten Sie diesen Druck wirklich aus der Historie l√∂schen?',
            toast_print_deleted: 'Druck gel√∂scht',
            toast_error_deleting: 'Fehler beim L√∂schen',
            console_delete_error: 'Fehler beim L√∂schen',
            console_history_error: 'Fehler beim Laden der Historie',
            settings_saved_msg: 'Einstellungen gespeichert',
            toast_error_saving: 'Fehler beim Speichern',
            history_tab_current_count: 'Aktuelle ({count})',
            history_tab_archive_count: 'Archiv ({count})',
            stats_total: 'Gesamt',
            stats_prints: 'Drucke',
            stats_print_singular: 'Druck',
            stats_prints_plural: 'Drucke',
            stats_successful: 'Erfolgreich',
            stats_success_rate: 'Erfolgsquote',
            stats_total_time: 'Gesamtzeit',
            stats_average_time: '√ò {hours}h {minutes}m',
            stats_filament_label: 'Filament',
            stats_average_filament: '√ò {grams}g',
            stats_cost_overview: 'Kosten√ºbersicht',
            stats_filament_cost: 'Filament-Kosten',
            stats_power_cost: 'Stromkosten',
            stats_total_cost: 'Gesamtkosten',
            stats_avg_per_print: '√ò pro Druck',
            stats_records: 'Rekorde',
            stats_longest_print: 'L√§ngster Druck',
            stats_most_filament: 'Meistes Filament',
            stats_highest_layers: 'H√∂chste Schichtzahl',
            stats_filament_usage: 'Filament-Verbrauch',
            stats_percent_grams_prints: '{percent}% ‚Ä¢ {grams}g ‚Ä¢ {count} {prints}',
            stats_time_analysis: 'Zeitanalyse',
            stats_prints_per_weekday: 'Drucke pro Wochentag',
            stats_weekday_monday: 'Mo',
            stats_weekday_tuesday: 'Di',
            stats_weekday_wednesday: 'Mi',
            stats_weekday_thursday: 'Do',
            stats_weekday_friday: 'Fr',
            stats_weekday_saturday: 'Sa',
            stats_weekday_sunday: 'So',
            stats_weekday_name_sunday: 'Sonntag',
            stats_weekday_name_monday: 'Montag',
            stats_weekday_name_tuesday: 'Dienstag',
            stats_weekday_name_wednesday: 'Mittwoch',
            stats_weekday_name_thursday: 'Donnerstag',
            stats_weekday_name_friday: 'Freitag',
            stats_weekday_name_saturday: 'Samstag',
            stats_most_active_day: 'Aktivster Tag',
            stats_most_active_time: 'Aktivste Uhrzeit',
            stats_trend_30_days: 'Trend (30 Tage)',
            stats_total_30_days: 'Gesamt: {count} Drucke',
            stats_for_all_weekday: 'Statistik f√ºr alle {weekday}',
            stats_prints_for_date: 'Drucke vom {date}',
            stats_all_weekdays: 'alle {weekday}',
            stats_no_prints_day: 'Keine Drucke an diesem Tag',
            stats_total_label: 'Gesamt',
            stats_print_time: 'Druckzeit',
            stats_prints_list_for: 'Drucke f√ºr {date}',
            console_error_loading_daily_stats: 'Fehler beim Laden der Tagesstatistiken',
            stats_error_loading_data: 'Fehler beim Laden der Daten',
            detail_loading: 'Lade...',
            detail_overview_tab: '√úbersicht',
            detail_chart_tab: 'Diagramm',
            detail_events_tab: 'Ereignisse',
            detail_timelapse_tab: 'Timelapse',
            detail_refresh: 'Aktualisieren',
            detail_export_csv: 'CSV Export',
            detail_reprint: 'Erneut drucken',
            detail_duration: 'Dauer',
            detail_start: 'Start',
            detail_end: 'Ende',
            detail_layers: 'Schichten',
            detail_used_filaments: 'Verwendete Filamente',
            detail_temperatures: 'Temperaturen',
            detail_nozzle: 'D√ºse',
            detail_bed: 'Bett',
            detail_max: 'Max',
            detail_consumption_costs: 'Verbrauch & Kosten',
            detail_filament: 'Filament',
            detail_power: 'Strom',
            detail_costs: 'Kosten',
            detail_print_progress: 'Druckfortschritt',
            detail_final_progress: 'Endfortschritt',
            detail_print_settings: 'Druckeinstellungen',
            detail_layer_height: 'Schichth√∂he',
            detail_infill: 'F√ºllung',
            detail_wall_loops: 'Wandschleifen',
            detail_speed: 'Geschwindigkeit',
            detail_support: 'St√ºtzen',
            detail_support_active: 'Aktiv',
            detail_support_off: 'Aus',
            detail_nozzle_diameter: 'D√ºsendurchmesser',
            console_error_checking_timelapse: 'Fehler beim Pr√ºfen des Timelapse',
            console_detail_error: 'Fehler beim Laden der Details',
            alert_error_loading_details: 'Fehler beim Laden der Details',
            chart_label_progress: 'Fortschritt (%)',
            chart_label_nozzle: 'D√ºse (¬∞C)',
            chart_label_bed: 'Bett (¬∞C)',
            chart_label_power: 'Leistung (W)',
            chart_axis_temperature: 'Temperatur (¬∞C)',
            events_header: 'Ereignisse',
            events_no_events: 'Keine Ereignisse',
            events_layer_milestones: 'Schicht-Meilensteine',
            timelapse_no_video: 'Kein Timelapse verf√ºgbar',
            timelapse_not_activated: 'Timelapse war f√ºr diesen Druck nicht aktiviert',
            console_error_loading_timelapse: 'Fehler beim Laden des Timelapse',
            timelapse_available_videos: 'Verf√ºgbare Videos',
            timelapse_no_videos_found: 'Keine Videos gefunden',
            console_error_loading_video_list: 'Fehler beim Laden der Videoliste',
            timelapse_error_loading_video_list: 'Fehler beim Laden der Videoliste',
            console_error_loading_settings: 'Fehler beim Laden der Einstellungen',
            console_error_saving: 'Fehler beim Speichern',
            console_thumbnail_error: 'Thumbnail-Fehler',
            toast_no_data_reload: 'Keine Daten zum Aktualisieren'
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            if (window.tabBarManager) {
                window.tabBarManager.render();
            }

            if (window.i18nManager) {
                texts = window.i18nManager.getAllTexts();
                window.i18nManager.applyTranslations();
                document.title = getText('history_modal_title', 'Druck-Historie') + ' - 3D Printer Dashboard';
            }

            loadHistorySettings().then(() => {
                loadHistory();
            });
        });

        function toggleSidebar() {}

        // Settings functions
        async function loadHistorySettings() {
            try {
                const response = await apiCall('/api/config');
                const config = await response.json();

                costSettings.filament_per_kg = config.costs?.filament_per_kg || 25;
                costSettings.power_per_kwh = config.costs?.power_per_kwh || 0.30;

                if (document.getElementById('hist_filament_cost')) {
                    document.getElementById('hist_filament_cost').value = costSettings.filament_per_kg;
                    document.getElementById('hist_power_cost').value = costSettings.power_per_kwh;
                }

                const maxCurrent = localStorage.getItem('history_max_current') || '10';
                if (document.getElementById('hist_max_current')) {
                    document.getElementById('hist_max_current').value = maxCurrent;
                }
            } catch (error) {
                console.error(texts.console_error_loading_settings + ':', error);
                costSettings.filament_per_kg = 25;
                costSettings.power_per_kwh = 0.30;
            }
        }

        async function saveHistorySettings() {
            const maxCurrent = document.getElementById('hist_max_current').value;
            localStorage.setItem('history_max_current', maxCurrent);

            const settings = {
                costs: {
                    filament_per_kg: parseFloat(document.getElementById('hist_filament_cost').value) || 25,
                    power_per_kwh: parseFloat(document.getElementById('hist_power_cost').value) || 0.30
                }
            };

            try {
                const response = await apiCall('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    costSettings.filament_per_kg = settings.costs.filament_per_kg;
                    costSettings.power_per_kwh = settings.costs.power_per_kwh;
                    alert('‚úÖ ' + texts.settings_saved_msg);
                    document.getElementById('history-settings-panel').classList.remove('active');
                    loadHistory();
                } else {
                    alert('‚ùå ' + texts.toast_error_saving);
                }
            } catch (error) {
                console.error(texts.console_error_saving + ':', error);
                alert('‚ùå ' + texts.toast_error_saving);
            }
        }

        function toggleHistorySettings() {
            const panel = document.getElementById('history-settings-panel');
            panel.classList.toggle('active');
        }

        // Tab switching
        function switchHistoryTab(tab) {
            document.querySelectorAll('.hist-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');

            document.querySelectorAll('.hist-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('history-list-' + tab).classList.add('active');

            currentTab = tab;
        }

        // Load history data
        async function loadHistory() {
            const filter = document.getElementById('history-filter').value;
            const url = filter ? `/api/history?status=${filter}` : '/api/history';

            try {
                const response = await apiCall(url);
                const data = await response.json();

                if (data.prints && data.prints.length > 0) {
                    const maxCurrent = parseInt(localStorage.getItem('history_max_current') || '10');
                    const currentPrints = data.prints.slice(0, maxCurrent);
                    const archivePrints = data.prints.slice(maxCurrent);

                    document.getElementById('history-tab-current-text').textContent =
                        `üìå ${texts.history_tab_current_count.replace('{count}', currentPrints.length)}`;
                    document.getElementById('history-tab-archive-text').textContent =
                        `üìö ${texts.history_tab_archive_count.replace('{count}', archivePrints.length)}`;

                    renderCurrentList(currentPrints);
                    renderArchiveList(archivePrints);
                    calculateStatistics(data.prints);
                } else {
                    document.getElementById('history-list-current').innerHTML = `
                        <div class="hist-empty">
                            <span class="hist-empty-icon">üì≠</span>
                            <p>${texts.stats_no_prints_history}</p>
                        </div>
                    `;
                    document.getElementById('history-list-archive').innerHTML = '';
                    document.getElementById('history-tab-current-text').textContent = 'üìå Aktuelle (0)';
                    document.getElementById('history-tab-archive-text').textContent = 'üìö Archiv (0)';
                }
            } catch (error) {
                console.error(texts.console_history_error + ':', error);
                document.getElementById('history-list-current').innerHTML = `
                    <div class="hist-empty">
                        <span style="color: var(--accent-red);">‚ùå ${texts.console_history_error}</span>
                    </div>
                `;
            }
        }

        // Render history card HTML (shared by current + archive)
        function renderHistoryCard(print) {
            const duration = print.duration_minutes !== null && print.duration_minutes !== undefined ?
                (print.duration_minutes === 0 ? '< 1m' :
                 `${Math.floor(print.duration_minutes/60)}h ${print.duration_minutes%60}m`) :
                (print.status === 'running' ? texts.status_running : texts.unknown);

            const statusIcon = {
                'success': '‚úÖ', 'failed': '‚ùå', 'cancelled': '‚ö†Ô∏è', 'running': 'üîÑ'
            }[print.status] || '‚ùì';

            const statusColor = {
                'success': '#4caf50', 'failed': '#f44336', 'cancelled': '#ff9800', 'running': '#2196f3'
            }[print.status] || '#999';

            const statusText = {
                'success': texts.status_success, 'failed': texts.status_failed,
                'cancelled': texts.status_cancelled, 'running': texts.status_running
            }[print.status] || print.status;

            const progress = print.status === 'success' ? 100 :
                           print.status === 'failed' || print.status === 'cancelled' ?
                           (print.last_progress || 0) : 0;

            return `
                <div class="hist-card" onclick="showPrintDetails(${print.id})">
                    ${print.has_thumbnail ?
                        `<img src="/api/history/${print.id}/thumbnail" class="hist-thumb"
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="hist-thumb-icon" style="display:none; background:${statusColor}20;">
                            ${statusIcon}
                         </div>` :
                        `<div class="hist-thumb-icon" style="background:${statusColor}20;">
                            ${statusIcon}
                        </div>`
                    }
                    <div class="hist-card-content">
                        <div class="hist-card-header">
                            <div class="hist-filename">${print.filename}</div>
                            <div class="hist-status" style="color:${statusColor};">
                                <span class="hist-status-dot">‚óè</span>
                                <span>${statusText}</span>
                            </div>
                        </div>
                        <div class="hist-progress">
                            <div class="hist-progress-bar" style="width:${progress}%; background:${statusColor};"></div>
                        </div>
                        <div class="hist-details">
                            <span>üìÖ ${new Date(print.start_time).toLocaleDateString('de-DE')}</span>
                            <span>‚è±Ô∏è ${duration}</span>
                            ${print.total_layers ? `<span>üìö ${print.total_layers} Layer</span>` : ''}
                            ${print.filament_used ? `<span>üßµ ${(print.filament_used/1000).toFixed(1)}m</span>` : ''}
                            ${print.is_multifilament ?
                                `<span class="hist-multi-badge">
                                    üé® ${texts.multifilament_count.replace('{count}', print.filament_count)}
                                </span>` :
                                (print.filament_type ? `<span>üé® ${print.filament_type}</span>` : '')
                            }
                        </div>
                    </div>
                    <div class="hist-card-actions">
                        <button onclick="event.stopPropagation(); showPrintDetails(${print.id})" class="hist-btn hist-btn--primary hist-btn--small">
                            üìä Details
                        </button>
                        <button onclick="event.stopPropagation(); deletePrintHistory(${print.id}, event)" class="hist-btn hist-btn--danger hist-btn--small" title="${texts.delete || 'L√∂schen'}">
                            ${texts.delete || 'L√∂schen'}
                        </button>
                    </div>
                </div>
            `;
        }

        // Render current list
        function renderCurrentList(prints) {
            const container = document.getElementById('history-list-current');
            container.innerHTML = prints.map(print => renderHistoryCard(print)).join('');
        }

        // Render archive list
        function renderArchiveList(prints) {
            const container = document.getElementById('history-list-archive');
            if (prints.length === 0) {
                container.innerHTML = `
                    <div class="hist-empty">
                        <span class="hist-empty-icon">üìö</span>
                        <p>Noch keine archivierten Drucke</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = prints.map(print => renderHistoryCard(print)).join('');
        }

        // Calculate and render statistics
        function calculateStatistics(prints) {
            if (!prints || prints.length === 0) {
                document.getElementById('history-list-statistics').innerHTML = `
                    <div class="hist-empty">
                        <span class="hist-empty-icon">üìä</span>
                        <p>${texts.stats_no_data}</p>
                    </div>
                `;
                return;
            }

            const stats = {
                total: prints.length,
                successful: prints.filter(p => p.status === 'success').length,
                failed: prints.filter(p => p.status === 'failed').length,
                cancelled: prints.filter(p => p.status === 'cancelled').length,
                running: prints.filter(p => p.status === 'running').length,
                totalTime: prints.reduce((sum, p) => sum + (p.duration_minutes || 0), 0),
                totalFilament: prints.reduce((sum, p) => sum + (p.filament_grams || 0), 0),
                totalLayers: prints.reduce((sum, p) => sum + (p.total_layers || 0), 0),
                avgTime: 0, avgFilament: 0, avgLayers: 0,
                longestPrint: null, shortestPrint: null, mostFilament: null, mostLayers: null,
                filamentTypes: {}, filamentColors: {},
                totalFilamentCost: 0, totalPowerCost: 0, avgCost: 0
            };

            const timeAnalysis = {
                weekdays: [0,0,0,0,0,0,0],
                hours: new Array(24).fill(0),
                last30Days: [],
                mostActiveDay: '', mostActiveHour: ''
            };

            const now = new Date();
            const thirtyDaysAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);

            prints.forEach(p => {
                const startDate = new Date(p.start_time);
                timeAnalysis.weekdays[startDate.getDay()]++;
                timeAnalysis.hours[startDate.getHours()]++;

                if (startDate >= thirtyDaysAgo) {
                    const dateStr = startDate.toISOString().split('T')[0];
                    const existing = timeAnalysis.last30Days.find(d => d.date === dateStr);
                    if (existing) existing.count++;
                    else timeAnalysis.last30Days.push({ date: dateStr, count: 1 });
                }
            });

            const weekdayNames = [
                texts.stats_weekday_name_sunday, texts.stats_weekday_name_monday,
                texts.stats_weekday_name_tuesday, texts.stats_weekday_name_wednesday,
                texts.stats_weekday_name_thursday, texts.stats_weekday_name_friday,
                texts.stats_weekday_name_saturday
            ];
            const maxWeekday = Math.max(...timeAnalysis.weekdays);
            const maxWeekdayIndex = timeAnalysis.weekdays.indexOf(maxWeekday);
            timeAnalysis.mostActiveDay = weekdayNames[maxWeekdayIndex];

            const maxHour = Math.max(...timeAnalysis.hours);
            const maxHourIndex = timeAnalysis.hours.indexOf(maxHour);
            timeAnalysis.mostActiveHour = `${maxHourIndex}:00 - ${maxHourIndex + 1}:00`;

            timeAnalysis.last30Days.sort((a, b) => new Date(a.date) - new Date(b.date));

            const successfulPrints = prints.filter(p => p.status === 'success');
            if (successfulPrints.length > 0) {
                stats.avgTime = Math.round(stats.totalTime / successfulPrints.length);
                stats.avgFilament = Math.round(successfulPrints.reduce((sum, p) => sum + (p.filament_grams || 0), 0) / successfulPrints.length);
                stats.avgLayers = Math.round(successfulPrints.reduce((sum, p) => sum + (p.total_layers || 0), 0) / successfulPrints.length);
                stats.longestPrint = successfulPrints.reduce((max, p) => (!max || (p.duration_minutes || 0) > (max.duration_minutes || 0)) ? p : max, null);
                stats.shortestPrint = successfulPrints.reduce((min, p) => (!min || ((p.duration_minutes || 0) < (min.duration_minutes || 0) && p.duration_minutes > 0)) ? p : min, null);
                stats.mostFilament = successfulPrints.reduce((max, p) => (!max || (p.filament_grams || 0) > (max.filament_grams || 0)) ? p : max, null);
                stats.mostLayers = successfulPrints.reduce((max, p) => (!max || (p.total_layers || 0) > (max.total_layers || 0)) ? p : max, null);
            }

            const filamentGramsPerType = {};
            const filamentCountPerType = {};
            prints.forEach(p => {
                if (p.is_multifilament && p.filament_details && p.filament_details.length > 0) {
                    p.filament_details.forEach(fil => {
                        if (fil.name) {
                            filamentGramsPerType[fil.name] = (filamentGramsPerType[fil.name] || 0) + (fil.used_grams || 0);
                            filamentCountPerType[fil.name] = (filamentCountPerType[fil.name] || 0) + 1;
                        }
                    });
                } else if (p.filament_type) {
                    filamentGramsPerType[p.filament_type] = (filamentGramsPerType[p.filament_type] || 0) + (p.filament_grams || 0);
                    filamentCountPerType[p.filament_type] = (filamentCountPerType[p.filament_type] || 0) + 1;
                }
            });
            stats.filamentTypes = filamentGramsPerType;

            if (costSettings) {
                stats.totalFilamentCost = ((stats.totalFilament / 1000) * costSettings.filament_per_kg).toFixed(2);
                const totalHours = stats.totalTime / 60;
                stats.totalPowerCost = ((200 * totalHours / 1000) * costSettings.power_per_kwh).toFixed(2);
                stats.avgCost = (successfulPrints.length > 0 ?
                    ((parseFloat(stats.totalFilamentCost) + parseFloat(stats.totalPowerCost)) / successfulPrints.length).toFixed(2) : 0);
            }

            const successRate = Math.round((stats.successful / stats.total) * 100);

            // Build HTML with CSS classes
            let html = `
                <div class="hist-stats-grid">
                    <div class="hist-stat-card">
                        <div class="hist-stat-row">
                            <span class="hist-stat-icon">üñ®Ô∏è</span>
                            <div>
                                <div class="hist-stat-label">${texts.stats_total}</div>
                                <div class="hist-stat-value">${stats.total} ${texts.stats_prints}</div>
                            </div>
                        </div>
                        <div class="hist-stat-breakdown">
                            <span>‚úÖ ${stats.successful}</span>
                            <span>‚ùå ${stats.failed}</span>
                            ${stats.cancelled > 0 ? `<span>‚ö†Ô∏è ${stats.cancelled}</span>` : ''}
                            ${stats.running > 0 ? `<span>üîÑ ${stats.running}</span>` : ''}
                        </div>
                    </div>
                    <div class="hist-stat-card">
                        <div class="hist-stat-row">
                            <span class="hist-stat-icon">üìà</span>
                            <div>
                                <div class="hist-stat-label">${texts.stats_success_rate}</div>
                                <div class="hist-stat-value">${successRate}%</div>
                            </div>
                        </div>
                        <div class="hist-rate-bar">
                            <div class="hist-rate-fill" style="width:${successRate}%;"></div>
                        </div>
                    </div>
                    <div class="hist-stat-card">
                        <div class="hist-stat-row">
                            <span class="hist-stat-icon">‚è±Ô∏è</span>
                            <div>
                                <div class="hist-stat-label">${texts.stats_total_time}</div>
                                <div class="hist-stat-value" style="font-size:16px;">${Math.floor(stats.totalTime/60)}h ${stats.totalTime%60}m</div>
                                <div class="hist-stat-sub">${texts.stats_average_time.replace('{hours}', Math.floor(stats.avgTime/60)).replace('{minutes}', stats.avgTime%60)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="hist-stat-card">
                        <div class="hist-stat-row">
                            <span class="hist-stat-icon">üßµ</span>
                            <div>
                                <div class="hist-stat-label">${texts.stats_filament_label}</div>
                                <div class="hist-stat-value" style="font-size:16px;">${stats.totalFilament.toFixed(0)}g</div>
                                <div class="hist-stat-sub">${texts.stats_average_filament.replace('{grams}', stats.avgFilament.toFixed(0))}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Costs -->
                <div class="hist-section">
                    <h4 class="hist-section-title">üí∞ ${texts.stats_cost_overview}</h4>
                    <div class="hist-costs-grid">
                        <div>
                            <div class="hist-cost-label">${texts.stats_filament_cost}</div>
                            <div class="hist-cost-value">‚Ç¨${stats.totalFilamentCost}</div>
                        </div>
                        <div>
                            <div class="hist-cost-label">${texts.stats_power_cost}</div>
                            <div class="hist-cost-value">‚Ç¨${stats.totalPowerCost}</div>
                        </div>
                        <div>
                            <div class="hist-cost-label">${texts.stats_total_cost}</div>
                            <div class="hist-cost-value hist-cost-value--accent">‚Ç¨${(parseFloat(stats.totalFilamentCost) + parseFloat(stats.totalPowerCost)).toFixed(2)}</div>
                        </div>
                        <div>
                            <div class="hist-cost-label">${texts.stats_avg_per_print}</div>
                            <div class="hist-cost-value">‚Ç¨${stats.avgCost}</div>
                        </div>
                    </div>
                </div>

                <!-- Records -->
                <div class="hist-section">
                    <h4 class="hist-section-title">üèÜ ${texts.stats_records}</h4>
                    <div class="hist-records-grid">
            `;

            if (stats.longestPrint) {
                html += `
                    <div class="hist-record-card">
                        <div class="hist-record-label">${texts.stats_longest_print}</div>
                        <div class="hist-record-name">${stats.longestPrint.filename || texts.unknown}</div>
                        <div class="hist-record-value" style="color:var(--accent-blue);">${Math.floor(stats.longestPrint.duration_minutes/60)}h ${stats.longestPrint.duration_minutes%60}m</div>
                    </div>
                `;
            }
            if (stats.mostFilament) {
                html += `
                    <div class="hist-record-card">
                        <div class="hist-record-label">${texts.stats_most_filament}</div>
                        <div class="hist-record-name">${stats.mostFilament.filename || texts.unknown}</div>
                        <div class="hist-record-value" style="color:var(--accent-green);">${stats.mostFilament.filament_grams ? stats.mostFilament.filament_grams.toFixed(1) : '0'}g</div>
                    </div>
                `;
            }
            if (stats.mostLayers) {
                html += `
                    <div class="hist-record-card">
                        <div class="hist-record-label">${texts.stats_highest_layers}</div>
                        <div class="hist-record-name">${stats.mostLayers.filename || texts.unknown}</div>
                        <div class="hist-record-value" style="color:var(--accent-yellow);">${texts.stats_layers_count.replace('{count}', stats.mostLayers.total_layers)}</div>
                    </div>
                `;
            }

            html += `</div></div>`;

            // Filament types
            if (Object.keys(stats.filamentTypes).length > 0) {
                const sortedTypes = Object.entries(stats.filamentTypes).sort((a, b) => b[1] - a[1]);
                const maxGrams = sortedTypes[0][1];

                html += `
                    <div class="hist-section">
                        <h4 class="hist-section-title">üßµ ${texts.stats_filament_usage}</h4>
                        <div class="hist-filament-list">
                `;

                sortedTypes.forEach(([type, grams]) => {
                    const count = filamentCountPerType[type] || 0;
                    const percentage = Math.round((count / stats.total) * 100);
                    const barWidth = (grams / maxGrams) * 100;
                    let color = getFilamentColor(type);
                    const printText = count === 1 ? texts.stats_print_singular : texts.stats_prints_plural;

                    html += `
                        <div>
                            <div class="hist-filament-name">${type}</div>
                            <div class="hist-filament-bar-bg">
                                <div class="hist-filament-bar" style="background:${color}; width:${barWidth}%;"></div>
                                <div class="hist-filament-bar-text">
                                    ${texts.stats_percent_grams_prints
                                        .replace('{percent}', percentage)
                                        .replace('{grams}', Math.round(grams))
                                        .replace('{count}', count)
                                        .replace('{prints}', printText)}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }

            // Time Analysis
            const isMobile = window.innerWidth <= 768;

            html += `
                <div class="hist-section">
                    <h4 class="hist-section-title">üìÖ ${texts.stats_time_analysis}</h4>

                    <div style="margin-bottom:20px;">
                        <div class="hist-stat-sub" style="margin-bottom:10px;">${texts.stats_prints_per_weekday}</div>
                        <div class="hist-weekday-chart" style="gap:${isMobile ? '4px' : '8px'};">
            `;

            const maxWeekdayCount = Math.max(...timeAnalysis.weekdays);
            const weekdayShort = [
                texts.stats_weekday_monday, texts.stats_weekday_tuesday, texts.stats_weekday_wednesday,
                texts.stats_weekday_thursday, texts.stats_weekday_friday, texts.stats_weekday_saturday,
                texts.stats_weekday_sunday
            ];
            weekdayShort.forEach((day, index) => {
                const dataIndex = index === 6 ? 0 : index + 1;
                const count = timeAnalysis.weekdays[dataIndex];
                const maxHeight = isMobile ? 40 : 60;
                const height = maxWeekdayCount > 0 ? (count / maxWeekdayCount) * maxHeight : 2;
                const isMax = count === maxWeekdayCount && count > 0;

                html += `
                    <div class="hist-weekday-col" style="cursor:${count > 0 ? 'pointer' : 'default'};"
                         onclick="${count > 0 ? `showDayStatistics(null, '${weekdayNames[dataIndex]}')` : ''}">
                        <div class="hist-weekday-bar-wrap">
                            ${count > 0 ? `<span class="hist-weekday-count">${count}</span>` : ''}
                            <div class="hist-weekday-bar ${isMax ? 'hist-weekday-bar--max' : 'hist-weekday-bar--normal'}" style="height:${height}px;"
                                 onmouseover="if(${count} > 0) this.style.opacity='0.8'"
                                 onmouseout="this.style.opacity='1'"></div>
                        </div>
                        <div class="hist-weekday-label">${day}</div>
                    </div>
                `;
            });

            html += `
                        </div>
                    </div>

                    <div class="hist-active-grid">
                        <div class="hist-record-card">
                            <div class="hist-record-label">${texts.stats_most_active_day}</div>
                            <div style="color:var(--text-primary); font-size:14px; font-weight:500;">${timeAnalysis.mostActiveDay}</div>
                            <div class="hist-record-value" style="color:var(--accent-blue);">${maxWeekdayCount} ${maxWeekdayCount === 1 ? texts.stats_print_singular : texts.stats_prints_plural}</div>
                        </div>
                        <div class="hist-record-card">
                            <div class="hist-record-label">${texts.stats_most_active_time}</div>
                            <div style="color:var(--text-primary); font-size:14px; font-weight:500;">${timeAnalysis.mostActiveHour}</div>
                            <div class="hist-record-value" style="color:var(--accent-green);">${Math.max(...timeAnalysis.hours)} ${Math.max(...timeAnalysis.hours) === 1 ? texts.stats_print_singular : texts.stats_prints_plural}</div>
                        </div>
                    </div>

                    <div>
                        <div class="hist-stat-sub" style="margin-bottom:8px;">${texts.stats_trend_30_days}</div>
                        <div class="hist-trend-wrap" style="gap:${isMobile ? '1px' : '2px'}; height:${isMobile ? '50px' : '80px'};">
                    `;

            const filledDays = [];
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now - i * 24 * 60 * 60 * 1000);
                const dateStr = date.toISOString().split('T')[0];
                const dayData = timeAnalysis.last30Days.find(d => d.date === dateStr);
                filledDays.push({ date: dateStr, count: dayData ? dayData.count : 0 });
            }

            const maxDayCount = Math.max(...filledDays.map(d => d.count));

            filledDays.forEach(day => {
                const maxBarHeight = isMobile ? 30 : 50;
                const height = maxDayCount > 0 ? (day.count / maxDayCount) * maxBarHeight : 2;
                const isToday = day.date === new Date().toISOString().split('T')[0];

                html += `
                    <div class="hist-trend-day ${isToday ? 'hist-trend-day--today' : ''}" style="min-width:${isMobile ? '8px' : '10px'}; cursor:${day.count > 0 ? 'pointer' : 'default'};"
                         onclick="${day.count > 0 ? `showDayStatistics('${day.date}')` : ''}">
                        <div class="hist-trend-bar ${day.count > 0 ? 'hist-trend-bar--active' : 'hist-trend-bar--empty'}"
                             style="height:${height}px;"
                             title="${new Date(day.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })}: ${day.count} Drucke"
                             onmouseover="if(${day.count} > 0) this.style.opacity='0.8'"
                             onmouseout="this.style.opacity='1'"></div>
                    </div>
                `;
            });

            html += `
                        </div>
                        <div class="hist-trend-total">
                            ${texts.stats_total_30_days.replace('{count}', timeAnalysis.last30Days.reduce((sum, d) => sum + d.count, 0))}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('history-list-statistics').innerHTML = html;
        }

        // Get filament color based on name
        function getFilamentColor(type) {
            const typeLower = type.toLowerCase();
            if (typeLower.includes('black') || typeLower.includes('schwarz')) return '#2c2c2c';
            if (typeLower.includes('white') || typeLower.includes('wei√ü')) return '#e0e0e0';
            if (typeLower.includes('red') || typeLower.includes('rot')) return '#dc3545';
            if (typeLower.includes('green') || typeLower.includes('gr√ºn')) return '#28a745';
            if (typeLower.includes('blue') || typeLower.includes('blau')) return '#007bff';
            if (typeLower.includes('yellow') || typeLower.includes('gelb')) return '#ffc107';
            if (typeLower.includes('orange')) return '#fd7e14';
            if (typeLower.includes('purple') || typeLower.includes('violet') || typeLower.includes('lila')) return '#6f42c1';
            if (typeLower.includes('pink') || typeLower.includes('rosa')) return '#e83e8c';
            if (typeLower.includes('beige') || typeLower.includes('sand')) return '#c8b88b';
            if (typeLower.includes('brown') || typeLower.includes('braun')) return '#795548';
            if (typeLower.includes('grey') || typeLower.includes('gray') || typeLower.includes('grau')) return '#6c757d';
            if (typeLower.includes('silver') || typeLower.includes('silber')) return '#b8b8b8';
            if (typeLower.includes('gold')) return '#ffb700';
            if (typeLower.includes('military')) return '#4b5320';
            if (typeLower.includes('brick') || typeLower.includes('ziegel')) return '#8b4513';
            if (typeLower.includes('pastel') && typeLower.includes('pink')) return '#ffb3d9';
            return '#666';
        }

        // Custom Confirm Dialog (gleicher Stil wie index.html)
        function showConfirmDialog(message, title = 'Best√§tigung') {
            return new Promise((resolve) => {
                const existing = document.getElementById('customConfirmDialog');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'customConfirmDialog';
                modal.className = 'modal-overlay';
                modal.style.cssText = 'display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;';

                modal.innerHTML = `
                    <div class="modal-panel sd-modal-panel" style="max-width:420px;">
                        <div class="sd-modal-header">
                            <h2 class="sd-modal-title">‚ö†Ô∏è ${title}</h2>
                        </div>
                        <div class="sd-modal-body">
                            <div style="color:var(--text-primary); font-size:14px; line-height:1.6;">${message}</div>
                            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                                <button class="hist-btn" id="confirm-cancel-btn">${texts.cancel || 'Abbrechen'}</button>
                                <button class="hist-btn hist-btn--danger" id="confirm-ok-btn">${texts.confirm_ok || 'L√∂schen'}</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const close = (result) => {
                    modal.remove();
                    resolve(result);
                };

                document.getElementById('confirm-ok-btn').addEventListener('click', () => close(true));
                document.getElementById('confirm-cancel-btn').addEventListener('click', () => close(false));
                modal.addEventListener('click', (e) => { if (e.target === modal) close(false); });
            });
        }

        // Custom Toast (Name showWebToast um Konflikt mit Electron toast.js zu vermeiden)
        function showWebToast(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.web-toast');
            existingToasts.forEach(t => t.remove());

            const isDark = document.body.classList.contains('dark-mode');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const toast = document.createElement('div');
            toast.className = 'web-toast';
            toast.style.cssText = `background:${isDark ? 'rgba(26,31,46,0.95)' : 'rgba(255,255,255,0.95)'}; color:${isDark ? '#e2e8f0' : '#1a1f2e'}; border:1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}; backdrop-filter:blur(12px);`;
            toast.textContent = `${icons[type] || ''} ${message}`;
            document.body.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Delete print from history
        async function deletePrintHistory(printId, event) {
            if (event) event.stopPropagation();
            const confirmed = await showConfirmDialog(texts.confirm_delete_from_history, texts.confirm_title || 'Best√§tigung');
            if (!confirmed) return;

            try {
                const response = await apiCall(`/api/history/${printId}`, { method: 'DELETE' });
                if (response.ok) {
                    showWebToast(texts.toast_print_deleted, 'success');
                    loadHistory();
                } else {
                    showWebToast(texts.toast_error_deleting, 'error');
                }
            } catch (error) {
                console.error(texts.console_delete_error + ':', error);
                showToast(texts.toast_error_deleting, 'error');
            }
        }

        // Show print details
        async function showPrintDetails(printId) {
            document.getElementById('printDetailModal').style.display = 'flex';

            try {
                const response = await apiCall(`/api/history/${printId}`);
                const data = await response.json();
                currentPrintData = data;

                const timelapseBtn = document.getElementById('timelapse-tab-btn');
                if (timelapseBtn && data.print.status !== 'running' && data.print.timelapse_enabled) {
                    apiCall(`/api/history/${printId}/timelapse_status`)
                        .then(res => res.json())
                        .then(status => {
                            if (status.available) timelapseBtn.style.display = 'block';
                        })
                        .catch(err => console.error('Timelapse check failed:', err));
                }

                const filename = data.print.filename;
                document.getElementById('detail-title').textContent =
                    filename.length > 50 ? filename.substring(0, 47) + '...' : filename;

                const thumbImg = document.getElementById('detail-thumbnail');
                if (data.print.thumbnail_base64) {
                    thumbImg.src = `/api/history/${printId}/thumbnail`;
                    thumbImg.style.display = 'block';
                } else {
                    thumbImg.style.display = 'none';
                }

                showOverviewTab(data);
                switchDetailTab('overview');
            } catch (error) {
                console.error(texts.console_detail_error + ':', error);
                alert(texts.alert_error_loading_details);
            }
        }

        // Show overview tab
        function showOverviewTab(data) {
            const printData = data || currentPrintData;
            if (!printData) return;

            const stats = printData.statistics || {};
            const print = printData.print;

            let statsHtml = `
                <div class="hist-detail-grid">
                    <!-- Temperatures -->
                    <div class="hist-detail-section">
                        <h4 class="hist-detail-section-title">
                            <span class="hist-detail-section-icon">üå°Ô∏è</span> ${texts.detail_temperatures}
                        </h4>
                        <div class="hist-value-grid hist-value-grid--2col">
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_nozzle}</div>
                                <div class="hist-value-num" style="color:var(--accent-orange);">${stats.avg_nozzle_temp ? Math.round(stats.avg_nozzle_temp) : '--'}</div>
                                <div class="hist-value-unit">¬∞C</div>
                            </div>
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_bed}</div>
                                <div class="hist-value-num" style="color:var(--accent-blue);">${stats.avg_bed_temp ? Math.round(stats.avg_bed_temp) : '--'}</div>
                                <div class="hist-value-unit">¬∞C</div>
                            </div>
                        </div>
                    </div>

                    <!-- Consumption & Costs -->
                    <div class="hist-detail-section">
                        <h4 class="hist-detail-section-title">
                            <span class="hist-detail-section-icon">üí∞</span> ${texts.detail_consumption_costs}
                        </h4>
                        <div class="hist-value-grid hist-value-grid--3col">
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_filament}</div>
                                <div class="hist-value-num hist-value-num--md" style="color:var(--accent-green);">${stats.filament_used_grams ? stats.filament_used_grams.toFixed(1) : '~'}</div>
                                <div class="hist-value-unit">g</div>
                            </div>
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_power}</div>
                                <div class="hist-value-num hist-value-num--md" style="color:var(--accent-orange);">${stats.total_power_kwh ? stats.total_power_kwh.toFixed(3) : '~'}</div>
                                <div class="hist-value-unit">kWh</div>
                            </div>
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_costs}</div>
                                <div class="hist-value-num hist-value-num--md" style="color:var(--accent-blue);">${calculateCost(stats)}</div>
                                <div class="hist-value-unit">‚Ç¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress -->
                    <div class="hist-detail-section">
                        <h4 class="hist-detail-section-title">
                            <span class="hist-detail-section-icon">üìä</span> ${texts.detail_print_progress}
                        </h4>
                        <div class="hist-value-grid hist-value-grid--2col">
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_final_progress}</div>
                                <div class="hist-value-num" style="color:var(--accent-green);">${printData.progress && printData.progress.length > 0 ? Math.round(printData.progress[printData.progress.length - 1].progress) : '--'}</div>
                                <div class="hist-value-unit">%</div>
                            </div>
                            <div class="hist-value-card">
                                <div class="hist-value-label">${texts.detail_layers}</div>
                                <div class="hist-value-num" style="font-size:26px;">${printData.progress && printData.progress.length > 0 ? printData.progress[printData.progress.length - 1].layer : '--'}</div>
                                <div class="hist-value-unit">/ ${print.total_layers || '--'}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filaments -->
                    ${data.filaments && data.filaments.length > 0 ? `
                    <div class="hist-detail-section hist-detail-section--full">
                        <h4 class="hist-detail-section-title">
                            <span class="hist-detail-section-icon">üé®</span> ${data.filaments.length > 1 ? (texts.detail_filaments || 'Filamente') : (texts.detail_filament || 'Filament')}
                        </h4>
                        <div class="hist-value-grid hist-value-grid--auto">
                            ${data.filaments.map((fil, idx) => `
                                <div class="hist-filament-card">
                                    ${data.filaments.length > 1 ? `<div class="hist-filament-badge">#${idx + 1}</div>` : ''}
                                    ${fil.color ? `
                                    <div class="hist-filament-header">
                                        <div class="hist-filament-circle" style="background:linear-gradient(135deg, ${fil.color} 0%, ${fil.color}dd 100%);"></div>
                                        ${fil.name ? `
                                        <div class="hist-filament-info">
                                            <div class="hist-filament-detail-label">${texts.detail_name || 'Name'}</div>
                                            <div class="hist-filament-detail-name">${fil.name}</div>
                                        </div>` : ''}
                                    </div>
                                    ` : (fil.name ? `
                                    <div style="margin-bottom:16px;">
                                        <div class="hist-filament-detail-label">${texts.detail_name || 'Name'}</div>
                                        <div class="hist-filament-detail-name">${fil.name}</div>
                                    </div>` : '')}
                                    ${fil.type ? `<div class="hist-filament-type">${fil.type}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- Print Settings -->
                    ${data.settings && Object.keys(data.settings).length > 0 ? `
                    <div class="hist-detail-section hist-detail-section--full">
                        <h4 class="hist-detail-section-title">
                            <span class="hist-detail-section-icon">‚öôÔ∏è</span> ${texts.detail_print_settings}
                        </h4>
                        <div class="hist-value-grid hist-value-grid--auto">
                            ${data.settings.layer_height ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_layer_height}</div>
                                <div class="hist-value-num hist-value-num--sm">${data.settings.layer_height} <span class="hist-value-unit">mm</span></div>
                            </div>` : ''}
                            ${data.settings.infill_density !== null ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_infill}</div>
                                <div class="hist-value-num hist-value-num--sm">${data.settings.infill_density}<span class="hist-value-unit">%</span></div>
                            </div>` : ''}
                            ${data.settings.wall_loops ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_wall_loops}</div>
                                <div class="hist-value-num hist-value-num--sm">${data.settings.wall_loops}</div>
                            </div>` : ''}
                            ${data.settings.print_speed ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_speed}</div>
                                <div class="hist-value-num hist-value-num--sm">${data.settings.print_speed} <span class="hist-value-unit">mm/s</span></div>
                            </div>` : ''}
                            ${data.settings.nozzle_temp ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_nozzle}</div>
                                <div class="hist-value-num hist-value-num--sm" style="color:var(--accent-orange);">${data.settings.nozzle_temp}<span class="hist-value-unit">¬∞C</span></div>
                            </div>` : ''}
                            ${data.settings.bed_temp ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_bed}</div>
                                <div class="hist-value-num hist-value-num--sm" style="color:var(--accent-blue);">${data.settings.bed_temp}<span class="hist-value-unit">¬∞C</span></div>
                            </div>` : ''}
                            ${data.settings.support_enabled !== null ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_support}</div>
                                <div style="color:var(--text-primary); font-size:18px; font-weight:700;">
                                    ${data.settings.support_enabled ? '‚úÖ ' + texts.detail_support_active : '‚ùå ' + texts.detail_support_off}
                                </div>
                            </div>` : ''}
                            ${data.settings.nozzle_diameter ? `
                            <div class="hist-settings-card">
                                <div class="hist-value-label">${texts.detail_nozzle_diameter}</div>
                                <div class="hist-value-num hist-value-num--sm">${data.settings.nozzle_diameter} <span class="hist-value-unit">mm</span></div>
                            </div>` : ''}
                        </div>
                    </div>` : ''}
                </div>
            `;

            document.getElementById('detail-stats').innerHTML = statsHtml;
        }

        // Switch detail tab
        function switchDetailTab(tab) {
            document.querySelectorAll('.hist-detail-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

            document.querySelectorAll('.detail-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(tab + '-tab').style.display = 'block';

            if (tab === 'chart' && currentPrintData) showProgressChart();
            else if (tab === 'events' && currentPrintData) showEventsTimeline();
            else if (tab === 'timelapse' && currentPrintData) showTimelapse();
        }

        // Show progress chart
        function showProgressChart() {
            if (!currentPrintData || !currentPrintData.progress) return;

            const ctx = document.getElementById('printProgressChart').getContext('2d');
            if (printProgressChart) printProgressChart.destroy();

            const labels = currentPrintData.progress.map(p =>
                new Date(p.time).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})
            );

            printProgressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: texts.chart_label_progress,
                            data: currentPrintData.progress.map(p => p.progress),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            yAxisID: 'y-percent', tension: 0.1
                        },
                        {
                            label: texts.chart_label_nozzle,
                            data: currentPrintData.progress.map(p => p.nozzle_temp),
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            yAxisID: 'y-temp', tension: 0.1
                        },
                        {
                            label: texts.chart_label_bed,
                            data: currentPrintData.progress.map(p => p.bed_temp),
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            yAxisID: 'y-temp', tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#999', maxTicksLimit: 10 } },
                        'y-percent': { type: 'linear', display: true, position: 'left', min: 0, max: 100,
                            title: { display: true, text: texts.chart_label_progress, color: '#999' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#999' }
                        },
                        'y-temp': { type: 'linear', display: true, position: 'right',
                            title: { display: true, text: texts.chart_axis_temperature, color: '#999' },
                            grid: { drawOnChartArea: false }, ticks: { color: '#999' }
                        }
                    }
                }
            });
        }

        // Show events timeline
        function showEventsTimeline() {
            if (!currentPrintData || !currentPrintData.events) return;

            let html = `<h4 class="hist-section-title">üìÖ ${texts.events_header}</h4>`;

            if (currentPrintData.events.length === 0) {
                html += `<p style="color:var(--text-secondary);">${texts.events_no_events}</p>`;
            } else {
                currentPrintData.events.forEach(event => {
                    const time = new Date(event.time).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
                    html += `
                        <div class="hist-event-item">
                            <span class="hist-event-icon">üìå</span>
                            <span class="hist-event-text">${event.details}</span>
                            <span class="hist-event-time">${time}</span>
                        </div>
                    `;
                });
            }

            document.getElementById('detail-events').innerHTML = html;
        }

        // Show timelapse
        function showTimelapse() {
            if (!currentPrintData) return;

            const container = document.getElementById('detail-timelapse');
            const printId = currentPrintData.print.id;

            apiCall(`/api/history/${printId}/timelapse_status`)
                .then(response => response.json())
                .then(status => {
                    if (status.available) {
                        container.innerHTML = `
                            <div style="display:flex; justify-content:center; margin-bottom:15px;">
                                <div style="background:#000; border-radius:8px; overflow:hidden; width:80%; max-width:640px;">
                                    <video controls style="width:100%; display:block;">
                                        <source src="/api/history/${printId}/timelapse" type="video/mp4">
                                        ${texts.timelapse_no_video}
                                    </video>
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="hist-empty">
                                <span class="hist-empty-icon">üìπ</span>
                                <p>${texts.timelapse_no_video}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error(texts.console_error_loading_timelapse + ':', error);
                    container.innerHTML = `
                        <div class="hist-empty">
                            <span class="hist-empty-icon">‚ùå</span>
                            <p>Fehler beim Laden des Videos</p>
                        </div>
                    `;
                });
        }

        // Close modals
        function closePrintDetails() {
            document.getElementById('printDetailModal').style.display = 'none';
            if (printProgressChart) {
                printProgressChart.destroy();
                printProgressChart = null;
            }
        }

        // Show day statistics
        function showDayStatistics(date, dayName = null) {
            const modal = document.getElementById('dayStatisticsModal');
            const title = document.getElementById('day-statistics-title');
            const content = document.getElementById('day-statistics-content');

            if (dayName) {
                title.innerHTML = `üìÖ ${texts.stats_for_all_weekday.replace('{weekday}', dayName)}`;
            } else {
                const dateObj = new Date(date + 'T12:00:00');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                title.innerHTML = `üìÖ ${texts.stats_prints_for_date.replace('{date}', `${day}.${month}.${year}`)}`;
            }

            apiCall('/api/history')
                .then(response => response.json())
                .then(data => {
                    let filteredPrints = [];

                    if (dayName) {
                        const weekdayNames = [
                            texts.stats_weekday_name_sunday, texts.stats_weekday_name_monday,
                            texts.stats_weekday_name_tuesday, texts.stats_weekday_name_wednesday,
                            texts.stats_weekday_name_thursday, texts.stats_weekday_name_friday,
                            texts.stats_weekday_name_saturday
                        ];
                        const targetWeekday = weekdayNames.indexOf(dayName);
                        filteredPrints = data.prints.filter(print => new Date(print.start_time).getDay() === targetWeekday);
                    } else {
                        filteredPrints = data.prints.filter(print => new Date(print.start_time).toISOString().split('T')[0] === date);
                    }

                    if (filteredPrints.length === 0) {
                        content.innerHTML = `
                            <div class="hist-empty">
                                <span class="hist-empty-icon">üì≠</span>
                                <p>${texts.stats_no_prints_day}</p>
                            </div>
                        `;
                    } else {
                        let dateLabel;
                        if (dayName) {
                            dateLabel = texts.stats_all_weekdays.replace('{weekday}', dayName);
                        } else {
                            const d = new Date(date + 'T12:00:00');
                            dateLabel = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`;
                        }
                        renderDayStatistics(filteredPrints, dateLabel);
                    }

                    modal.style.display = 'flex';
                })
                .catch(error => {
                    console.error(texts.console_error_loading_daily_stats + ':', error);
                    content.innerHTML = `<p style="color:var(--accent-red);">${texts.stats_error_loading_data}</p>`;
                    modal.style.display = 'flex';
                });
        }

        // Render day statistics
        function renderDayStatistics(prints, dateLabel) {
            const content = document.getElementById('day-statistics-content');

            const stats = {
                total: prints.length,
                successful: prints.filter(p => p.status === 'success').length,
                failed: prints.filter(p => p.status === 'failed').length,
                cancelled: prints.filter(p => p.status === 'cancelled').length,
                totalTime: prints.reduce((sum, p) => sum + (p.duration_minutes || 0), 0),
                totalFilament: prints.reduce((sum, p) => sum + (p.filament_grams || 0), 0)
            };

            let html = `
                <div class="hist-day-stats-grid">
                    <div class="hist-day-stat">
                        <div class="hist-day-stat-icon">üñ®Ô∏è</div>
                        <div class="hist-day-stat-value" style="color:var(--text-primary);">${stats.total}</div>
                        <div class="hist-day-stat-label">${texts.stats_total_label}</div>
                    </div>
                    <div class="hist-day-stat">
                        <div class="hist-day-stat-icon">‚úÖ</div>
                        <div class="hist-day-stat-value" style="color:var(--accent-green);">${stats.successful}</div>
                        <div class="hist-day-stat-label">${texts.stats_successful}</div>
                    </div>
                    <div class="hist-day-stat">
                        <div class="hist-day-stat-icon">‚è±Ô∏è</div>
                        <div class="hist-day-stat-value" style="color:var(--accent-blue);">${Math.floor(stats.totalTime / 60)}h ${stats.totalTime % 60}m</div>
                        <div class="hist-day-stat-label">${texts.stats_print_time}</div>
                    </div>
                    <div class="hist-day-stat">
                        <div class="hist-day-stat-icon">üßµ</div>
                        <div class="hist-day-stat-value" style="color:var(--accent-purple, #9c27b0);">${stats.totalFilament >= 1000 ? `${(stats.totalFilament / 1000).toFixed(1)}kg` : `${stats.totalFilament.toFixed(1)}g`}</div>
                        <div class="hist-day-stat-label">Filament</div>
                    </div>
                </div>

                <div class="hist-section">
                    <h4 class="hist-section-title">üìã ${texts.stats_prints_list_for.replace('{date}', dateLabel)}</h4>
                    <div class="hist-day-print-list">
            `;

            prints.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));

            prints.forEach(print => {
                const startTime = new Date(print.start_time);
                const timeStr = startTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const dateStr = `${String(startTime.getDate()).padStart(2, '0')}.${String(startTime.getMonth() + 1).padStart(2, '0')}.${startTime.getFullYear()}`;
                const duration = print.duration_minutes || 0;
                const statusIcon = print.status === 'success' ? '‚úÖ' : print.status === 'failed' ? '‚ùå' : print.status === 'cancelled' ? 'üö´' : '‚è∏Ô∏è';

                html += `
                    <div class="hist-day-print-item" onclick="closeDayStatistics(); setTimeout(() => showPrintDetails(${print.id}), 100)">
                        <div class="hist-day-print-left">
                            <span class="hist-day-print-icon">${statusIcon}</span>
                            <div>
                                <div class="hist-day-print-name">${print.filename || 'Unbekannt'}</div>
                                <div class="hist-day-print-meta">
                                    ${dateLabel.includes('alle') ? `${dateStr} ‚Ä¢ ` : ''}${timeStr} Uhr ‚Ä¢ ${Math.floor(duration/60)}h ${duration%60}m
                                </div>
                            </div>
                        </div>
                        <div class="hist-day-print-right">
                            <div class="hist-day-print-grams">${print.filament_grams || 0}g</div>
                            ${print.total_layers ? `<div class="hist-day-print-layers">${print.total_layers} Layer</div>` : ''}
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            content.innerHTML = html;
        }

        function closeDayStatistics() {
            document.getElementById('dayStatisticsModal').style.display = 'none';
        }

        // Reload print details
        function reloadPrintDetails() {
            if (currentPrintData) {
                showPrintDetails(currentPrintData.print.id);
            }
        }

        // Calculate cost
        function calculateCost(stats) {
            const filamentPerKg = costSettings.filament_per_kg || 25;
            const powerPerKwh = costSettings.power_per_kwh || 0.30;
            const filamentGrams = parseFloat(stats.filament_used_grams) || 0;
            const powerKwh = parseFloat(stats.total_power_kwh) || 0;
            const total = (filamentGrams / 1000) * filamentPerKg + powerKwh * powerPerKwh;
            return isNaN(total) ? "0.00" : total.toFixed(2);
        }

        // Export print data
        function exportPrintData() {
            if (!currentPrintData) return;
            let csv = 'Zeit,Fortschritt %,D√ºse ¬∞C,Bett ¬∞C,Schicht\n';
            currentPrintData.progress.forEach(p => {
                csv += `${p.time},${p.progress},${p.nozzle_temp},${p.bed_temp},${p.layer}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `druck_${currentPrintData.print.filename}_${currentPrintData.print.id}.csv`;
            a.click();
        }

        // Reprint file
        function reprintFile() {
            if (!currentPrintData) return;
            alert(`TODO: "${currentPrintData.print.filename}" erneut drucken`);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
                if (printProgressChart) {
                    printProgressChart.destroy();
                    printProgressChart = null;
                }
            }
        }
    </script>
</body>
</html>
