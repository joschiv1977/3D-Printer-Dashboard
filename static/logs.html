<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">System Logs - 3D Printer Dashboard</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css?v=2">
    <link rel="stylesheet" href="/static/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/design-tokens.css?v=2">
    <link rel="stylesheet" href="/static/css/base.css?v=2">
    <link rel="stylesheet" href="/static/css/tab-bar.css?v=2">

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 0;
            padding-bottom: 90px; /* Space for tab bar */
            margin: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px 20px;
            min-height: 100vh;
        }

        /* ========== HEADER ========== */
        .header {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 16px 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
        }

        body.dark-mode .header {
            background: rgba(26, 31, 46, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-actions {
            display: flex !important;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* ========== BUTTONS ========== */
        .btn {
            background: var(--bg-section);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        body.dark-mode .btn {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .btn:hover {
            background: var(--bg-hover, rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: rgba(220, 53, 69, 0.12);
            color: #ff6b7a;
            border-color: rgba(220, 53, 69, 0.2);
        }

        .btn-danger:hover {
            background: rgba(220, 53, 69, 0.25);
            border-color: rgba(220, 53, 69, 0.4);
        }

        /* ========== CONTENT ========== */
        .content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
        }

        body.dark-mode .content {
            background: rgba(26, 31, 46, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        /* ========== STATS BAR ========== */
        .stats-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .stat-card {
            background: var(--bg-section);
            padding: 8px 14px;
            border-radius: 8px;
            border: 1px solid transparent;
            border-left: 3px solid;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        body.dark-mode .stat-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-left: 3px solid;
        }

        .stat-card:hover {
            transform: translateY(-1px);
        }

        body.dark-mode .stat-card:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .stat-card.error { border-left-color: #ff4d6a; }
        .stat-card.warning { border-left-color: #ffb020; }
        .stat-card.info { border-left-color: #4da6ff; }
        .stat-card.debug { border-left-color: #50d17c; }

        .stat-card.active {
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-left: 3px solid var(--accent-blue);
            background: rgba(102, 126, 234, 0.08);
        }

        .stat-card.active.error { border-left-color: #ff4d6a; border-color: rgba(255, 77, 106, 0.3); background: rgba(255, 77, 106, 0.08); }
        .stat-card.active.warning { border-left-color: #ffb020; border-color: rgba(255, 176, 32, 0.3); background: rgba(255, 176, 32, 0.08); }
        .stat-card.active.info { border-left-color: #4da6ff; border-color: rgba(77, 166, 255, 0.3); background: rgba(77, 166, 255, 0.08); }
        .stat-card.active.debug { border-left-color: #50d17c; border-color: rgba(80, 209, 124, 0.3); background: rgba(80, 209, 124, 0.08); }

        .stat-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .stat-card.error .stat-value { color: #ff4d6a; }
        .stat-card.warning .stat-value { color: #ffb020; }
        .stat-card.info .stat-value { color: #4da6ff; }
        .stat-card.debug .stat-value { color: #50d17c; }

        /* ========== CONTROLS ========== */
        .controls {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-section);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        body.dark-mode .controls {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .control-group input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--accent-blue);
        }

        .control-group select,
        .search-input {
            padding: 7px 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        body.dark-mode .control-group select,
        body.dark-mode .search-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .control-group select:focus,
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .search-input {
            min-width: 220px;
            cursor: text;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
        }

        .control-divider {
            width: 1px;
            height: 24px;
            background: var(--border-color);
        }

        body.dark-mode .control-divider {
            background: rgba(255, 255, 255, 0.08);
        }

        /* ========== LOG CONTAINER ========== */
        .log-container {
            background: var(--bg-section);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 4px;
            max-height: calc(100vh - 360px);
            min-height: 400px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Cascadia Code', 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12.5px;
            line-height: 1.7;
        }

        body.dark-mode .log-container {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.04);
        }

        /* Scrollbar */
        .log-container::-webkit-scrollbar {
            width: 6px;
        }

        .log-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* ========== LOG LINES ========== */
        .log-line {
            margin: 0;
            padding: 4px 12px;
            border-radius: 6px;
            transition: background 0.15s ease;
            display: flex;
            align-items: baseline;
            gap: 0;
        }

        .log-line:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .log-line.error { color: #ff6b7a; }
        .log-line.warning { color: #ffcc4d; }
        .log-line.info { color: var(--text-primary); }
        .log-line.debug { color: #5eead4; }

        body.dark-mode .log-line.info { color: #7ee787; }

        .log-timestamp {
            color: var(--text-secondary);
            opacity: 0.5;
            margin-right: 12px;
            font-size: 12px;
            flex-shrink: 0;
        }

        .log-level {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1px 7px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
            min-width: 48px;
            text-align: center;
        }

        .log-level.error { background: rgba(255, 77, 106, 0.15); color: #ff6b7a; }
        .log-level.warning { background: rgba(255, 176, 32, 0.15); color: #ffcc4d; }
        .log-level.info { background: rgba(77, 166, 255, 0.12); color: #7ea8d1; }
        .log-level.debug { background: rgba(80, 209, 124, 0.12); color: #5eead4; }

        body.dark-mode .log-level.info { background: rgba(126, 231, 135, 0.12); color: #7ee787; }

        .log-message {
            word-break: break-word;
            flex: 1;
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 14px;
            opacity: 0.6;
        }

        /* ========== MOBILE ========== */
        @media (max-width: 768px) {
            .container { padding: 8px; }
            .header { padding: 12px 16px; border-radius: 10px; }
            .header h1 { font-size: 17px; }
            .header-actions { width: 100%; }
            .header-actions .btn { flex: 1; justify-content: center; }
            .content { padding: 12px; border-radius: 10px; }
            .stats-bar { flex-wrap: wrap; }
            .stat-card { flex: 1 1 calc(50% - 4px); min-width: 0; }
            .controls { flex-direction: column; align-items: stretch; padding: 10px 12px; }
            .control-group { justify-content: space-between; }
            .control-divider { display: none; }
            .search-input { min-width: unset; width: 100%; }
            .log-container { font-size: 11.5px; max-height: calc(100vh - 420px); }
        }

        /* ========== BG HOVER FALLBACK ========== */
        :root { --bg-hover: rgba(0, 0, 0, 0.05); }
        body.dark-mode { --bg-hover: rgba(255, 255, 255, 0.06); }
    </style>
</head>
<body>
    <!-- Apply dark mode immediately to prevent white flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Shared Module Scripts -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/tab-bar-manager.js"></script>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>üìã <span data-i18n="system_logs">System Logs</span></h1>
            </div>
            <div class="header-actions">
                <button class="btn" onclick="refreshLogs()">
                    üîÑ <span data-i18n="refresh">Aktualisieren</span>
                </button>
                <button class="btn" onclick="downloadLogs()">
                    üíæ <span data-i18n="download">Download</span>
                </button>
                <button class="btn btn-danger" onclick="clearLogs()">
                    üóëÔ∏è <span data-i18n="delete">L√∂schen</span>
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-card error" onclick="filterByLevel('error')" id="stat-error">
                    <div class="stat-label" data-i18n="errors">Fehler</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card warning" onclick="filterByLevel('warning')" id="stat-warning">
                    <div class="stat-label" data-i18n="warnings">Warnungen</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card info" onclick="filterByLevel('info')" id="stat-info">
                    <div class="stat-label" data-i18n="info">Info</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card debug" onclick="filterByLevel('debug')" id="stat-debug">
                    <div class="stat-label" data-i18n="debug">Debug</div>
                    <div class="stat-value">0</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()">
                        <span data-i18n="auto_refresh_logs">Auto-Refresh (5s)</span>
                    </label>
                </div>

                <div class="control-divider"></div>

                <div class="control-group">
                    <label for="lines-select" data-i18n="show_lines">Zeilen:</label>
                    <select id="lines-select" onchange="refreshLogs()">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="1000" selected>1000</option>
                    </select>
                </div>

                <div class="control-divider"></div>

                <div class="control-group" style="flex: 1;">
                    <label for="search-input">üîç</label>
                    <input type="text" id="search-input" class="search-input" placeholder="Filter logs..."
                           oninput="filterLogs()" style="flex: 1;">
                </div>
            </div>

            <!-- Log Container -->
            <div class="log-container" id="log-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p data-i18n="loading_logs">Logs werden geladen...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/auth-handler.js"></script>
    <script>
        let allLogs = [];
        let currentFilter = null;
        let autoRefreshInterval = null;

        // Get translations
        function getText(key, fallback = key) {
            return window.i18nManager ? window.i18nManager.getText(key, fallback) : fallback;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Render sidebar
            if (window.tabBarManager) {
                window.tabBarManager.render();
            }

            // Apply translations
            if (window.i18nManager) {
                window.i18nManager.applyTranslations();
            }

            // Load logs
            loadLogs();
        });

        async function loadLogs() {
            try {
                const lines = document.getElementById('lines-select').value;
                const response = await apiCall(`/api/logs?lines=${lines}`);
                const data = await response.json();

                if (data.logs) {
                    // Parse logs into structured format
                    allLogs = parseLogs(data.logs);
                    renderLogs();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('log-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>${getText('error_loading_logs', 'Fehler beim Laden der Logs')}</p>
                    </div>
                `;
            }
        }

        function parseLogs(logText) {
            const lines = logText.split('\n').filter(line => line.trim());
            return lines.map(line => {
                // Parse format: YYYY-MM-DD HH:MM:SS,mmm - LEVEL - Message
                const pattern = /^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:,\d+)?)\s*-\s*(\w+)\s*-\s*(.+)$/;
                const match = line.match(pattern);

                if (match) {
                    const timestamp = match[1];
                    const levelString = match[2];
                    const message = match[3];

                    // Convert timestamp to German format: DD.MM.YYYY HH:mm:ss
                    const formattedTimestamp = formatToGermanDate(timestamp);

                    // Detect log level
                    let level = 'info';
                    if (levelString.match(/ERROR|FEHLER/i)) level = 'error';
                    else if (levelString.match(/WARNING|WARNUNG/i)) level = 'warning';
                    else if (levelString.match(/DEBUG/i)) level = 'debug';
                    else if (levelString.match(/INFO/i)) level = 'info';

                    return {
                        raw: line,
                        timestamp: formattedTimestamp,
                        level,
                        message
                    };
                } else {
                    // Fallback for unstructured logs
                    const timestampMatch = line.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/);
                    const timestamp = timestampMatch ? formatToGermanDate(timestampMatch[1]) : null;

                    // Detect log level
                    let level = 'info';
                    if (line.match(/ERROR|FEHLER|‚ùå/i)) level = 'error';
                    else if (line.match(/WARNING|WARNUNG|‚ö†Ô∏è/i)) level = 'warning';
                    else if (line.match(/DEBUG|üîµ|üî¥/i)) level = 'debug';
                    else if (line.match(/INFO|‚úÖ/i)) level = 'info';

                    return {
                        raw: line,
                        timestamp,
                        level,
                        message: line
                    };
                }
            });
        }

        function formatToGermanDate(timestamp) {
            // Convert YYYY-MM-DD HH:mm:ss,mmm to DD.MM.YYYY HH:mm:ss
            try {
                const parts = timestamp.split(/[\s,]/);
                const datePart = parts[0]; // YYYY-MM-DD
                const timePart = parts[1]; // HH:mm:ss

                const [year, month, day] = datePart.split('-');
                const time = timePart.substring(0, 8); // Remove milliseconds if present

                return `${day}.${month}.${year} ${time}`;
            } catch (e) {
                return timestamp;
            }
        }

        function renderLogs() {
            const container = document.getElementById('log-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            let filtered = allLogs;

            // Filter by level if active
            if (currentFilter) {
                filtered = filtered.filter(log => log.level === currentFilter);
            }

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(log => log.raw.toLowerCase().includes(searchTerm));
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>${getText('no_logs', 'Keine Logs vorhanden')}</p>
                    </div>
                `;
                return;
            }

            const html = filtered.map(log => {
                const levelBadge = `<span class="log-level ${log.level}">${log.level}</span>`;
                const timestampStr = log.timestamp ? `<span class="log-timestamp">${log.timestamp}</span>` : '';

                return `<div class="log-line ${log.level}">${timestampStr}${levelBadge}<span class="log-message">${escapeHtml(log.message)}</span></div>`;
            }).join('');

            container.innerHTML = html;

            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function updateStats() {
            const stats = {
                error: 0,
                warning: 0,
                info: 0,
                debug: 0
            };

            allLogs.forEach(log => {
                stats[log.level]++;
            });

            document.querySelector('#stat-error .stat-value').textContent = stats.error;
            document.querySelector('#stat-warning .stat-value').textContent = stats.warning;
            document.querySelector('#stat-info .stat-value').textContent = stats.info;
            document.querySelector('#stat-debug .stat-value').textContent = stats.debug;
        }

        function filterByLevel(level) {
            const card = document.getElementById(`stat-${level}`);

            // Toggle filter
            if (currentFilter === level) {
                currentFilter = null;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            } else {
                currentFilter = level;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
            }

            renderLogs();
        }

        function filterLogs() {
            renderLogs();
        }

        async function refreshLogs() {
            await loadLogs();
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');

            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadLogs, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // Custom Confirm Dialog
        function showConfirmDialog(message, title = 'Best√§tigung') {
            return new Promise((resolve) => {
                const existing = document.getElementById('customConfirmDialog');
                if (existing) existing.remove();

                const modal = document.createElement('div');
                modal.id = 'customConfirmDialog';
                modal.className = 'modal-overlay';
                modal.style.cssText = 'display:flex; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;';

                modal.innerHTML = `
                    <div style="background:var(--bg-card, #1a1f2e); border:1px solid var(--border-color, rgba(255,255,255,0.08)); border-radius:16px; max-width:420px; width:90%; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                        <div style="padding:16px 20px; border-bottom:1px solid var(--border-color, rgba(255,255,255,0.08));">
                            <h2 style="margin:0; color:var(--text-primary); font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px;">‚ö†Ô∏è ${title}</h2>
                        </div>
                        <div style="padding:20px;">
                            <div style="color:var(--text-primary); font-size:14px; line-height:1.6;">${message}</div>
                            <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
                                <button class="btn" id="confirm-cancel-btn">${getText('cancel', 'Abbrechen')}</button>
                                <button class="btn btn-danger" id="confirm-ok-btn">${getText('confirm_ok', 'L√∂schen')}</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const close = (result) => {
                    modal.remove();
                    resolve(result);
                };

                document.getElementById('confirm-ok-btn').addEventListener('click', () => close(true));
                document.getElementById('confirm-cancel-btn').addEventListener('click', () => close(false));
                modal.addEventListener('click', (e) => { if (e.target === modal) close(false); });
            });
        }

        // Custom Toast (Name showWebToast um Konflikt mit Electron toast.js zu vermeiden)
        function showWebToast(message, type = 'success') {
            const existingToasts = document.querySelectorAll('.web-toast');
            existingToasts.forEach(t => t.remove());

            const isDark = document.body.classList.contains('dark-mode');
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            const toast = document.createElement('div');
            toast.className = 'web-toast';
            toast.style.cssText = `background:${isDark ? 'rgba(26,31,46,0.95)' : 'rgba(255,255,255,0.95)'}; color:${isDark ? '#e2e8f0' : '#1a1f2e'}; border:1px solid ${isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'}; backdrop-filter:blur(12px);`;
            toast.textContent = `${icons[type] || ''} ${message}`;
            document.body.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function clearLogs() {
            const confirmed = await showConfirmDialog(
                getText('confirm_clear_logs', 'M√∂chten Sie wirklich alle Logs l√∂schen?'),
                getText('confirm_title', 'Best√§tigung')
            );
            if (!confirmed) return;

            try {
                const response = await apiCall('/api/logs', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    allLogs = [];
                    renderLogs();
                    updateStats();
                    showWebToast(getText('logs_cleared', 'Logs gel√∂scht'), 'success');
                } else {
                    showWebToast(getText('error_clearing_logs', 'Fehler beim L√∂schen der Logs'), 'error');
                }
            } catch (error) {
                console.error('Error clearing logs:', error);
                showWebToast(getText('error_clearing_logs', 'Fehler beim L√∂schen der Logs'), 'error');
            }
        }

        function downloadLogs() {
            const logText = allLogs.map(log => log.raw).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>
