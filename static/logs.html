<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">System Logs - 3D Printer Dashboard</title>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css">

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { max-width: 100%; margin: 0; padding: 8px; }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 { margin: 0; font-size: 22px; flex: 1; }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .btn-danger {
            background: var(--accent-red);
            border-color: transparent;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .content {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 0 0 8px 8px;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-section);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid;
            transition: all 0.2s;
            cursor: pointer;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
        }

        .stat-card.error { border-left-color: var(--accent-red); }
        .stat-card.warning { border-left-color: var(--accent-orange); }
        .stat-card.info { border-left-color: var(--accent-blue); }
        .stat-card.debug { border-left-color: var(--accent-green); }

        .stat-card.active {
            background: var(--bg-hover);
            box-shadow: 0 0 0 2px var(--accent-blue);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
        }

        .control-group input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .control-group select {
            padding: 8px 12px;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .log-container {
            background: var(--bg-section);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            max-height: calc(100vh - 400px);
            min-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-line {
            margin-bottom: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.1s;
        }

        .log-line:hover {
            background: var(--bg-hover);
        }

        .log-line.error { color: #ff4444; }
        .log-line.warning { color: #ffaa00; }
        .log-line.info { color: var(--text-primary); }
        .log-line.debug { color: #00aaff; }

        /* Dark Mode: Info Logs gr√ºn */
        body.dark-mode .log-line.info { color: #00ff00; }

        .log-timestamp {
            color: var(--text-secondary);
            margin-right: 10px;
        }

        .log-level {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .log-level.error { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        .log-level.warning { background: rgba(255, 170, 0, 0.2); color: #ffaa00; }
        .log-level.info { background: rgba(0, 170, 255, 0.15); color: var(--text-primary); }
        .log-level.debug { background: rgba(0, 170, 255, 0.2); color: #00aaff; }

        /* Dark Mode: Info Badge gr√ºn */
        body.dark-mode .log-level.info { background: rgba(0, 255, 0, 0.2); color: #00ff00; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .header h1 { font-size: 18px; }
            .header-actions { width: 100%; justify-content: stretch; }
            .header-actions .btn { flex: 1; }
            .stats-bar { grid-template-columns: 1fr 1fr; }
            .controls { flex-direction: column; align-items: stretch; }
            .control-group { justify-content: space-between; }
        }
    </style>
</head>
<body>
    <!-- Apply dark mode immediately to prevent white flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Shared Module Scripts -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/sidebar-manager.js"></script>

    <div class="container">
        <div class="header">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <h1>üìã <span data-i18n="system_logs">System Logs</span></h1>
            <div class="header-actions">
                <button class="btn" onclick="refreshLogs()">
                    üîÑ <span data-i18n="refresh">Aktualisieren</span>
                </button>
                <button class="btn" onclick="downloadLogs()">
                    üíæ <span data-i18n="download">Download</span>
                </button>
                <button class="btn btn-danger" onclick="clearLogs()">
                    üóëÔ∏è <span data-i18n="delete">L√∂schen</span>
                </button>
            </div>
        </div>

        <div class="content">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-card error" onclick="filterByLevel('error')" id="stat-error">
                    <div class="stat-label" data-i18n="errors">Fehler</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card warning" onclick="filterByLevel('warning')" id="stat-warning">
                    <div class="stat-label" data-i18n="warnings">Warnungen</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card info" onclick="filterByLevel('info')" id="stat-info">
                    <div class="stat-label" data-i18n="info">Info</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-card debug" onclick="filterByLevel('debug')" id="stat-debug">
                    <div class="stat-label" data-i18n="debug">Debug</div>
                    <div class="stat-value">0</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="auto-refresh" onchange="toggleAutoRefresh()">
                        <span data-i18n="auto_refresh_logs">Auto-Refresh (5s)</span>
                    </label>
                </div>

                <div class="control-group">
                    <label for="lines-select" data-i18n="show_lines">Zeilen:</label>
                    <select id="lines-select" onchange="refreshLogs()">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="search-input" data-i18n="search">Suche:</label>
                    <input type="text" id="search-input" placeholder="Filter logs..."
                           style="padding: 8px 12px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-size: 14px; min-width: 200px;"
                           oninput="filterLogs()">
                </div>
            </div>

            <!-- Log Container -->
            <div class="log-container" id="log-container">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p data-i18n="loading_logs">Logs werden geladen...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/auth-handler.js"></script>
    <script>
        let allLogs = [];
        let currentFilter = null;
        let autoRefreshInterval = null;

        // Get translations
        function getText(key, fallback = key) {
            return window.i18nManager ? window.i18nManager.getText(key, fallback) : fallback;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Render sidebar
            if (window.sidebarManager) {
                window.sidebarManager.render();
            }

            // Apply translations
            if (window.i18nManager) {
                window.i18nManager.applyTranslations();
            }

            // Load logs
            loadLogs();
        });

        async function loadLogs() {
            try {
                const lines = document.getElementById('lines-select').value;
                const response = await apiCall(`/api/logs?lines=${lines}`);
                const data = await response.json();

                if (data.logs) {
                    // Parse logs into structured format
                    allLogs = parseLogs(data.logs);
                    renderLogs();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('log-container').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>${getText('error_loading_logs', 'Fehler beim Laden der Logs')}</p>
                    </div>
                `;
            }
        }

        function parseLogs(logText) {
            const lines = logText.split('\n').filter(line => line.trim());
            return lines.map(line => {
                // Parse format: YYYY-MM-DD HH:MM:SS,mmm - LEVEL - Message
                const pattern = /^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}(?:,\d+)?)\s*-\s*(\w+)\s*-\s*(.+)$/;
                const match = line.match(pattern);

                if (match) {
                    const timestamp = match[1];
                    const levelString = match[2];
                    const message = match[3];

                    // Convert timestamp to German format: DD.MM.YYYY HH:mm:ss
                    const formattedTimestamp = formatToGermanDate(timestamp);

                    // Detect log level
                    let level = 'info';
                    if (levelString.match(/ERROR|FEHLER/i)) level = 'error';
                    else if (levelString.match(/WARNING|WARNUNG/i)) level = 'warning';
                    else if (levelString.match(/DEBUG/i)) level = 'debug';
                    else if (levelString.match(/INFO/i)) level = 'info';

                    return {
                        raw: line,
                        timestamp: formattedTimestamp,
                        level,
                        message
                    };
                } else {
                    // Fallback for unstructured logs
                    const timestampMatch = line.match(/^(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})/);
                    const timestamp = timestampMatch ? formatToGermanDate(timestampMatch[1]) : null;

                    // Detect log level
                    let level = 'info';
                    if (line.match(/ERROR|FEHLER|‚ùå/i)) level = 'error';
                    else if (line.match(/WARNING|WARNUNG|‚ö†Ô∏è/i)) level = 'warning';
                    else if (line.match(/DEBUG|üîµ|üî¥/i)) level = 'debug';
                    else if (line.match(/INFO|‚úÖ/i)) level = 'info';

                    return {
                        raw: line,
                        timestamp,
                        level,
                        message: line
                    };
                }
            });
        }

        function formatToGermanDate(timestamp) {
            // Convert YYYY-MM-DD HH:mm:ss,mmm to DD.MM.YYYY HH:mm:ss
            try {
                const parts = timestamp.split(/[\s,]/);
                const datePart = parts[0]; // YYYY-MM-DD
                const timePart = parts[1]; // HH:mm:ss

                const [year, month, day] = datePart.split('-');
                const time = timePart.substring(0, 8); // Remove milliseconds if present

                return `${day}.${month}.${year} ${time}`;
            } catch (e) {
                return timestamp;
            }
        }

        function renderLogs() {
            const container = document.getElementById('log-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();

            let filtered = allLogs;

            // Filter by level if active
            if (currentFilter) {
                filtered = filtered.filter(log => log.level === currentFilter);
            }

            // Filter by search term
            if (searchTerm) {
                filtered = filtered.filter(log => log.raw.toLowerCase().includes(searchTerm));
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>${getText('no_logs', 'Keine Logs vorhanden')}</p>
                    </div>
                `;
                return;
            }

            const html = filtered.map(log => {
                const levelBadge = `<span class="log-level ${log.level}">${log.level}</span>`;
                const timestampStr = log.timestamp ? `<span class="log-timestamp">${log.timestamp}</span>` : '';

                return `<div class="log-line ${log.level}">${timestampStr}${levelBadge}${escapeHtml(log.message)}</div>`;
            }).join('');

            container.innerHTML = html;

            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function updateStats() {
            const stats = {
                error: 0,
                warning: 0,
                info: 0,
                debug: 0
            };

            allLogs.forEach(log => {
                stats[log.level]++;
            });

            document.querySelector('#stat-error .stat-value').textContent = stats.error;
            document.querySelector('#stat-warning .stat-value').textContent = stats.warning;
            document.querySelector('#stat-info .stat-value').textContent = stats.info;
            document.querySelector('#stat-debug .stat-value').textContent = stats.debug;
        }

        function filterByLevel(level) {
            const card = document.getElementById(`stat-${level}`);

            // Toggle filter
            if (currentFilter === level) {
                currentFilter = null;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
            } else {
                currentFilter = level;
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
                card.classList.add('active');
            }

            renderLogs();
        }

        function filterLogs() {
            renderLogs();
        }

        async function refreshLogs() {
            await loadLogs();
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh');

            if (checkbox.checked) {
                autoRefreshInterval = setInterval(loadLogs, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        async function clearLogs() {
            if (!confirm(getText('confirm_clear_logs', 'M√∂chten Sie wirklich alle Logs l√∂schen?'))) {
                return;
            }

            try {
                const response = await apiCall('/api/logs', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    allLogs = [];
                    renderLogs();
                    updateStats();
                } else {
                    alert(getText('error_clearing_logs', 'Fehler beim L√∂schen der Logs'));
                }
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert(getText('error_clearing_logs', 'Fehler beim L√∂schen der Logs'));
            }
        }

        function downloadLogs() {
            const logText = allLogs.map(log => log.raw).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `logs_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>
