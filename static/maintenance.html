<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title id="page-title">Wartung - 3D Printer Dashboard</title>

    <!-- PWA Support -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css?v=2">
    <link rel="stylesheet" href="/static/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/design-tokens.css?v=2">
    <link rel="stylesheet" href="/static/css/base.css?v=2">
    <link rel="stylesheet" href="/static/css/tab-bar.css?v=2">
    <link rel="stylesheet" href="/static/css/modals.css?v=2">
    <link rel="stylesheet" href="/static/css/sd-card.css?v=4">
    <link rel="stylesheet" href="/static/css/maintenance.css?v=1">

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <style>
        body {
            padding-bottom: 90px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- Apply dark mode immediately to prevent white flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || 'auto';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else if (theme === 'auto' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
            }
        })();
    </script>

    <!-- Shared Module Scripts -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/tab-bar-manager.js"></script>

    <!-- Main Content -->
    <div class="container">
        <div class="maint-header">
            <h1 class="maint-header-title">üîß <span data-i18n="maintenance_plan">Wartungsplan</span></h1>
            <select id="printer-selector" class="maint-printer-select" onchange="switchPrinter()">
                <option value="" data-i18n="maintenance_loading_printers">Loading printers...</option>
            </select>
            <div class="maint-header-actions">
                <div class="maint-header-group">
                    <label class="maint-checkbox-label">
                        <input type="checkbox" id="include-prints-checkbox" checked>
                        <span data-i18n="maintenance_include_prints">Drucke einbeziehen</span>
                    </label>
                    <button class="maint-btn" onclick="exportPDF()">
                        üìÑ <span data-i18n="maintenance_export_pdf">PDF Export</span>
                    </button>
                </div>
                <button class="maint-btn" onclick="showAddPrinterModal()">
                    üñ®Ô∏è <span data-i18n="maintenance_add_printer">Drucker hinzuf√ºgen</span>
                </button>
                <button class="maint-btn" onclick="showInitModal()">
                    üîÑ <span data-i18n="maintenance_init">Wartungsplan laden</span>
                </button>
                <button class="maint-btn maint-btn--primary" onclick="showNewTaskModal()">
                    ‚ûï <span data-i18n="maintenance_new">Neue Wartung</span>
                </button>
            </div>
        </div>

        <div class="maint-content">
            <!-- Alerts -->
            <div id="alert-success" class="maint-alert maint-alert--success"></div>
            <div id="alert-error" class="maint-alert maint-alert--error"></div>

            <!-- Stats Overview -->
            <div class="maint-stats">
                <div class="maint-stat maint-stat--overdue" id="filter-overdue" onclick="toggleFilter('overdue')">
                    <div class="maint-stat-icon">üî¥</div>
                    <div class="maint-stat-info">
                        <h3 id="stat-overdue">0</h3>
                        <p data-i18n="maintenance_overdue">√úberf√§llig</p>
                    </div>
                </div>
                <div class="maint-stat maint-stat--due" id="filter-due" onclick="toggleFilter('due')">
                    <div class="maint-stat-icon">üü°</div>
                    <div class="maint-stat-info">
                        <h3 id="stat-due">0</h3>
                        <p data-i18n="maintenance_due">F√§llig</p>
                    </div>
                </div>
                <div class="maint-stat maint-stat--upcoming" id="filter-upcoming" onclick="toggleFilter('upcoming')">
                    <div class="maint-stat-icon">üü¢</div>
                    <div class="maint-stat-info">
                        <h3 id="stat-upcoming">0</h3>
                        <p data-i18n="maintenance_upcoming">Geplant</p>
                    </div>
                </div>
            </div>

            <!-- Overdue Tasks -->
            <div id="section-overdue" style="display: none;">
                <div class="maint-section-header">
                    <h2>üî¥ <span data-i18n="maintenance_overdue">√úberf√§llig</span></h2>
                </div>
                <div id="tasks-overdue" class="maint-task-list"></div>
            </div>

            <!-- Due Tasks -->
            <div id="section-due" style="display: none; margin-top: 20px;">
                <div class="maint-section-header">
                    <h2>üü° <span data-i18n="maintenance_due_next_days">F√§llig (n√§chste 3 Tage)</span></h2>
                </div>
                <div id="tasks-due" class="maint-task-list"></div>
            </div>

            <!-- Upcoming Tasks -->
            <div id="section-upcoming" style="margin-top: 20px;">
                <div class="maint-section-header">
                    <h2>üü¢ <span data-i18n="maintenance_planned">Geplante Wartungen</span></h2>
                </div>
                <div id="tasks-upcoming" class="maint-task-list"></div>
            </div>
        </div>
    </div>

    <!-- New/Edit Task Modal -->
    <div id="task-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; padding:20px;">
        <div class="modal-panel sd-modal-panel" style="max-width:600px;">
            <div class="sd-modal-header">
                <h2 class="sd-modal-title" id="modal-title" data-i18n="maintenance_new">‚ûï Neue Wartung</h2>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closeTaskModal()">&times;</button>
                </div>
            </div>
            <div class="sd-modal-body">
                <form id="task-form">
                    <input type="hidden" id="task-id">

                    <div class="maint-form-group">
                        <label for="task-name" data-i18n="maintenance_name">Name *</label>
                        <input type="text" id="task-name" class="maint-form-input" placeholder="z.B. X/Y-Achsen Reinigung" required>
                    </div>

                    <div class="maint-form-group">
                        <label for="task-printer-id" data-i18n="maintenance_printer">Drucker *</label>
                        <select id="task-printer-id" class="maint-form-select" required>
                            <option value="">Drucker w√§hlen...</option>
                        </select>
                    </div>

                    <div class="maint-form-group">
                        <label for="task-interval" data-i18n="maintenance_interval">Intervall *</label>
                        <select id="task-interval" class="maint-form-select" required>
                            <optgroup id="interval-group-days" label="Tage">
                                <option value="days:7">7 Tage</option>
                                <option value="days:14">14 Tage</option>
                                <option value="days:30" selected>30 Tage</option>
                                <option value="days:60">60 Tage</option>
                                <option value="days:90">90 Tage</option>
                                <option value="days:180">180 Tage</option>
                                <option value="days:365">365 Tage (1 Jahr)</option>
                            </optgroup>
                            <optgroup id="interval-group-hours" label="Druckstunden">
                                <option value="hours:50">50 Druckstunden</option>
                                <option value="hours:100">100 Druckstunden</option>
                                <option value="hours:250">250 Druckstunden</option>
                                <option value="hours:500">500 Druckstunden</option>
                                <option value="hours:720">720 Druckstunden (~90 Tage)</option>
                                <option value="hours:1000">1000 Druckstunden</option>
                            </optgroup>
                            <optgroup id="interval-group-prints" label="Drucke">
                                <option value="prints:10">10 Drucke</option>
                                <option value="prints:25">25 Drucke</option>
                                <option value="prints:50">50 Drucke</option>
                                <option value="prints:100">100 Drucke</option>
                                <option value="prints:250">250 Drucke</option>
                            </optgroup>
                            <optgroup id="interval-group-rolls" label="Filament-Rollen">
                                <option value="filament_rolls:2">2 Rollen</option>
                                <option value="filament_rolls:5">5 Rollen</option>
                                <option value="filament_rolls:10">10 Rollen</option>
                                <option value="filament_rolls:20">20 Rollen</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="maint-form-group">
                        <label for="task-priority" data-i18n="maintenance_priority">Priorit√§t</label>
                        <select id="task-priority" class="maint-form-select">
                            <option value="low" data-i18n="maintenance_priority_low">Niedrig</option>
                            <option value="medium" selected data-i18n="maintenance_priority_medium">Mittel</option>
                            <option value="high" data-i18n="maintenance_priority_high">Hoch</option>
                            <option value="critical" data-i18n="maintenance_priority_critical">Kritisch</option>
                        </select>
                    </div>

                    <div class="maint-form-group">
                        <label for="task-description" data-i18n="maintenance_description">Beschreibung</label>
                        <textarea id="task-description" class="maint-form-textarea" placeholder="z.B. Linearstangen reinigen und schmieren..."></textarea>
                    </div>

                    <div class="maint-form-group">
                        <label for="task-first-due" data-i18n="maintenance_first_due">Erste Wartung</label>
                        <input type="date" id="task-first-due" class="maint-form-input">
                    </div>

                    <div class="maint-form-group">
                        <label for="task-category" data-i18n="maintenance_category">Kategorie</label>
                        <select id="task-category" class="maint-form-select">
                            <option value="cleaning" data-i18n="maintenance_category_cleaning">Reinigung</option>
                            <option value="lubrication" data-i18n="maintenance_category_lubrication">Schmierung</option>
                            <option value="inspection" data-i18n="maintenance_category_inspection">Inspektion</option>
                            <option value="replacement" data-i18n="maintenance_category_replacement">Austausch</option>
                            <option value="maintenance" data-i18n="maintenance">Wartung</option>
                        </select>
                    </div>

                    <div class="maint-form-group">
                        <label for="task-notes" data-i18n="maintenance_notes">Hinweise</label>
                        <textarea id="task-notes" class="maint-form-textarea" placeholder="Zus√§tzliche Hinweise zur Durchf√ºhrung..."></textarea>
                    </div>
                </form>
            </div>
            <div class="maint-modal-footer maint-modal-footer--split">
                <div>
                    <button id="delete-task-btn" class="maint-btn maint-btn--danger" onclick="deleteTask()" style="display: none;" data-i18n="maintenance_delete">üóëÔ∏è L√∂schen</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="maint-btn" onclick="closeTaskModal()" data-i18n="cancel">Abbrechen</button>
                    <button class="maint-btn maint-btn--primary" onclick="saveTask()" data-i18n="save">Erstellen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Complete Task Modal -->
    <div id="complete-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; padding:20px;">
        <div class="modal-panel sd-modal-panel" style="max-width:550px;">
            <div class="sd-modal-header">
                <h2 class="sd-modal-title" data-i18n="maintenance_complete_title">‚úì Wartung abschlie√üen</h2>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closeCompleteModal()">&times;</button>
                </div>
            </div>
            <div class="sd-modal-body">
                <p id="complete-task-name" style="font-weight: 600; margin-bottom: 15px; font-size: 15px;"></p>

                <div id="complete-checklist-container"></div>

                <div class="maint-form-group" style="margin-top: 16px;">
                    <label for="complete-notes" data-i18n="maintenance_completion_notes">Notizen zur durchgef√ºhrten Wartung</label>
                    <textarea id="complete-notes" class="maint-form-textarea" data-i18n="maintenance_completion_placeholder" placeholder="Was wurde gemacht? Gab es Probleme oder Besonderheiten?"></textarea>
                </div>
            </div>
            <div class="maint-modal-footer">
                <button class="maint-btn" onclick="closeCompleteModal()" data-i18n="cancel">Abbrechen</button>
                <button class="maint-btn maint-btn--success" onclick="completeTask()" data-i18n="maintenance_mark_complete">‚úì Als erledigt markieren</button>
            </div>
        </div>
    </div>

    <!-- Initialize Maintenance Plan Modal -->
    <div id="init-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; padding:20px;">
        <div class="modal-panel sd-modal-panel" style="max-width:550px;">
            <div class="sd-modal-header">
                <h2 class="sd-modal-title" data-i18n="maintenance_init_title">üîÑ Wartungsplan initialisieren</h2>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closeInitModal()">&times;</button>
                </div>
            </div>
            <div class="sd-modal-body">
                <div class="maint-info-box">
                    <p data-i18n="maintenance_init_info">
                        L√§dt vordefinierte Wartungsaufgaben f√ºr das ausgew√§hlte Druckermodell. Diese beinhalten empfohlene Wartungsintervalle basierend auf den Herstellerangaben.
                    </p>
                </div>

                <div class="maint-form-group">
                    <label for="init-model" data-i18n="maintenance_init_model">Druckermodell *</label>
                    <select id="init-model" class="maint-form-select">
                        <option value="P1P">Bambu Lab P1P</option>
                        <option value="P1S" selected>Bambu Lab P1S</option>
                        <option value="P2S">Bambu Lab P2S</option>
                        <option value="X1C">Bambu Lab X1C</option>
                        <option value="X1E">Bambu Lab X1E</option>
                        <option value="H2S">Bambu Lab H2S</option>
                        <option value="A1">Bambu Lab A1</option>
                        <option value="A1_MINI">Bambu Lab A1 Mini</option>
                    </select>
                </div>

                <div class="maint-form-group">
                    <label class="maint-checkbox-label">
                        <input type="checkbox" id="init-force">
                        <span data-i18n="maintenance_init_force">Bestehende Wartungen √ºberschreiben</span>
                    </label>
                    <p class="maint-hint" style="margin-left: 26px;" data-i18n="maintenance_init_force_info">
                        Achtung: Alle bestehenden Wartungsaufgaben werden gel√∂scht!
                    </p>
                </div>
            </div>
            <div class="maint-modal-footer">
                <button class="maint-btn" onclick="closeInitModal()" data-i18n="cancel">Abbrechen</button>
                <button class="maint-btn maint-btn--primary" onclick="initializeMaintenancePlan()" data-i18n="maintenance_init_button">üîÑ Wartungsplan laden</button>
            </div>
        </div>
    </div>

    <!-- Postpone Task Modal -->
    <div id="postpone-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; padding:20px;">
        <div class="modal-panel sd-modal-panel" style="max-width:500px;">
            <div class="sd-modal-header">
                <h2 class="sd-modal-title" data-i18n="maintenance_postpone_title">‚è∞ Wartung verschieben</h2>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closePostponeModal()">&times;</button>
                </div>
            </div>
            <div class="sd-modal-body">
                <p id="postpone-task-name" style="font-weight: 600; margin-bottom: 16px; font-size: 15px;"></p>

                <div class="maint-postpone-grid">
                    <button class="maint-postpone-btn" onclick="postponeTask(7)">
                        <span class="maint-postpone-icon">üìÖ</span>
                        <span class="maint-postpone-text">
                            <strong data-i18n="maintenance_postpone_7days">+7 Tage</strong>
                            <small data-i18n="maintenance_postpone_7days_desc">Wartung um eine Woche verschieben</small>
                        </span>
                    </button>

                    <button class="maint-postpone-btn" onclick="postponeTask(14)">
                        <span class="maint-postpone-icon">üìÖ</span>
                        <span class="maint-postpone-text">
                            <strong data-i18n="maintenance_postpone_14days">+14 Tage</strong>
                            <small data-i18n="maintenance_postpone_14days_desc">Wartung um zwei Wochen verschieben</small>
                        </span>
                    </button>

                    <button class="maint-postpone-btn" onclick="postponeTask(30)">
                        <span class="maint-postpone-icon">üìÖ</span>
                        <span class="maint-postpone-text">
                            <strong data-i18n="maintenance_postpone_30days">+30 Tage</strong>
                            <small data-i18n="maintenance_postpone_30days_desc">Wartung um einen Monat verschieben</small>
                        </span>
                    </button>

                    <div class="maint-form-group" style="margin-top: 6px;">
                        <label for="postpone-custom-days" data-i18n="maintenance_postpone_custom">Benutzerdefiniert (Tage)</label>
                        <div class="maint-postpone-custom">
                            <input type="number" id="postpone-custom-days" min="1" placeholder="z.B. 3">
                            <button class="maint-btn maint-btn--primary" onclick="postponeTaskCustom()">
                                ‚è∞ <span data-i18n="maintenance_postpone_button">Verschieben</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="maint-modal-footer">
                <button class="maint-btn" onclick="closePostponeModal()" data-i18n="cancel">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Add Printer Modal -->
    <div id="add-printer-modal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center; padding:20px;">
        <div class="modal-panel sd-modal-panel" style="max-width:550px;">
            <div class="sd-modal-header">
                <h2 class="sd-modal-title" data-i18n="maintenance_add_printer_title">üñ®Ô∏è Drucker hinzuf√ºgen</h2>
                <div class="sd-header-actions">
                    <button class="sd-close-btn" onclick="closeAddPrinterModal()">&times;</button>
                </div>
            </div>
            <div class="sd-modal-body">
                <form id="add-printer-form">
                    <div class="maint-form-group">
                        <label for="printer-name" data-i18n="maintenance_printer_name">Name *</label>
                        <input type="text" id="printer-name" class="maint-form-input" data-i18n-placeholder="maintenance_printer_name_placeholder" placeholder="e.g. P1S Main Printer" required>
                    </div>

                    <div class="maint-form-group">
                        <label for="printer-model" data-i18n="maintenance_printer_model">Model *</label>
                        <select id="printer-model" class="maint-form-select" required>
                            <option value="P1P">Bambu Lab P1P</option>
                            <option value="P1S" selected>Bambu Lab P1S</option>
                            <option value="P2S">Bambu Lab P2S</option>
                            <option value="X1C">Bambu Lab X1C</option>
                            <option value="X1E">Bambu Lab X1E</option>
                            <option value="H2S">Bambu Lab H2S</option>
                            <option value="A1">Bambu Lab A1</option>
                            <option value="A1_MINI">Bambu Lab A1 Mini</option>
                        </select>
                    </div>

                    <div class="maint-form-group">
                        <label for="printer-serial" data-i18n="maintenance_printer_serial">Serial Number *</label>
                        <input type="text" id="printer-serial" class="maint-form-input" data-i18n-placeholder="maintenance_printer_serial_placeholder" placeholder="e.g. 01S00A123456789" required>
                        <p class="maint-hint" data-i18n="maintenance_printer_serial_hint">
                            You can find the serial number on a sticker on the printer
                        </p>
                    </div>

                    <div class="maint-form-group" style="margin-top: 12px;">
                        <label class="maint-checkbox-label">
                            <input type="checkbox" id="import-history-checkbox">
                            <span data-i18n="maintenance_import_history">üìä Druckhistorie importieren</span>
                        </label>
                        <p class="maint-hint" style="margin-left: 26px;" data-i18n="maintenance_import_history_hint">
                            Importiert Druckzeit und Filamentverbrauch aus vergangenen Drucken
                        </p>
                    </div>
                </form>
            </div>
            <div class="maint-modal-footer">
                <button class="maint-btn" onclick="closeAddPrinterModal()" data-i18n="cancel">Abbrechen</button>
                <button class="maint-btn maint-btn--primary" onclick="addPrinter()">
                    ‚ûï <span data-i18n="maintenance_add_printer_button">Drucker hinzuf√ºgen</span>
                </button>
            </div>
        </div>
    </div>

    <script src="/static/auth-handler.js"></script>
    <script>
        // Global variables
        let currentLang = window.i18nManager ? window.i18nManager.getCurrentLang() : 'de';
        let currentPrinterId = 'default';
        let currentTasks = [];
        let currentTaskForComplete = null;
        let currentFilter = null; // null = show all, 'overdue', 'due', 'upcoming'

        // Filter Functions
        function toggleFilter(filterType) {
            // Toggle filter (click again to disable)
            if (currentFilter === filterType) {
                currentFilter = null;
            } else {
                currentFilter = filterType;
            }

            // Update visual state
            document.querySelectorAll('.maint-stat').forEach(card => card.classList.remove('active'));
            if (currentFilter) {
                document.getElementById(`filter-${currentFilter}`).classList.add('active');
            }

            // Re-render tasks with filter
            renderTasks();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Render sidebar using shared module
            if (window.tabBarManager) {
                window.tabBarManager.render();
            }

            // Apply translations (i18nManager already initialized)
            if (window.i18nManager) {
                window.i18nManager.applyTranslations();
            }

            loadPrinterSelector();
            translateIntervalDropdown();
        });

        // Translate interval dropdown labels
        function translateIntervalDropdown() {
            const dayGroup = document.getElementById('interval-group-days');
            const hourGroup = document.getElementById('interval-group-hours');
            const printGroup = document.getElementById('interval-group-prints');
            const rollGroup = document.getElementById('interval-group-rolls');

            if (dayGroup) dayGroup.label = getText('maintenance_interval_days', 'Tage').replace(' {value}', '');
            if (hourGroup) hourGroup.label = getText('maintenance_interval_hours', 'Druckstunden').replace(' {value}', '').replace('Alle ', '');
            if (printGroup) printGroup.label = getText('maintenance_interval_prints', 'Drucke').replace(' {value}', '').replace('Alle ', '');
            if (rollGroup) rollGroup.label = getText('maintenance_interval_rolls', 'Rollen').replace(' {value}', '').replace('Alle ', '');
        }

        async function loadPrinterSelector() {
            try {
                // Lade Drucker
                const printersRes = await apiCall('/api/maintenance/printers');
                if (printersRes.ok) {
                    const printers = await printersRes.json();

                    // Aktualisiere Header-Dropdown
                    const selector = document.getElementById('printer-selector');
                    selector.innerHTML = '';

                    // Filter out the 'default' fallback printer - it doesn't really exist in DB
                    const realPrinters = printers.filter(p => p.printer_id !== 'default' && p.serial);

                    if (realPrinters.length > 0) {
                        realPrinters.forEach(printer => {
                            const option = document.createElement('option');
                            option.value = printer.printer_id;
                            option.textContent = `${printer.model || 'Drucker'} - ${printer.name || printer.printer_id}`;
                            selector.appendChild(option);
                        });

                        currentPrinterId = realPrinters[0].printer_id;

                        // Pr√ºfe ob Wartungen initialisiert sind (nur wenn ECHTE Drucker vorhanden)
                        await checkAndInitialize();

                        // Lade Wartungen
                        await loadTasks();
                    } else {
                        // Keine ECHTEN Drucker vorhanden
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = getText('maintenance_no_printers', 'Keine Drucker vorhanden');
                        selector.appendChild(option);
                        console.log('No printers found - please add a printer first');
                    }
                }

            } catch (error) {
                console.error('Initialization error:', error);
                showError(getText('maintenance_error_loading', 'Fehler beim Laden der Wartungen'));
            }
        }

        async function switchPrinter() {
            const selector = document.getElementById('printer-selector');
            currentPrinterId = selector.value;

            if (currentPrinterId) {
                await loadTasks();
            }
        }

        async function checkAndInitialize() {
            try {
                const tasksRes = await apiCall(`/api/maintenance/tasks?printer_id=${currentPrinterId}`);
                if (tasksRes.ok) {
                    const tasks = await tasksRes.json();
                    
                    // Wenn keine Tasks, automatisch initialisieren
                    if (tasks.length === 0) {
                        const initRes = await apiCall(`/api/maintenance/printers/${currentPrinterId}/initialize`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: 'P1S', force: false })
                        });
                        
                        if (initRes.ok) {
                            const result = await initRes.json();
                            console.log(`Initialized ${result.created} maintenance tasks`);
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking initialization:', error);
            }
        }

        async function loadTasks() {
            try {
                const response = await apiCall(`/api/maintenance/tasks?printer_id=${currentPrinterId}`);
                if (!response.ok) throw new Error('Failed to load tasks');

                currentTasks = await response.json();
                renderTasks();
                updateStats();

            } catch (error) {
                console.error('Error loading tasks:', error);
                showError(getText('maintenance_error_loading', 'Fehler beim Laden der Wartungen'));
            }
        }

        function renderTasks() {
            const overdue = currentTasks.filter(t => t.status === 'overdue');
            const due = currentTasks.filter(t => t.status === 'due');
            const upcoming = currentTasks.filter(t => t.status === 'upcoming');

            // Apply filter if active
            const overdueSection = document.getElementById('section-overdue');
            const dueSection = document.getElementById('section-due');
            const upcomingSection = document.getElementById('section-upcoming');

            if (currentFilter) {
                // Filter is active - show only filtered section
                overdueSection.style.display = (currentFilter === 'overdue' && overdue.length > 0) ? 'block' : 'none';
                dueSection.style.display = (currentFilter === 'due' && due.length > 0) ? 'block' : 'none';
                upcomingSection.style.display = (currentFilter === 'upcoming') ? 'block' : 'none';
            } else {
                // No filter - show all sections with tasks
                overdueSection.style.display = overdue.length > 0 ? 'block' : 'none';
                dueSection.style.display = due.length > 0 ? 'block' : 'none';
                upcomingSection.style.display = 'block';
            }

            // Render overdue
            const overdueContainer = document.getElementById('tasks-overdue');
            if (overdue.length > 0) {
                overdueContainer.innerHTML = overdue.map(renderTaskItem).join('');
            }

            // Render due
            const dueContainer = document.getElementById('tasks-due');
            if (due.length > 0) {
                dueContainer.innerHTML = due.map(renderTaskItem).join('');
            }

            // Render upcoming
            const upcomingContainer = document.getElementById('tasks-upcoming');
            if (upcoming.length > 0) {
                upcomingContainer.innerHTML = upcoming.map(renderTaskItem).join('');
            } else {
                upcomingContainer.innerHTML = `<div class="maint-empty"><div class="maint-empty-icon">üìã</div><p>${getText('maintenance_no_planned', 'Keine geplanten Wartungen')}</p></div>`;
            }
        }

        function renderTaskItem(task) {
            const statusClass = task.status;

            // Fortschrittsanzeige f√ºr hours und filament_rolls
            let dueText = '';
            let progressHtml = '';

            if (task.progress_unit === 'hours' && task.progress_current !== undefined) {
                const current = task.progress_current;
                const target = task.progress_target;
                const remaining = task.progress_remaining;
                const percent = task.progress_percent || 0;

                if (task.status === 'overdue') {
                    dueText = getText('maintenance_overdue_hours', '√úberf√§llig! {current}/{target}h').replace('{current}', current).replace('{target}', target);
                } else {
                    dueText = getText('maintenance_hours_progress', '{current}/{target}h (noch {remaining}h)').replace('{current}', current).replace('{target}', target).replace('{remaining}', remaining);
                }

                const progressColorClass = percent >= 100 ? 'maint-progress-bar--red' : percent >= 90 ? 'maint-progress-bar--yellow' : 'maint-progress-bar--green';
                progressHtml = `
                    <div class="maint-progress-wrap">
                        <div class="maint-progress-bar ${progressColorClass}" style="width: ${Math.min(100, percent)}%;"></div>
                    </div>
                `;
            } else if (task.progress_unit === 'rolls' && task.progress_current !== undefined) {
                const current = task.progress_current;
                const target = task.progress_target;
                const remaining = task.progress_remaining;
                const percent = task.progress_percent || 0;

                if (task.status === 'overdue') {
                    dueText = getText('maintenance_overdue_rolls', '√úberf√§llig! {current}/{target} Rollen').replace('{current}', current.toFixed(1)).replace('{target}', target);
                } else {
                    dueText = getText('maintenance_rolls_progress', '{current}/{target} Rollen (noch {remaining})').replace('{current}', current.toFixed(1)).replace('{target}', target).replace('{remaining}', remaining.toFixed(1));
                }

                const progressColorClass = percent >= 100 ? 'maint-progress-bar--red' : percent >= 90 ? 'maint-progress-bar--yellow' : 'maint-progress-bar--green';
                progressHtml = `
                    <div class="maint-progress-wrap">
                        <div class="maint-progress-bar ${progressColorClass}" style="width: ${Math.min(100, percent)}%;"></div>
                    </div>
                `;
            } else {
                if (task.days_until_due < 0) {
                    dueText = getText('maintenance_overdue_since', '√úberf√§llig seit {days} Tag(en)').replace('{days}', Math.abs(task.days_until_due));
                } else {
                    dueText = getText('maintenance_due_in', 'F√§llig in {days} Tag(en)').replace('{days}', task.days_until_due);
                }
            }

            const locale = currentLang === 'de' ? 'de-DE' : currentLang === 'en' ? 'en-US' : currentLang === 'fr' ? 'fr-FR' : currentLang === 'es' ? 'es-ES' : currentLang === 'it' ? 'it-IT' : 'de-DE';
            const nextDueDate = new Date(task.next_due).toLocaleDateString(locale);
            const intervalText = getIntervalText(task.interval_type, task.interval_value);

            return `
                <div class="maint-task">
                    <div class="maint-task-indicator maint-task-indicator--${statusClass}"></div>
                    <div class="maint-task-content">
                        <div class="maint-task-header">
                            <span class="maint-task-name">${task.name}</span>
                            <span class="maint-badge maint-badge--${task.priority}">${getPriorityText(task.priority)}</span>
                        </div>
                        <div class="maint-task-desc">${task.description || ''}</div>
                        <div class="maint-task-meta">
                            <span class="maint-meta-item">üìÖ ${dueText}</span>
                            <span class="maint-meta-item">üîÑ ${intervalText}</span>
                            <span class="maint-meta-item">‚úÖ ${task.completed_count}x ${getText('maintenance_completed_times', 'durchgef√ºhrt')}</span>
                        </div>
                        ${progressHtml}
                    </div>
                    <div class="maint-task-actions">
                        <button class="maint-btn maint-btn--success maint-btn--small" onclick="showCompleteModal('${task.task_id}')">
                            ‚úì ${getText('maintenance_done', 'Erledigt')}
                        </button>
                        <button class="maint-btn maint-btn--small" onclick="showPostponeModal('${task.task_id}')">
                            ‚è∞ ${getText('maintenance_postpone', 'Verschieben')}
                        </button>
                        <button class="maint-btn maint-btn--small" onclick="editTask('${task.task_id}')">
                            ‚úèÔ∏è ${getText('maintenance_edit', 'Bearbeiten')}
                        </button>
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const overdue = currentTasks.filter(t => t.status === 'overdue').length;
            const due = currentTasks.filter(t => t.status === 'due').length;
            const upcoming = currentTasks.filter(t => t.status === 'upcoming').length;

            document.getElementById('stat-overdue').textContent = overdue;
            document.getElementById('stat-due').textContent = due;
            document.getElementById('stat-upcoming').textContent = upcoming;
        }

        async function showNewTaskModal() {
            document.getElementById('modal-title').textContent = getText('maintenance_new', '‚ûï Neue Wartung');
            document.getElementById('task-form').reset();
            document.getElementById('task-id').value = '';
            document.getElementById('delete-task-btn').style.display = 'none';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('task-first-due').value = today;

            // Load printers
            await loadPrinters();

            // Set default interval (30 days is already selected in HTML)
            document.getElementById('task-interval').value = 'days:30';

            document.getElementById('task-modal').style.display = 'flex';
        }

        async function loadPrinters() {
            try {
                const response = await apiCall('/api/maintenance/printers');
                const printers = await response.json();

                const select = document.getElementById('task-printer-id');
                select.innerHTML = '<option value="">Drucker w√§hlen...</option>';

                printers.forEach(printer => {
                    const option = document.createElement('option');
                    option.value = printer.printer_id;
                    option.textContent = `${printer.model || 'Drucker'} - ${printer.name || printer.printer_id}`;
                    if (printer.printer_id === currentPrinterId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading printers:', error);
            }
        }

        function closeTaskModal() {
            document.getElementById('task-modal').style.display = 'none';
        }

        async function saveTask() {
            const taskId = document.getElementById('task-id').value;
            const printerId = document.getElementById('task-printer-id').value || currentPrinterId;

            // Get interval type and value from dropdown
            const intervalSelect = document.getElementById('task-interval');
            const intervalValue = intervalSelect.value.split(':');
            const intervalType = intervalValue[0];
            const intervalNum = parseInt(intervalValue[1]);

            const taskData = {
                name: document.getElementById('task-name').value,
                description: document.getElementById('task-description').value,
                interval_type: intervalType,
                interval_value: intervalNum,
                priority: document.getElementById('task-priority').value,
                category: document.getElementById('task-category').value,
                notes: document.getElementById('task-notes').value
            };

            // Add first_due if set
            const firstDue = document.getElementById('task-first-due').value;
            if (firstDue) {
                taskData.first_due = firstDue;
            }

            try {
                let response;
                if (taskId) {
                    // Update
                    response = await apiCall(`/api/maintenance/tasks/${printerId}/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });
                } else {
                    // Create
                    response = await apiCall(`/api/maintenance/tasks/${printerId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(taskData)
                    });
                }

                if (response.ok) {
                    showSuccess(taskId ? getText('maintenance_updated', 'Wartung aktualisiert') : getText('maintenance_created', 'Wartung erstellt'));
                    closeTaskModal();
                    await loadTasks();
                } else {
                    throw new Error('Failed to save task');
                }
            } catch (error) {
                console.error('Error saving task:', error);
                showError(getText('maintenance_error_saving', 'Fehler beim Speichern'));
            }
        }

        async function editTask(taskId) {
            const task = currentTasks.find(t => t.task_id === taskId);
            if (!task) return;

            document.getElementById('modal-title').textContent = getText('maintenance_edit_task', '‚úèÔ∏è Wartung bearbeiten');
            document.getElementById('task-id').value = task.task_id;

            // Load printers first
            await loadPrinters();
            document.getElementById('task-printer-id').value = task.printer_id;

            document.getElementById('task-name').value = task.name;
            document.getElementById('task-description').value = task.description || '';
            document.getElementById('task-priority').value = task.priority;
            document.getElementById('task-category').value = task.category;
            document.getElementById('task-notes').value = task.notes || '';

            // Set interval dropdown
            const intervalType = task.interval_type;
            const intervalValue = task.interval_value;
            const intervalKey = `${intervalType}:${intervalValue}`;

            const intervalSelect = document.getElementById('task-interval');
            const option = intervalSelect.querySelector(`option[value="${intervalKey}"]`);
            if (option) {
                intervalSelect.value = intervalKey;
            } else {
                // If exact match not found, select first option of same type
                const firstOption = intervalSelect.querySelector(`option[value^="${intervalType}:"]`);
                if (firstOption) {
                    intervalSelect.value = firstOption.value;
                }
            }

            // Set first due if available
            if (task.next_due) {
                const dueDate = new Date(task.next_due).toISOString().split('T')[0];
                document.getElementById('task-first-due').value = dueDate;
            }

            document.getElementById('delete-task-btn').style.display = 'inline-flex';
            document.getElementById('task-modal').style.display = 'flex';
        }

        async function deleteTask() {
            const taskId = document.getElementById('task-id').value;
            const printerId = document.getElementById('task-printer-id').value || currentPrinterId;
            const taskName = document.getElementById('task-name').value;

            if (!taskId) return;

            // Confirmation dialog
            const confirmMessage = getText('maintenance_delete_confirm',
                'M√∂chten Sie diese Wartung wirklich l√∂schen?\n\n"{name}"\n\nDiese Aktion kann nicht r√ºckg√§ngig gemacht werden!')
                .replace('{name}', taskName);

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await apiCall(`/api/maintenance/tasks/${printerId}/${taskId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showSuccess(getText('maintenance_deleted', 'Wartung gel√∂scht'));
                    closeTaskModal();
                    await loadTasks();
                } else {
                    throw new Error('Failed to delete task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                showError(getText('maintenance_error_saving', 'Fehler beim L√∂schen'));
            }
        }

        function showCompleteModal(taskId) {
            const task = currentTasks.find(t => t.task_id === taskId);
            if (!task) return;

            currentTaskForComplete = task;

            document.getElementById('complete-task-name').textContent = task.name;
            document.getElementById('complete-notes').value = '';

            // Render checklist if available
            const checklistContainer = document.getElementById('complete-checklist-container');
            if (task.checklist && task.checklist.length > 0) {
                checklistContainer.innerHTML = `
                    <div class="maint-form-group">
                        <label>Checkliste</label>
                        <ul class="maint-checklist">
                            ${task.checklist.map((item, idx) => `
                                <li>
                                    <input type="checkbox" id="check-${idx}">
                                    <label for="check-${idx}">${item}</label>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else {
                checklistContainer.innerHTML = '';
            }

            document.getElementById('complete-modal').style.display = 'flex';
        }

        function closeCompleteModal() {
            document.getElementById('complete-modal').style.display = 'none';
            currentTaskForComplete = null;
        }

        async function completeTask() {
            if (!currentTaskForComplete) return;

            const notes = document.getElementById('complete-notes').value;

            try {
                const response = await apiCall(
                    `/api/maintenance/tasks/${currentTaskForComplete.printer_id}/${currentTaskForComplete.task_id}/complete`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes })
                    }
                );

                if (response.ok) {
                    showSuccess('Wartung als erledigt markiert');
                    closeCompleteModal();
                    await loadTasks();
                } else {
                    throw new Error('Failed to complete task');
                }
            } catch (error) {
                console.error('Error completing task:', error);
                showError('Fehler beim Abschlie√üen');
            }
        }

        // Postpone Modal Functions
        let currentTaskForPostpone = null;

        function showPostponeModal(taskId) {
            const task = currentTasks.find(t => t.task_id === taskId);
            if (!task) return;

            currentTaskForPostpone = task;
            document.getElementById('postpone-task-name').textContent = task.name;
            document.getElementById('postpone-custom-days').value = '';
            document.getElementById('postpone-modal').style.display = 'flex';
        }

        function closePostponeModal() {
            document.getElementById('postpone-modal').style.display = 'none';
            currentTaskForPostpone = null;
        }

        async function postponeTask(days) {
            if (!currentTaskForPostpone) return;

            try {
                const response = await apiCall(
                    `/api/maintenance/tasks/${currentTaskForPostpone.printer_id}/${currentTaskForPostpone.task_id}/postpone`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ days })
                    }
                );

                if (response.ok) {
                    showSuccess(getText('maintenance_postponed', `Wartung um ${days} Tage verschoben`));
                    closePostponeModal();
                    await loadTasks();
                } else {
                    throw new Error('Failed to postpone task');
                }
            } catch (error) {
                console.error('Error postponing task:', error);
                showError(getText('maintenance_error_postpone', 'Fehler beim Verschieben'));
            }
        }

        async function postponeTaskCustom() {
            const days = parseInt(document.getElementById('postpone-custom-days').value);
            if (!days || days < 1) {
                showError(getText('maintenance_error_invalid_days', 'Bitte g√ºltige Anzahl Tage eingeben'));
                return;
            }
            await postponeTask(days);
        }

        // PDF Export Function
        async function exportPDF() {
            try {
                showSuccess(getText('maintenance_generating_pdf', 'PDF wird generiert...'));

                // Lese Checkbox-Wert
                const includePrints = document.getElementById('include-prints-checkbox').checked;

                // Sammle PDF-√úbersetzungen aus den Sprachdateien
                const pdfTranslations = {
                    title: getText('pdf_title', 'Wartungsprotokoll'),
                    printer: getText('pdf_printer', 'Drucker:'),
                    model: getText('pdf_model', 'Modell:'),
                    serial: getText('pdf_serial', 'Seriennummer:'),
                    total_hours: getText('pdf_total_hours', 'Druckstunden gesamt:'),
                    total_prints: getText('pdf_total_prints', 'Drucke gesamt:'),
                    filament_used: getText('pdf_filament_used', 'Filament verbraucht:'),
                    created: getText('pdf_created', 'Erstellt:'),
                    current_tasks: getText('pdf_current_tasks', 'Aktuelle Wartungsaufgaben'),
                    overdue: getText('pdf_overdue', '√úberf√§llig'),
                    due_soon: getText('pdf_due_soon', 'F√§llig (n√§chste 3 Tage)'),
                    due_since: getText('pdf_due_since', 'F√§llig seit'),
                    due_in: getText('pdf_due_in', 'F√§llig in'),
                    days: getText('pdf_days', 'Tagen'),
                    day_s: getText('pdf_day_s', 'Tag(en)'),
                    history: getText('pdf_history', 'Wartungshistorie'),
                    history_date: getText('pdf_history_date', 'Datum'),
                    history_task: getText('pdf_history_task', 'Wartung'),
                    history_notes: getText('pdf_history_notes', 'Notizen'),
                    no_history: getText('pdf_no_history', 'Keine Wartungshistorie vorhanden.'),
                    // NEU: Print History √úbersetzungen
                    print_history: getText('pdf_print_history', 'Druckhistorie'),
                    print_summary: getText('pdf_print_summary', 'Zusammenfassung Drucke'),
                    since_last_maintenance: getText('pdf_since_last_maintenance', 'Seit letzter Wartung'),
                    in_period: getText('pdf_in_period', 'Im Zeitraum'),
                    successful: getText('pdf_successful', 'Erfolgreich:'),
                    failed: getText('pdf_failed', 'Fehlgeschlagen:'),
                    cancelled: getText('pdf_cancelled', 'Abgebrochen:'),
                    total_duration: getText('pdf_total_duration', 'Gesamtdauer:'),
                    hours: getText('pdf_hours', 'Stunden'),
                    avg_duration: getText('pdf_avg_duration', '√ò Dauer:'),
                    minutes: getText('pdf_minutes', 'Minuten'),
                    total_filament: getText('pdf_total_filament', 'Filament gesamt:'),
                    total_power: getText('pdf_total_power', 'Stromverbrauch:'),
                    total_cost: getText('pdf_total_cost', 'Kosten gesamt:'),
                    print_details: getText('pdf_print_details', 'Letzte Drucke (Details)'),
                    print_date: getText('pdf_print_date', 'Datum'),
                    print_filename: getText('pdf_print_filename', 'Dateiname'),
                    print_duration: getText('pdf_print_duration', 'Dauer'),
                    print_status: getText('pdf_print_status', 'Status'),
                    print_filament: getText('pdf_print_filament', 'Filament'),
                    no_prints: getText('pdf_no_prints', 'Keine Drucke im Zeitraum vorhanden.')
                };

                const response = await apiCall('/api/maintenance/export/pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        printer_id: currentPrinterId,
                        include_prints: includePrints,  // NEU: Parameter hinzugef√ºgt
                        translations: pdfTranslations
                    })
                });

                if (response.ok) {
                    // Download PDF
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `wartungsplan_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showSuccess(getText('maintenance_pdf_downloaded', 'PDF wurde heruntergeladen'));
                } else {
                    throw new Error('Failed to generate PDF');
                }
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showError(getText('maintenance_error_pdf', 'Fehler beim Generieren des PDFs'));
            }
        }

        function showInitModal() {
            document.getElementById('init-modal').style.display = 'flex';
        }

        function closeInitModal() {
            document.getElementById('init-modal').style.display = 'none';
        }

        async function showAddPrinterModal() {
            document.getElementById('add-printer-form').reset();

            // Versuche Seriennummer aus API Config zu holen
            try {
                const response = await apiCall('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    if (config.mqtt && config.mqtt.bambu_serial) {
                        document.getElementById('printer-serial').value = config.mqtt.bambu_serial;
                    }
                }
            } catch (e) {
                console.log('Could not load printer serial from config');
            }

            document.getElementById('add-printer-modal').style.display = 'flex';
        }

        function closeAddPrinterModal() {
            document.getElementById('add-printer-modal').style.display = 'none';
            // Reset form
            document.getElementById('add-printer-form').reset();
            document.getElementById('import-history-checkbox').checked = false;
        }

        async function addPrinter() {
            const name = document.getElementById('printer-name').value;
            const model = document.getElementById('printer-model').value;
            const serial = document.getElementById('printer-serial').value;
            const importHistory = document.getElementById('import-history-checkbox').checked;

            if (!name || !serial) {
                showError(getText('maintenance_error_name_serial_required', 'Name and serial number are required'));
                return;
            }

            try {
                const response = await apiCall('/api/maintenance/printers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, model, serial, import_history: importHistory })
                });

                if (response.ok) {
                    const result = await response.json();

                    // Build success message
                    let successMsg = getText('maintenance_printer_added', 'Printer added successfully');

                    // Add import info if history was imported
                    if (importHistory && result.import_result && result.import_result.imported) {
                        const stats = result.import_result;
                        successMsg += `\nüìä ${getText('maintenance_import_success', 'Imported')}: ${stats.total_prints} ${getText('prints', 'Drucke')}, ${stats.total_hours}h, ${stats.total_filament_grams}g`;
                    }

                    showSuccess(successMsg);
                    closeAddPrinterModal();
                    // Reload printer selector and select new printer
                    await loadPrinterSelector();
                    await loadTasks();
                } else {
                    const error = await response.json();
                    if (response.status === 409) {
                        showError(getText('maintenance_error_printer_exists', 'A printer with this serial number already exists'));
                    } else {
                        showError(error.error || getText('maintenance_error_add_printer', 'Error adding printer'));
                    }
                }
            } catch (error) {
                console.error('Error adding printer:', error);
                showError(getText('maintenance_error_add_printer', 'Error adding printer'));
            }
        }

        async function initializeMaintenancePlan() {
            const model = document.getElementById('init-model').value;
            const force = document.getElementById('init-force').checked;

            if (force && !confirm(getText('maintenance_init_force_confirm', 'Achtung: Alle bestehenden Wartungen werden gel√∂scht!\n\nM√∂chten Sie wirklich fortfahren?'))) {
                return;
            }

            try {
                const response = await apiCall(`/api/maintenance/printers/${currentPrinterId}/initialize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model, force, language: currentLang })
                });

                if (response.ok) {
                    const result = await response.json();
                    let message = getText('maintenance_init_success', 'Wartungsplan erfolgreich geladen: {count} Aufgaben').replace('{count}', result.tasks_created || result.created || 0);

                    // Info √ºber initialisierte Baselines
                    if (result.baselines_initialized > 0) {
                        message += `\nüìä ${result.baselines_initialized} Stunden/Rollen-Tasks initialisiert`;
                    }

                    showSuccess(message);
                    closeInitModal();
                    await loadTasks();
                } else {
                    throw new Error('Failed to initialize maintenance');
                }
            } catch (error) {
                console.error('Error initializing maintenance:', error);
                showError(getText('maintenance_error_saving', 'Fehler beim Laden des Wartungsplans'));
            }
        }

        function getIntervalText(type, value) {
            const intervalTexts = {
                'days': getText('maintenance_interval_days', 'Alle {value} Tage').replace('{value}', value),
                'hours': getText('maintenance_interval_hours', 'Alle {value} Druckstunden').replace('{value}', value),
                'prints': getText('maintenance_interval_prints', 'Alle {value} Drucke').replace('{value}', value),
                'filament_rolls': getText('maintenance_interval_filament', 'Alle {value} Rollen').replace('{value}', value)
            };
            return intervalTexts[type] || `${getText('maintenance_every', 'Alle')} ${value}`;
        }

        function getPriorityText(priority) {
            const priorityMap = {
                'low': getText('maintenance_priority_low', 'Niedrig'),
                'medium': getText('maintenance_priority_medium', 'Mittel'),
                'high': getText('maintenance_priority_high', 'Hoch'),
                'critical': getText('maintenance_priority_critical', 'Kritisch')
            };
            return priorityMap[priority] || priority;
        }

        function showSuccess(message) {
            if (typeof window.showToast === 'function') {
                window.showToast({ title: 'Erfolg', message: message, type: 'success' });
            } else {
                const alertEl = document.getElementById('alert-success');
                alertEl.textContent = message;
                alertEl.classList.add('show');
                setTimeout(() => alertEl.classList.remove('show'), 4000);
            }
        }

        function showError(message) {
            if (typeof window.showToast === 'function') {
                window.showToast({ title: 'Fehler', message: message, type: 'error' });
            } else {
                const alertEl = document.getElementById('alert-error');
                alertEl.textContent = message;
                alertEl.classList.add('show');
                setTimeout(() => alertEl.classList.remove('show'), 4000);
            }
        }
    </script>
</body>
</html>
