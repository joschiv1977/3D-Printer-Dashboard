<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Slicer - 3D Printer Dashboard</title>

    <!-- Sprachdateien laden -->
    <script src="/static/lang/de.js"></script>
    <script src="/static/lang/en.js"></script>
    <script src="/static/lang/fr.js"></script>
    <script src="/static/lang/es.js"></script>
    <script src="/static/lang/it.js"></script>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="/static/css/shared-styles.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container { max-width: 100%; margin: 0; padding: 8px; }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-nav { display: flex; gap: 10px; flex-wrap: wrap; }
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }
        .content { background: var(--bg-card); padding: 20px; border-radius: 0 0 8px 8px; }
        .section {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--bg-section);
            border-radius: 8px;
        }
        .section h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .form-group { margin-bottom: 15px; }
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }
        input[type="file"],
        input[type="number"],
        select {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid var(--input-border);
            border-radius: 5px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 14px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            display: inline-block;
            transition: all 0.2s;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-success {
            background: #4caf50;
        }
        .btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        body.dark-mode .alert-success { background: #1a3622; color: #4caf50; border: 1px solid #4caf50; }
        body.dark-mode .alert-error { background: #3a1a1a; color: #f44336; border: 1px solid #f44336; }
        body.dark-mode .alert-info { background: #1a2733; color: #3498db; border: 1px solid #3498db; }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: var(--input-bg);
            transition: all 0.2s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: var(--bg-section);
        }
        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        .file-info {
            background: var(--info-bg);
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-section);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 13px;
            font-weight: 600;
        }

        /* Grid Layout f√ºr Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        .back-btn {
            display: none !important;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Slicing Status Block */
        .slicing-status-container {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            display: none;
        }
        .slicing-status-container.active {
            display: block;
        }
        .slicing-status-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .slicing-status-icon {
            font-size: 48px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .slicing-status-text h2 {
            margin: 0 0 5px 0;
            color: #667eea;
            font-size: 22px;
        }
        .slicing-status-text p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .slicing-steps {
            margin-top: 20px;
        }
        .slicing-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-section);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .slicing-step.active {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
        }
        .slicing-step.completed {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4caf50;
        }
        .slicing-step-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }
        .slicing-step-text {
            flex: 1;
            font-size: 15px;
            font-weight: 500;
        }
        .slicing-step-status {
            font-size: 20px;
        }

        .slicing-progress-bar {
            width: 100%;
            height: 40px;
            background: var(--bg-section);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .slicing-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Sidebar wird von sidebar-manager.js generiert -->

    <div class="container">
        <div class="header" style="display: flex; align-items: center; gap: 15px;">
            <button class="menu-toggle" id="menu-toggle-header" onclick="window.sidebarManager.toggle()">‚ò∞</button>
            <h1 id="header-title" style="margin: 0; flex: 1;">üî™ Slicer</h1>
        </div>
        <div class="content">
            <div id="successAlert" class="alert alert-success"></div>
            <div id="errorAlert" class="alert alert-error"></div>
            <div id="infoAlert" class="alert alert-info"></div>

            <!-- Slicing Status Block (Prominent, shown during slicing) -->
            <div class="slicing-status-container" id="slicingStatus">
                <div class="slicing-status-header">
                    <div class="slicing-status-icon">‚öôÔ∏è</div>
                    <div class="slicing-status-text">
                        <h2 id="slicingStatusTitle">Datei wird verarbeitet...</h2>
                        <p id="slicingStatusSubtitle">Bitte warten Sie, dies kann bis zu 2 Minuten dauern</p>
                    </div>
                </div>

                <div class="slicing-steps">
                    <div class="slicing-step" id="step-upload">
                        <div class="slicing-step-icon">üì§</div>
                        <div class="slicing-step-text">Datei hochladen</div>
                        <div class="slicing-step-status">‚è≥</div>
                    </div>
                    <div class="slicing-step" id="step-slicing">
                        <div class="slicing-step-icon">üî™</div>
                        <div class="slicing-step-text">STL wird gesliced</div>
                        <div class="slicing-step-status">‚è≥</div>
                    </div>
                    <div class="slicing-step" id="step-thumbnail">
                        <div class="slicing-step-icon">üé®</div>
                        <div class="slicing-step-text">Thumbnail wird generiert</div>
                        <div class="slicing-step-status">‚è≥</div>
                    </div>
                    <div class="slicing-step" id="step-saving">
                        <div class="slicing-step-icon">üíæ</div>
                        <div class="slicing-step-text">3MF wird gespeichert</div>
                        <div class="slicing-step-status">‚è≥</div>
                    </div>
                </div>

                <div class="slicing-progress-bar">
                    <div class="slicing-progress-fill" id="slicingProgressFill">0%</div>
                </div>
            </div>

            <!-- STL Upload Section -->
            <div class="section" id="uploadSection">
                <h2>üìÅ STL-Datei hochladen</h2>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('stlFile').click()">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì§</div>
                    <p style="margin: 0; font-size: 16px; color: var(--text-primary);">
                        Klicken oder STL-Datei hierher ziehen
                    </p>
                    <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-secondary);">
                        Unterst√ºtzte Formate: .stl
                    </p>
                </div>
                <input type="file" id="stlFile" accept=".stl" style="display: none;" onchange="handleFileSelect(event)">
                <div class="file-info" id="fileInfo">
                    <strong>Ausgew√§hlte Datei:</strong> <span id="fileName">-</span><br>
                    <strong>Gr√∂√üe:</strong> <span id="fileSize">-</span>
                </div>
            </div>

            <!-- Slicer Settings -->
            <div class="section" id="settingsSection">
                <h2>‚öôÔ∏è Slicer-Einstellungen</h2>
                <div class="settings-grid">
                    <div class="form-group">
                        <label for="printerSelect">üñ®Ô∏è Drucker</label>
                        <select id="printerSelect">
                            <option value="">Lade Profile...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nozzleSize">üîß D√ºsendurchmesser (mm)</label>
                        <select id="nozzleSize">
                            <option value="0.4">0.4 mm (Standard)</option>
                            <option value="0.2">0.2 mm</option>
                            <option value="0.6">0.6 mm</option>
                            <option value="0.8">0.8 mm</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bedType">üõèÔ∏è Druckbett-Typ</label>
                        <select id="bedType">
                            <option value="Cool Plate">Cool Plate (Standard)</option>
                            <option value="Textured Cool Plate">Textured Cool Plate</option>
                            <option value="Textured PEI Plate">Textured PEI Plate</option>
                            <option value="Smoothie High Temp Plate">Smoothie High Temp Plate</option>
                            <option value="Engineering Plate">Engineering Plate</option>
                            <option value="Smoothie Cool Plate">Smoothie Cool Plate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="processSelect">üìê Layer Height / Qualit√§t</label>
                        <select id="processSelect">
                            <option value="">Lade Profile...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filamentSelect">üßµ Filament-Typ</label>
                        <select id="filamentSelect">
                            <option value="">Lade Profile...</option>
                        </select>
                    </div>
                </div>
                <div class="alert alert-info" style="margin-top: 15px; display: block;">
                    <strong>‚ÑπÔ∏è Hinweis:</strong> Alle Slice-Einstellungen (Layer Height, Infill, Support, etc.) werden aus dem Process-Profil geladen.
                </div>
            </div>

            <!-- Slice Button & Progress -->
            <div class="section" id="actionSection">
                <button class="btn btn-success" id="sliceBtn" onclick="startSlicing()" disabled>
                    üî™ STL Slicen & auf SD-Karte speichern
                </button>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Handler -->
    <script src="/static/auth-handler.js"></script>

    <!-- Shared Modules -->
    <script src="/static/js/modules/theme-manager.js"></script>
    <script src="/static/js/modules/i18n-manager.js"></script>
    <script src="/static/js/modules/sidebar-manager.js"></script>

    <!-- Page-specific JavaScript -->
    <script>
        let selectedFile = null;
        let allFilaments = []; // Cache f√ºr alle Filamente
        let allProcesses = []; // Cache f√ºr alle Process Profiles

        // Helper function to get translation (uses global i18nManager)
        function t(key, replacements = {}) {
            if (!window.i18nManager) return key;
            let text = window.i18nManager.getText(key) || key;
            // Replace placeholders like {nozzleSize}, {printer}, etc.
            Object.keys(replacements).forEach(placeholder => {
                text = text.replace(new RegExp(`\\{${placeholder}\\}`, 'g'), replacements[placeholder]);
            });
            return text;
        }

        // Apply translations to the page
        function applyTranslations() {
            document.getElementById('page-title').textContent = t('slicer_page_title') || 'Slicer - 3D Printer Dashboard';
            document.getElementById('header-title').textContent = t('slicer_title') || 'üî™ Slicer';

            // Slicing Status
            document.getElementById('slicingStatusTitle').textContent = t('slicer_processing_file') || 'Datei wird verarbeitet...';
            document.getElementById('slicingStatusSubtitle').textContent = t('slicer_please_wait') || 'Bitte warten Sie, dies kann bis zu 2 Minuten dauern';

            // Slicing Steps
            document.querySelector('#step-upload .slicing-step-text').textContent = t('slicer_step_upload') || 'Datei hochladen';
            document.querySelector('#step-slicing .slicing-step-text').textContent = t('slicer_step_slicing') || 'STL wird gesliced';
            document.querySelector('#step-thumbnail .slicing-step-text').textContent = t('slicer_step_thumbnail') || 'Thumbnail wird generiert';
            document.querySelector('#step-saving .slicing-step-text').textContent = t('slicer_step_saving') || '3MF wird gespeichert';

            // Upload Section
            document.querySelectorAll('.section h2')[0].textContent = t('slicer_upload_title') || 'üìÅ STL-Datei hochladen';
            const uploadAreaP = document.querySelectorAll('.upload-area p');
            if (uploadAreaP[0]) uploadAreaP[0].textContent = t('slicer_click_or_drag') || 'Klicken oder STL-Datei hierher ziehen';
            if (uploadAreaP[1]) uploadAreaP[1].textContent = t('slicer_supported_formats') || 'Unterst√ºtzte Formate: .stl';

            // Settings Section
            document.querySelectorAll('.section h2')[1].textContent = t('slicer_settings_title') || '‚öôÔ∏è Slicer-Einstellungen';
            document.querySelector('label[for="printerSelect"]').innerHTML = t('slicer_printer_label') || 'üñ®Ô∏è Drucker';
            document.querySelector('label[for="nozzleSize"]').innerHTML = t('slicer_nozzle_size_label') || 'üîß D√ºsendurchmesser (mm)';
            document.querySelector('label[for="bedType"]').innerHTML = t('slicer_bed_type_label') || 'üõèÔ∏è Druckbett-Typ';
            document.querySelector('label[for="processSelect"]').innerHTML = t('slicer_layer_height_label') || 'üìê Layer Height / Qualit√§t';
            document.querySelector('label[for="filamentSelect"]').innerHTML = t('slicer_filament_type_label') || 'üßµ Filament-Typ';

            // Button
            document.getElementById('sliceBtn').innerHTML = t('slicer_btn_slice') || 'üî™ STL Slicen & auf SD-Karte speichern';
        }

        // ========== LOCALSTORAGE PERSISTENCE ==========
        const STORAGE_KEY = 'slicerSettings';

        function saveSlicerSettings() {
            const settings = {
                printer: document.getElementById('printerSelect').value,
                nozzleSize: document.getElementById('nozzleSize').value,
                bedType: document.getElementById('bedType').value,
                processProfile: document.getElementById('processSelect').value,
                filament: document.getElementById('filamentSelect').value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSlicerSettings() {
            const savedSettings = localStorage.getItem(STORAGE_KEY);
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);

                    // Restore settings after profiles are loaded
                    if (settings.nozzleSize) {
                        document.getElementById('nozzleSize').value = settings.nozzleSize;
                    }
                    if (settings.bedType) {
                        document.getElementById('bedType').value = settings.bedType;
                    }

                    // Store for later restoration
                    window.savedSlicerSettings = settings;
                } catch (e) {
                    console.error('Error loading slicer settings:', e);
                }
            }
        }

        function restoreSelectionsAfterLoad() {
            if (window.savedSlicerSettings) {
                const settings = window.savedSlicerSettings;

                if (settings.printer) {
                    const printerSelect = document.getElementById('printerSelect');
                    if (printerSelect.querySelector(`option[value="${settings.printer}"]`)) {
                        printerSelect.value = settings.printer;
                        updateProcessList(); // Update process list based on printer
                    }
                }

                if (settings.processProfile) {
                    setTimeout(() => {
                        const processSelect = document.getElementById('processSelect');
                        if (processSelect.querySelector(`option[value="${settings.processProfile}"]`)) {
                            processSelect.value = settings.processProfile;
                        }
                        validateSliceButton();
                    }, 100);
                }

                if (settings.filament) {
                    setTimeout(() => {
                        const filamentSelect = document.getElementById('filamentSelect');
                        if (filamentSelect.querySelector(`option[value="${settings.filament}"]`)) {
                            filamentSelect.value = settings.filament;
                        }
                        validateSliceButton();
                    }, 100);
                }
            }
        }

        // Drag & Drop
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.stl')) {
                showError(t('slicer_error_select_stl') || 'Bitte w√§hle eine STL-Datei');
                return;
            }
            selectedFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';

            // Update file info labels with translations
            const fileInfoStrong = document.querySelectorAll('.file-info strong');
            if (fileInfoStrong[0]) fileInfoStrong[0].textContent = t('slicer_selected_file') || 'Ausgew√§hlte Datei:';
            if (fileInfoStrong[1]) fileInfoStrong[1].textContent = t('slicer_file_size') || 'Gr√∂√üe:';

            validateSliceButton();
        }

        // Validate that all required fields are filled before enabling slice button
        function validateSliceButton() {
            const hasFile = selectedFile !== null;
            const hasPrinter = document.getElementById('printerSelect').value !== '';
            const hasProcess = document.getElementById('processSelect').value !== '';
            const hasFilament = document.getElementById('filamentSelect').value !== '';

            const allValid = hasFile && hasPrinter && hasProcess && hasFilament;
            document.getElementById('sliceBtn').disabled = !allValid;

            // Show helpful message if user tries to slice without all fields
            if (!allValid && hasFile) {
                if (!hasPrinter) {
                    document.getElementById('printerSelect').style.borderColor = '#f44336';
                } else {
                    document.getElementById('printerSelect').style.borderColor = '';
                }

                if (!hasProcess) {
                    document.getElementById('processSelect').style.borderColor = '#f44336';
                } else {
                    document.getElementById('processSelect').style.borderColor = '';
                }

                if (!hasFilament) {
                    document.getElementById('filamentSelect').style.borderColor = '#f44336';
                } else {
                    document.getElementById('filamentSelect').style.borderColor = '';
                }
            } else {
                // Reset borders when valid
                document.getElementById('printerSelect').style.borderColor = '';
                document.getElementById('processSelect').style.borderColor = '';
                document.getElementById('filamentSelect').style.borderColor = '';
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Load Profiles
        async function loadProfiles() {
            try {
                const response = await apiCall('/api/slicer/profiles');
                if (response.ok) {
                    const data = await response.json();

                    // Populate printers
                    const printerSelect = document.getElementById('printerSelect');
                    printerSelect.innerHTML = `<option value="">${t('slicer_select_printer') || 'Drucker w√§hlen...'}</option>`;
                    data.printers.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        printerSelect.appendChild(option);
                    });

                    // Cache all filaments and process profiles
                    allFilaments = data.filaments;
                    allProcesses = data.processes;

                    // Initial population (with default nozzle size)
                    updateFilamentList();
                    updateProcessList();

                    // Restore saved settings after profiles are loaded
                    restoreSelectionsAfterLoad();
                } else {
                    showError(t('slicer_error_loading_profiles') || 'Fehler beim Laden der Profile');
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                showError(t('slicer_error_network') || 'Netzwerkfehler');
            }
        }

        // Filter and update filament list based on nozzle size
        function updateFilamentList() {
            const nozzleSize = document.getElementById('nozzleSize').value;
            const filamentSelect = document.getElementById('filamentSelect');
            const currentSelection = filamentSelect.value; // Remember current selection

            filamentSelect.innerHTML = `<option value="">${t('slicer_select_filament') || 'Filament w√§hlen...'}</option>`;

            // Filter filaments based on nozzle size
            const filteredFilaments = allFilaments.filter(f => {
                const name = f.name.toLowerCase();
                const id = f.id.toLowerCase();

                // Check if profile contains nozzle size specification
                const has02 = name.includes('0.2 nozzle') || id.includes('0.2 nozzle');
                const has04 = name.includes('0.4 nozzle') || id.includes('0.4 nozzle');
                const has06 = name.includes('0.6 nozzle') || id.includes('0.6 nozzle');
                const has08 = name.includes('0.8 nozzle') || id.includes('0.8 nozzle');

                // If no nozzle size specified, show for all nozzles (universal profile)
                const hasNoNozzleSize = !has02 && !has04 && !has06 && !has08;

                // Show profile if it matches current nozzle size or is universal
                if (nozzleSize === '0.2') return has02 || hasNoNozzleSize;
                if (nozzleSize === '0.4') return has04 || hasNoNozzleSize;
                if (nozzleSize === '0.6') return has06 || hasNoNozzleSize;
                if (nozzleSize === '0.8') return has08 || hasNoNozzleSize;

                return hasNoNozzleSize; // Default: only show universal profiles
            });

            // Populate filtered filaments
            filteredFilaments.forEach(f => {
                const option = document.createElement('option');
                option.value = f.id;
                option.textContent = f.name;
                filamentSelect.appendChild(option);
            });

            // Restore selection if still available
            if (currentSelection && filteredFilaments.find(f => f.id === currentSelection)) {
                filamentSelect.value = currentSelection;
            }

            // Show info message if no filaments available for this nozzle size
            if (filteredFilaments.length === 0) {
                showInfo(t('slicer_no_filament_profiles', { nozzleSize }) || `Keine Filament-Profile f√ºr ${nozzleSize}mm D√ºse gefunden`);
            }

            // Re-validate after updating list
            validateSliceButton();
        }

        // Filter and update process list based on printer and nozzle size
        function updateProcessList() {
            const printer = document.getElementById('printerSelect').value;
            const nozzleSize = document.getElementById('nozzleSize').value;
            const processSelect = document.getElementById('processSelect');
            const currentSelection = processSelect.value; // Remember current selection

            processSelect.innerHTML = `<option value="">${t('slicer_select_layer_height') || 'Layer Height w√§hlen...'}</option>`;

            if (!printer) {
                // No printer selected yet - show all processes
                validateSliceButton();
                return;
            }

            // Build the expected machine profile name (e.g., "Bambu Lab P1S 0.6 nozzle")
            const machineProfileName = `${printer} ${nozzleSize} nozzle`;

            // Filter process profiles based on compatible_printers
            const filteredProcesses = allProcesses.filter(p => {
                const compatiblePrinters = p.compatible_printers || [];
                return compatiblePrinters.includes(machineProfileName);
            });

            // Populate filtered process profiles
            filteredProcesses.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                processSelect.appendChild(option);
            });

            // Restore selection if still available
            if (currentSelection && filteredProcesses.find(p => p.id === currentSelection)) {
                processSelect.value = currentSelection;
            }

            // Show info message if no process profiles available
            if (filteredProcesses.length === 0) {
                showInfo(t('slicer_no_process_profiles', { printer, nozzleSize }) || `Keine Process-Profile f√ºr ${printer} ${nozzleSize}mm gefunden`);
            }

            // Re-validate after updating list
            validateSliceButton();
        }

        // Helper functions for slicing status
        function showSlicingStatus() {
            document.getElementById('slicingStatus').classList.add('active');
            // Scroll to status block
            document.getElementById('slicingStatus').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function hideSlicingStatus() {
            document.getElementById('slicingStatus').classList.remove('active');
        }

        function updateSlicingStep(stepId, status) {
            const step = document.getElementById(stepId);
            const statusIcon = step.querySelector('.slicing-step-status');

            // Remove previous states
            step.classList.remove('active', 'completed');

            if (status === 'active') {
                step.classList.add('active');
                statusIcon.textContent = '‚è≥';
            } else if (status === 'completed') {
                step.classList.add('completed');
                statusIcon.textContent = '‚úÖ';
            } else {
                statusIcon.textContent = '‚è≥';
            }
        }

        function updateSlicingProgress(percent, title, subtitle) {
            const fill = document.getElementById('slicingProgressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';

            if (title) {
                document.getElementById('slicingStatusTitle').textContent = title;
            }
            if (subtitle) {
                document.getElementById('slicingStatusSubtitle').textContent = subtitle;
            }
        }

        function resetSlicingStatus() {
            // Reset all steps
            updateSlicingStep('step-upload', 'pending');
            updateSlicingStep('step-slicing', 'pending');
            updateSlicingStep('step-thumbnail', 'pending');
            updateSlicingStep('step-saving', 'pending');
            updateSlicingProgress(0, t('slicer_processing_file') || 'Datei wird verarbeitet...', t('slicer_please_wait') || 'Bitte warten...');
        }

        // Hide upload UI elements during processing
        function hideUploadUI() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('settingsSection').style.display = 'none';
            document.getElementById('actionSection').style.display = 'none';
        }

        // Show upload UI elements after processing
        function showUploadUI() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('settingsSection').style.display = 'block';
            document.getElementById('actionSection').style.display = 'block';
        }

        // Start Slicing with improved progress tracking
        async function startSlicing() {
            if (!selectedFile) {
                showError(t('slicer_error_select_file_first') || 'Bitte w√§hle zuerst eine Datei');
                return;
            }

            const printer = document.getElementById('printerSelect').value;
            const filament = document.getElementById('filamentSelect').value;
            const nozzleSize = document.getElementById('nozzleSize').value;
            const bedType = document.getElementById('bedType').value;
            const processProfile = document.getElementById('processSelect').value;

            if (!printer) {
                showError(t('slicer_error_select_printer') || 'Bitte w√§hle einen Drucker');
                return;
            }
            if (!processProfile) {
                showError(t('slicer_error_select_layer_height') || 'Bitte w√§hle eine Layer Height');
                return;
            }
            if (!filament) {
                showError(t('slicer_error_select_filament') || 'Bitte w√§hle ein Filament');
                return;
            }

            // Show prominent status block and disable button
            document.getElementById('sliceBtn').disabled = true;
            resetSlicingStatus();
            showSlicingStatus();
            hideUploadUI();

            // Hide old progress bar
            document.getElementById('progressBar').style.display = 'none';

            try {
                // Step 1: Upload (0-10%)
                updateSlicingStep('step-upload', 'active');
                updateSlicingProgress(5, t('slicer_uploading_file') || 'Datei wird hochgeladen...', t('slicer_file_transferring') || 'Datei wird √ºbertragen');

                const formData = new FormData();
                formData.append('stl_file', selectedFile);
                formData.append('printer', printer);
                formData.append('filament', filament);
                formData.append('nozzle_size', nozzleSize);
                formData.append('bed_type', bedType);
                formData.append('process_profile', processProfile);

                updateSlicingProgress(10, t('slicer_upload_complete') || 'Upload abgeschlossen', t('slicer_preparing_slice') || 'Slicing wird vorbereitet');
                updateSlicingStep('step-upload', 'completed');

                // Step 2: Slicing + Thumbnail (10-90%)
                updateSlicingStep('step-slicing', 'active');
                updateSlicingProgress(15, t('slicer_slicing_stl') || 'STL wird gesliced', t('slicer_orcaslicer_processing') || 'OrcaSlicer verarbeitet');

                // Simulate progress during entire backend process (slicing + thumbnail)
                let progressSimulationTime = 0;
                const slicingInterval = setInterval(() => {
                    progressSimulationTime += 1500; // 1.5 seconds per tick
                    const currentProgress = parseFloat(document.getElementById('slicingProgressFill').style.width) || 15;

                    if (currentProgress < 90) {
                        const newProgress = currentProgress + 2; // +2% every 1.5 seconds

                        // Switch from slicing to thumbnail step at 40%
                        if (currentProgress >= 40 && !document.getElementById('step-thumbnail').classList.contains('active')) {
                            updateSlicingStep('step-slicing', 'completed');
                            updateSlicingStep('step-thumbnail', 'active');
                            updateSlicingProgress(newProgress, t('slicer_generating_thumbnail') || 'Thumbnail wird generiert', t('slicer_creating_preview') || 'Vorschau wird erstellt');
                        } else if (currentProgress < 40) {
                            updateSlicingProgress(newProgress, t('slicer_slicing_stl') || 'STL wird gesliced', t('slicer_orcaslicer_processing') || 'OrcaSlicer verarbeitet');
                        } else {
                            updateSlicingProgress(newProgress, t('slicer_generating_thumbnail') || 'Thumbnail wird generiert', t('slicer_creating_preview') || 'Vorschau wird erstellt');
                        }
                    }
                }, 1500); // Update every 1.5 seconds

                // Send request to backend
                const response = await apiCall('/api/slicer/slice', {
                    method: 'POST',
                    body: formData
                });

                // Stop simulated progress
                clearInterval(slicingInterval);

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        // Backend is done - ensure we're at least at 90%
                        const currentProgress = parseFloat(document.getElementById('slicingProgressFill').style.width) || 90;
                        if (currentProgress < 90) {
                            updateSlicingProgress(90, t('slicer_thumbnail_complete') || 'Thumbnail fertig', t('slicer_thumbnail_created') || 'Thumbnail erstellt');
                        }

                        // Mark thumbnail as completed if not already
                        if (document.getElementById('step-thumbnail').classList.contains('active')) {
                            updateSlicingStep('step-thumbnail', 'completed');
                        }

                        // Ensure slicing is marked completed
                        if (!document.getElementById('step-slicing').classList.contains('completed')) {
                            updateSlicingStep('step-slicing', 'completed');
                        }

                        // Step 5: Saving (90-100%)
                        updateSlicingStep('step-saving', 'active');
                        updateSlicingProgress(95, t('slicer_saving_file') || 'Datei wird gespeichert', t('slicer_writing_to_sd') || 'Schreibe auf SD-Karte');

                        await new Promise(resolve => setTimeout(resolve, 300));
                        updateSlicingProgress(100, t('slicer_complete') || 'Fertig!', t('slicer_file_created', { filename: result.filename }) || `Datei erstellt: ${result.filename}`);
                        updateSlicingStep('step-saving', 'completed');

                        // Show success message
                        showSuccess(t('slicer_success_message', { filename: result.filename, size: formatFileSize(result.size) }) || `‚úÖ Erfolgreich! Datei: ${result.filename} (${formatFileSize(result.size)})`);

                        // Reset form after 3 seconds
                        setTimeout(() => {
                            hideSlicingStatus();
                            showUploadUI();
                            resetForm();
                        }, 3000);
                    } else {
                        throw new Error(result.error || t('slicer_error_failed') || 'Slicing fehlgeschlagen');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error || t('slicer_error_failed') || 'Slicing fehlgeschlagen');
                }
            } catch (error) {
                console.error('Slicing error:', error);
                showError(t('slicer_error_slicing', { error: error.message }) || `‚ùå Fehler: ${error.message}`);
                hideSlicingStatus();
                showUploadUI();
                document.getElementById('sliceBtn').disabled = false;
            }
        }

        function updateProgress(percent, message) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = percent + '%';
            progressFill.textContent = message || (percent + '%');
        }

        function resetForm() {
            selectedFile = null;
            document.getElementById('stlFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('progressBar').style.display = 'none';
            validateSliceButton(); // Will disable button since no file selected
        }

        function showAlert(id, message) {
            const alert = document.getElementById(id);
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 5000);
        }
        const showSuccess = (msg) => showAlert('successAlert', msg);
        const showError = (msg) => showAlert('errorAlert', msg);
        const showInfo = (msg) => showAlert('infoAlert', msg);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Render Sidebar
            if (window.sidebarManager) {
                window.sidebarManager.render();
            }

            // Apply translations
            applyTranslations();

            // Load saved settings
            loadSlicerSettings();

            // Load profiles from server
            loadProfiles();

            // Add event listener for nozzle size change
            document.getElementById('nozzleSize').addEventListener('change', () => {
                updateFilamentList();
                updateProcessList();
                validateSliceButton();
                saveSlicerSettings();
            });

            // Add event listeners for printer selection
            document.getElementById('printerSelect').addEventListener('change', () => {
                updateProcessList();
                validateSliceButton();
                saveSlicerSettings();
            });

            // Add event listeners for process and filament selection
            document.getElementById('processSelect').addEventListener('change', () => {
                validateSliceButton();
                saveSlicerSettings();
            });

            document.getElementById('filamentSelect').addEventListener('change', () => {
                validateSliceButton();
                saveSlicerSettings();
            });

            // Add event listener for bed type
            document.getElementById('bedType').addEventListener('change', () => {
                saveSlicerSettings();
            });
        });
    </script>
</body>
</html>
